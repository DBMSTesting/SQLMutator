{
    "sql": "INSERT INTO FUNCTION s3('https://s3..._{_partition_id}.csv.gz', 'CSV', auto, 'gzip') PARTITION BY formatDateTime(subtractHours(now(), 1), '%Y-%m-%d_%H:00') SELECT control_plane_id, name AS backup_id, max(size) OVER wndw AS backup_size, minIf(timestamp, state = 'done') OVER wndw AS created, maxIf(timestamp, state = 'deleted_by_user') OVER wndw AS deleted FROM (SELECT control_plane_id, name, size, timestamp, state FROM default.backup_events WHERE state IN ('done', 'deleted_by_user') WINDOW wndw AS (PARTITION BY name) LIMIT 1 BY name) WHERE (created < toStartOfHour(now())) AND ((deleted = 0) OR ((deleted >= subtractHours(toStartOfHour(now()), 1)) AND (deleted < toStartOfHour(now()))))",
    "Affected Elements": "SELECT clauses, WINDOW function, LIMIT clause",
    "Root Cause Analysis": "The query fails due to the change in how the ClickHouse engine handles column references in nested SELECT statements starting from version 22.13.1, leading to the 'Not found column state in block' error."
}