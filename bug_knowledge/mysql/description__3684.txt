{
    "sql": "DROP TABLE IF EXISTS test_entry_card_events; CREATE TABLE test_entry_card_events (card_id INT NOT NULL, event_time DATETIME NOT NULL, event_type ENUM('entry','exit') NOT NULL, PRIMARY KEY (card_id, event_time, event_type)); INSERT INTO test_entry_card_events (card_id, event_time, event_type) VALUES (4403, '2012-12-04 12:10:00', 'entry'), (4403, '2012-12-05 12:37:00', 'entry'), (4403, '2012-12-05 19:55:00', 'exit'), (4403, '2012-12-06 12:34:00', 'entry'), (4403, '2012-12-06 18:49:00', 'exit'), (4403, '2012-12-20 13:02:00', 'entry'), (4403, '2012-12-20 18:03:00', 'exit'), (4403, '2012-12-21 10:41:00', 'entry'), (4403, '2012-12-21 17:03:00', 'exit'); SELECT a.card_id, a.event_time, MIN(b.event_time), TIMEDIFF(MIN(b.event_time), a.event_time) AS d FROM test_entry_card_events a JOIN test_entry_card_events b ON a.card_id = b.card_id AND a.event_type = 'entry' AND b.event_type = 'exit' AND b.event_time > a.event_time GROUP BY a.card_id, a.event_time ORDER BY a.card_id, a.event_time;",
    "Affected Elements": "GROUP BY, JOIN, MIN(), TIMEDIFF()",
    "Root Cause Analysis": "The unexpected results are caused by changes in how MySQL 5.1 and above handle GROUP BY with multiple columns and aggregate functions in the presence of primary keys."
}