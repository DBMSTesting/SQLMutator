ID: 71791
Title: Data race in clickhouse-client on the progress bar when using FROM INFILE
Description:
1. Create a file:
```
ch -q "SELECT number FROM numbers(1e9)" > numbers.parquet
```

2. Run this under TSan:
```
milovidov@milovidov-pc:~$ ~/work/ClickHouse/build_tsan/programs/clickhouse 
ClickHouse local version 24.11.1.1.

:) INSERT INTO FUNCTION null() FROM INFILE 'numbers.parquet'

INSERT INTO FUNCTION null() FROM INFILE 'numbers.parquet'

Query id: 7456c366-0b96-499e-8326-c14de3cd24d5

â†’ Progress: 4.58 million rows, 4.66 MB (47.91 million rows/s., 4==================
WARNING: ThreadSanitizer: data race (pid=2766064)progress table.
  Read of size 8 at 0x7230000045c8 by thread T3 (mutexes: write M0):
    #0 DB::WriteBuffer::write(char) <null> (clickhouse+0x766f98b) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #1 DB::writeChar(char, DB::WriteBuffer&) build_tsan/./src/IO/WriteHelpers.h:63:9 (clickhouse+0x1afeb936) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #2 void DB::writeText<char>(char, DB::WriteBuffer&) build_tsan/./src/IO/WriteHelpers.h:1105:9 (clickhouse+0x1afeb936)
    #3 DB::WriteBuffer& DB::operator<<<char>(DB::WriteBuffer&, char const&) build_tsan/./src/IO/Operators.h:46:70 (clickhouse+0x1afeb936)
    #4 DB::ProgressIndication::writeProgress(DB::WriteBufferFromFileDescriptor&) build_tsan/./src/Common/ProgressIndication.cpp:142:13 (clickhouse+0x1afeb936)
    #5 DB::ClientBase::onProgress(DB::Progress const&) build_tsan/./src/Client/ClientBase.cpp:1321:29 (clickhouse+0x1afe3966) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #6 DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0::operator()(DB::Progress const&) const build_tsan/./src/Client/ClientBase.cpp:1819:73 (clickhouse+0x1afe3966)
    #7 decltype(std::declval<DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0&>()(std::declval<DB::Progress const&>())) std::__1::__invoke[abi:v15007]<DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0&, DB::Progress const&>(DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0&, DB::Progress const&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/invoke.h:394:23 (clickhouse+0x1afe3966)
    #8 void std::__1::__invoke_void_return_wrapper<void, true>::__call<DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0&, DB::Progress const&>(DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0&, DB::Progress const&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/invoke.h:479:9 (clickhouse+0x1afe3966)
    #9 std::__1::__function::__default_alloc_func<DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0, void (DB::Progress const&)>::operator()[abi:v15007](DB::Progress const&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:235:12 (clickhouse+0x1afe3966)
    #10 void std::__1::__function::__policy_invoker<void (DB::Progress const&)>::__call_impl<std::__1::__function::__default_alloc_func<DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool)::$_0, void (DB::Progress const&)>>(std::__1::__function::__policy_storage const*, DB::Progress const&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:716:16 (clickhouse+0x1afe3966)
    #11 std::__1::__function::__policy_func<void (DB::Progress const&)>::operator()[abi:v15007](DB::Progress const&) const build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:848:16 (clickhouse+0x1770320d) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #12 std::__1::function<void (DB::Progress const&)>::operator()(DB::Progress const&) const build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:1197:12 (clickhouse+0x1770320d)
    #13 DB::ReadProgressCallback::onProgress(unsigned long, unsigned long, std::__1::list<DB::StorageLimits, std::__1::allocator<DB::StorageLimits>> const&) build_tsan/./src/QueryPipeline/ReadProgressCallback.cpp:81:9 (clickhouse+0x1770320d)
    #14 DB::executeJob(DB::ExecutingGraph::Node*, DB::ReadProgressCallback*) build_tsan/./src/Processors/Executors/ExecutionThreadContext.cpp:62:46 (clickhouse+0x1b2aef7c) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #15 DB::ExecutionThreadContext::executeTask() build_tsan/./src/Processors/Executors/ExecutionThreadContext.cpp:96:9 (clickhouse+0x1b2aef7c)
    #16 DB::PipelineExecutor::executeStepImpl(unsigned long, std::__1::atomic<bool>*) build_tsan/./src/Processors/Executors/PipelineExecutor.cpp:289:26 (clickhouse+0x1b29efd4) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #17 DB::PipelineExecutor::executeSingleThread(unsigned long) build_tsan/./src/Processors/Executors/PipelineExecutor.cpp:255:5 (clickhouse+0x1b29e32b) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #18 DB::PipelineExecutor::executeImpl(unsigned long, bool) build_tsan/./src/Processors/Executors/PipelineExecutor.cpp:441:9 (clickhouse+0x1b29e32b)
    #19 DB::PipelineExecutor::execute(unsigned long, bool) build_tsan/./src/Processors/Executors/PipelineExecutor.cpp:126:9 (clickhouse+0x1b29e009) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #20 DB::threadFunction(DB::PullingAsyncPipelineExecutor::Data&, std::__1::shared_ptr<DB::ThreadGroup>, unsigned long, bool) build_tsan/./src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:83:24 (clickhouse+0x1b2b3afa) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #21 DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0::operator()() const build_tsan/./src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:109:13 (clickhouse+0x1b2b3afa)
    #22 decltype(std::declval<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&>()()) std::__1::__invoke[abi:v15007]<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/invoke.h:394:23 (clickhouse+0x1b2b3afa)
    #23 decltype(auto) std::__1::__apply_tuple_impl[abi:v15007]<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&, std::__1::__tuple_indices<...>) build_tsan/./contrib/llvm-project/libcxx/include/tuple:1789:1 (clickhouse+0x1b2b3afa)
    #24 decltype(auto) std::__1::apply[abi:v15007]<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&) build_tsan/./contrib/llvm-project/libcxx/include/tuple:1798:1 (clickhouse+0x1b2b3afa)
    #25 ThreadFromGlobalPoolImpl<true, true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()::operator()() build_tsan/./src/Common/ThreadPool.h:311:13 (clickhouse+0x1b2b3afa)
    #26 decltype(std::declval<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>()()) std::__1::__invoke[abi:v15007]<ThreadFromGlobalPoolImpl<true, true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/invoke.h:394:23 (clickhouse+0x1b2b3afa)
    #27 void std::__1::__invoke_void_return_wrapper<void, true>::__call<ThreadFromGlobalPoolImpl<true, true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&>(ThreadFromGlobalPoolImpl<true, true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/invoke.h:479:9 (clickhouse+0x1b2b3afa)
    #28 std::__1::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<true, true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'(), void ()>::operator()[abi:v15007]() build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:235:12 (clickhouse+0x1b2b3afa)
    #29 void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<true, true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'(), void ()>>(std::__1::__function::__policy_storage const*) build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:716:16 (clickhouse+0x1b2b3afa)
    #30 std::__1::__function::__policy_func<void ()>::operator()[abi:v15007]() const build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:848:16 (clickhouse+0xfed003d) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #31 std::__1::function<void ()>::operator()() const build_tsan/./contrib/llvm-project/libcxx/include/__functional/function.h:1197:12 (clickhouse+0xfed003d)
    #32 ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::worker() build_tsan/./src/Common/ThreadPool.cpp:785:17 (clickhouse+0xfed003d)
    #33 decltype(*std::declval<ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*>().*std::declval<void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*)()>()()) std::__1::__invoke[abi:v15007]<void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*)(), ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*, void>(void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*&&)(), ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*&&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/invoke.h:359:23 (clickhouse+0xfed7fdb) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #34 void std::__1::__thread_execute[abi:v15007]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*)(), ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*, 2ul>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*)(), ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*>&, std::__1::__tuple_indices<2ul>) build_tsan/./contrib/llvm-project/libcxx/include/thread:284:5 (clickhouse+0xfed7fdb)
    #35 void* std::__1::__thread_proxy[abi:v15007]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*)(), ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*>>(void*) build_tsan/./contrib/llvm-project/libcxx/include/thread:295:5 (clickhouse+0xfed7fdb)

  Previous write of size 8 at 0x7230000045c8 by main thread (mutexes: write M1):
    #0 DB::WriteBuffer::next() build_tsan/./src/IO/WriteBuffer.h:67:13 (clickhouse+0x1b0657dc) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #1 DB::ProgressTable::writeTable(DB::WriteBufferFromFileDescriptor&, bool, bool) build_tsan/./src/Client/ProgressTable.cpp (clickhouse+0x1b0657dc)
    #2 DB::ClientBase::onProfileEvents(DB::Block&) build_tsan/./src/Client/ClientBase.cpp:1421:28 (clickhouse+0x1afd5f17) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #3 DB::ClientBase::receiveAndProcessPacket(std::__1::shared_ptr<DB::IAST>, bool) build_tsan/./src/Client/ClientBase.cpp:1295:13 (clickhouse+0x1afd4434) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #4 DB::ClientBase::receiveLogsAndProfileEvents(std::__1::shared_ptr<DB::IAST>) build_tsan/./src/Client/ClientBase.cpp:1888:9 (clickhouse+0x1afdc3c9) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #5 DB::ClientBase::sendDataFromPipe(DB::Pipe&&, std::__1::shared_ptr<DB::IAST>, bool) build_tsan/./src/Client/ClientBase.cpp:1833:9 (clickhouse+0x1afdb823) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #6 DB::ClientBase::sendData(DB::Block&, DB::ColumnsDescription const&, std::__1::shared_ptr<DB::IAST>) build_tsan/./src/Client/ClientBase.cpp:1738:13 (clickhouse+0x1afda4c4) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #7 DB::ClientBase::processInsertQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::shared_ptr<DB::IAST>) build_tsan/./src/Client/ClientBase.cpp:1631:9 (clickhouse+0x1afd8abd) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #8 DB::ClientBase::processParsedSingleQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::shared_ptr<DB::IAST>, std::__1::optional<bool>, bool) build_tsan/./src/Client/ClientBase.cpp:2071:13 (clickhouse+0x1afd0ab3) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #9 DB::ClientBase::executeMultiQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) build_tsan/./src/Client/ClientBase.cpp:2407:21 (clickhouse+0x1afdd791) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #10 DB::ClientBase::processQueryText(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) build_tsan/./src/Client/ClientBase.cpp:2552:12 (clickhouse+0x1afde999) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #11 DB::ClientBase::runInteractive() build_tsan/./src/Client/ClientBase.cpp:2785:18 (clickhouse+0x1afe1b6a) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #12 DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp (clickhouse+0x100f0449) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #13 non-virtual thunk to DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp (clickhouse+0x100f0de0) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #14 Poco::Util::Application::run() build_tsan/./base/poco/Util/src/Application.cpp:315:8 (clickhouse+0x1f1b6c5e) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #15 mainEntryClickHouseLocal(int, char**) build_tsan/./programs/local/LocalServer.cpp:1034:20 (clickhouse+0x100fd66d) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #16 main build_tsan/./programs/main.cpp:246:21 (clickhouse+0x7649998) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)

  Location is heap block of size 184 at 0x7230000045c0 allocated by main thread:
    #0 operator new(unsigned long) <null> (clickhouse+0x76478a7) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #1 std::__1::__unique_if<DB::WriteBufferFromFile>::__unique_single std::__1::make_unique[abi:v15007]<DB::WriteBufferFromFile, char const* const&, unsigned long const&>(char const* const&, unsigned long const&) build_tsan/./contrib/llvm-project/libcxx/include/__memory/unique_ptr.h:714:28 (clickhouse+0x1afe4cca) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #2 DB::ClientBase::initTTYBuffer(DB::ProgressOption, DB::ProgressOption) build_tsan/./src/Client/ClientBase.cpp:850:27 (clickhouse+0x1afcea81) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #3 DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp:563:5 (clickhouse+0x100f00ec) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #4 non-virtual thunk to DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp (clickhouse+0x100f0de0) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #5 Poco::Util::Application::run() build_tsan/./base/poco/Util/src/Application.cpp:315:8 (clickhouse+0x1f1b6c5e) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #6 mainEntryClickHouseLocal(int, char**) build_tsan/./programs/local/LocalServer.cpp:1034:20 (clickhouse+0x100fd66d) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #7 main build_tsan/./programs/main.cpp:246:21 (clickhouse+0x7649998) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)

  Mutex M0 (0x7fff1bc7add8) created at:
    #0 pthread_mutex_lock <null> (clickhouse+0x75ccaca) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #1 std::__1::__libcpp_mutex_lock[abi:v15007](pthread_mutex_t*) build_tsan/./contrib/llvm-project/libcxx/include/__threading_support:304:10 (clickhouse+0x222f3199) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #2 std::__1::mutex::lock() build_tsan/./contrib/llvm-project/libcxx/src/mutex.cpp:38:14 (clickhouse+0x222f3199)
    #3 std::__1::lock_guard<std::__1::mutex>::lock_guard[abi:v15007](std::__1::mutex&) build_tsan/./contrib/llvm-project/libcxx/include/__mutex_base:94:27 (clickhouse+0x1afea62b) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #4 DB::ProgressIndication::resetProgress() build_tsan/./src/Common/ProgressIndication.cpp:38:25 (clickhouse+0x1afea62b)
    #5 DB::ClientBase::processParsedSingleQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::shared_ptr<DB::IAST>, std::__1::optional<bool>, bool) build_tsan/./src/Client/ClientBase.cpp:2018:25 (clickhouse+0x1afd05af) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #6 DB::ClientBase::executeMultiQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) build_tsan/./src/Client/ClientBase.cpp:2407:21 (clickhouse+0x1afdd791) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #7 DB::ClientBase::processQueryText(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) build_tsan/./src/Client/ClientBase.cpp:2552:12 (clickhouse+0x1afde999) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #8 DB::ClientBase::runInteractive() build_tsan/./src/Client/ClientBase.cpp:2785:18 (clickhouse+0x1afe1b6a) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #9 DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp (clickhouse+0x100f0449) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #10 non-virtual thunk to DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp (clickhouse+0x100f0de0) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #11 Poco::Util::Application::run() build_tsan/./base/poco/Util/src/Application.cpp:315:8 (clickhouse+0x1f1b6c5e) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #12 mainEntryClickHouseLocal(int, char**) build_tsan/./programs/local/LocalServer.cpp:1034:20 (clickhouse+0x100fd66d) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #13 main build_tsan/./programs/main.cpp:246:21 (clickhouse+0x7649998) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)

  Mutex M1 (0x7fff1bc7ae28) created at:
    #0 pthread_mutex_lock <null> (clickhouse+0x75ccaca) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #1 std::__1::__libcpp_mutex_lock[abi:v15007](pthread_mutex_t*) build_tsan/./contrib/llvm-project/libcxx/include/__threading_support:304:10 (clickhouse+0x222f3199) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #2 std::__1::mutex::lock() build_tsan/./contrib/llvm-project/libcxx/src/mutex.cpp:38:14 (clickhouse+0x222f3199)
    #3 std::__1::lock_guard<std::__1::mutex>::lock_guard[abi:v15007](std::__1::mutex&) build_tsan/./contrib/llvm-project/libcxx/include/__mutex_base:94:27 (clickhouse+0x1b067602) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #4 DB::ProgressTable::resetTable() build_tsan/./src/Client/ProgressTable.cpp:371:21 (clickhouse+0x1b067602)
    #5 DB::ClientBase::processParsedSingleQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::shared_ptr<DB::IAST>, std::__1::optional<bool>, bool) build_tsan/./src/Client/ClientBase.cpp:2019:20 (clickhouse+0x1afd05c2) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #6 DB::ClientBase::executeMultiQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) build_tsan/./src/Client/ClientBase.cpp:2407:21 (clickhouse+0x1afdd791) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #7 DB::ClientBase::processQueryText(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) build_tsan/./src/Client/ClientBase.cpp:2552:12 (clickhouse+0x1afde999) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #8 DB::ClientBase::runInteractive() build_tsan/./src/Client/ClientBase.cpp:2785:18 (clickhouse+0x1afe1b6a) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #9 DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp (clickhouse+0x100f0449) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #10 non-virtual thunk to DB::LocalServer::main(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&) build_tsan/./programs/local/LocalServer.cpp (clickhouse+0x100f0de0) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #11 Poco::Util::Application::run() build_tsan/./base/poco/Util/src/Application.cpp:315:8 (clickhouse+0x1f1b6c5e) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #12 mainEntryClickHouseLocal(int, char**) build_tsan/./programs/local/LocalServer.cpp:1034:20 (clickhouse+0x100fd66d) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #13 main build_tsan/./programs/main.cpp:246:21 (clickhouse+0x7649998) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)

  Thread T3 'QueryPullPipeEx' (tid=2766068, running) created by thread T2 at:
    #0 pthread_create <null> (clickhouse+0x75cafcb) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #1 std::__1::__libcpp_thread_create[abi:v15007](unsigned long*, void* (*)(void*), void*) build_tsan/./contrib/llvm-project/libcxx/include/__threading_support:376:10 (clickhouse+0xfed0735) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #2 std::__1::thread::thread<void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*)(), ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*, void>(void (ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::*&&)(), ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool*&&) build_tsan/./contrib/llvm-project/libcxx/include/thread:311:16 (clickhouse+0xfed0735)
    #3 ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool::ThreadFromThreadPool(ThreadPoolImpl<std::__1::thread>&) build_tsan/./src/Common/ThreadPool.cpp:598:14 (clickhouse+0xfecf415) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #4 std::__1::__unique_if<ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool>::__unique_single std::__1::make_unique[abi:v15007]<ThreadPoolImpl<std::__1::thread>::ThreadFromThreadPool, ThreadPoolImpl<std::__1::thread>&>(ThreadPoolImpl<std::__1::thread>&) build_tsan/./contrib/llvm-project/libcxx/include/__memory/unique_ptr.h:714:32 (clickhouse+0xfed0f71) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #5 void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool) build_tsan/./src/Common/ThreadPool.cpp:284:30 (clickhouse+0xfed0f71)
    #6 ThreadPoolImpl<std::__1::thread>::scheduleOrThrow(std::__1::function<void ()>, Priority, unsigned long, bool) build_tsan/./src/Common/ThreadPool.cpp:490:5 (clickhouse+0xfed1c76) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #7 ThreadFromGlobalPoolImpl<true, true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&) build_tsan/./src/Common/ThreadPool.h:278:38 (clickhouse+0x1b2b25c6) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #8 DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long) build_tsan/./src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:112:24 (clickhouse+0x1b2b25c6)
    #9 DB::PullingAsyncPipelineExecutor::pull(DB::Block&, unsigned long) build_tsan/./src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:138:10 (clickhouse+0x1b2b2ba6) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #10 DB::LocalConnection::pullBlock(DB::Block&) build_tsan/./src/Client/LocalConnection.cpp:350:33 (clickhouse+0x1b058d17) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #11 DB::LocalConnection::pollImpl() build_tsan/./src/Client/LocalConnection.cpp:524:22 (clickhouse+0x1b058d17)
    #12 DB::LocalConnection::poll(unsigned long) build_tsan/./src/Client/LocalConnection.cpp:401:20 (clickhouse+0x1b057c77) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #13 DB::LocalConnection::receivePacket() build_tsan/./src/Client/LocalConnection.cpp:552:9 (clickhouse+0x1b059098) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #14 DB::Suggest::fetch(DB::IServerConnection&, DB::ConnectionTimeouts const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, DB::ClientInfo const&) build_tsan/./src/Client/Suggest.cpp:169:36 (clickhouse+0x1b06efe0) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #15 void DB::Suggest::load<DB::LocalConnection>(std::__1::shared_ptr<DB::Context const>, DB::ConnectionParameters const&, int, bool)::'lambda'()::operator()() const build_tsan/./src/Client/Suggest.cpp:102:17 (clickhouse+0x1b0721b1) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #16 decltype(std::declval<void DB::Suggest::load<DB::LocalConnection>(std::__1::shared_ptr<DB::Context const>, DB::ConnectionParameters const&, int, bool)::'lambda'()>()()) std::__1::__invoke[abi:v15007]<void DB::Suggest::load<DB::LocalConnection>(std::__1::shared_ptr<DB::Context const>, DB::ConnectionParameters const&, int, bool)::'lambda'()>(void DB::Suggest::load<DB::LocalConnection>(std::__1::shared_ptr<DB::Context const>, DB::ConnectionParameters const&, int, bool)::'lambda'()&&) build_tsan/./contrib/llvm-project/libcxx/include/__functional/invoke.h:394:23 (clickhouse+0x1b071e78) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2)
    #17 void std::__1::__thread_execute[abi:v15007]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void DB::Suggest::load<DB::LocalConnection>(std::__1::shared_ptr<DB::Context const>, DB::ConnectionParameters const&, int, bool)::'lambda'()>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void DB::Suggest::load<DB::LocalConnection>(std::__1::shared_ptr<DB::Context const>, DB::ConnectionParameters const&, int, bool)::'lambda'()>&, std::__1::__tuple_indices<...>) build_tsan/./contrib/llvm-project/libcxx/include/thread:284:5 (clickhouse+0x1b071e78)
    #18 void* std::__1::__thread_proxy[abi:v15007]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void DB::Suggest::load<DB::LocalConnection>(std::__1::shared_ptr<DB::Context const>, DB::ConnectionParameters const&, int, bool)::'lambda'()>>(void*) build_tsan/./contrib/llvm-project/libcxx/include/thread:295:5 (clickhouse+0x1b071e78)

SUMMARY: ThreadSanitizer: data race (/home/milovidov/work/ClickHouse/build_tsan/programs/clickhouse+0x766f98b) (BuildId: 7577d2b6e2a4153af4abca8d04ee1ce447432ff2) in DB::WriteBuffer::write(char)
==================
```