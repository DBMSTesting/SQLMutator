ID: 19578
Title: Crash in RewriteSumIfFunctionVisitor
Description:
Msan, ubsan

```sql
select sumIf(NULL, (number % 2) > -9223372036854775808) from numbers(1)
```

also

```sql
SELECT today() - 65535, sumIf(1., (number % -1) > 1048575) FROM numbers(1048576)
```

```
2021.01.25 17:29:53.575204 [ 24642 ] {} <Fatal> BaseDaemon: ########################################
2021.01.25 17:29:53.575571 [ 24642 ] {} <Fatal> BaseDaemon: (version 21.2.1.1, build id: 9C64DB91C2BE13300F2AFFD7B68C3A6AB09A76F3) (from thread 23739) (query_id: c39c8f25-b58c-4645-9e44-27778f336bb4) Received signal Aborted (6)
2021.01.25 17:29:53.575904 [ 24642 ] {} <Fatal> BaseDaemon: 
2021.01.25 17:29:53.576211 [ 24642 ] {} <Fatal> BaseDaemon: Stack trace: 0x7fda60babf47 0x7fda60bad8b1 0x15d9f4c7 0x15d9f74d 0x15e02f9b 0x15e0391d 0x15e019fd 0x2ecff3d7 0x2ecff011 0x2ece0a64 0x2ece0f16 0x2ece0a26 0x2ece0f16 0x2ece0a26 0x2ecce782 0x2eccc366 0x2eca0020 0x2e0fb95f 0x2e0f7373 0x2e0f4a7d 0x2e811926 0x2e80a113 0x2e80910c 0x2dfc3bcb 0x2dfc08fa 0x2edc63c0 0x2edc3029 0x306fb7d6
2021.01.25 17:29:53.580185 [ 24642 ] {} <Fatal> BaseDaemon: 4. /build/glibc-2ORdQG/glibc-2.27/signal/../sysdeps/unix/sysv/linux/raise.c:51: raise @ 0x3ef47 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so
2021.01.25 17:29:53.581498 [ 24642 ] {} <Fatal> BaseDaemon: 5. /build/glibc-2ORdQG/glibc-2.27/stdlib/abort.c:81: abort @ 0x408b1 in /usr/lib/debug/lib/x86_64-linux-gnu/libc-2.27.so
2021.01.25 17:29:53.591865 [ 24642 ] {} <Fatal> BaseDaemon: 6. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Common/Exception.cpp:46: DB::handle_error_code(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x15d9f4c7 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:53.593325 [ 24642 ] {} <Fatal> BaseDaemon: 7. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Common/Exception.cpp:57: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, bool) @ 0x15d9f74d in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:53.599166 [ 24642 ] {} <Fatal> BaseDaemon: 8. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Common/Exception.h:38: DB::Exception::Exception<char const*, char const*>(int, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, char const*&&, char const*&&) @ 0x15e02f9b in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:53.601412 [ 24642 ] {} <Fatal> BaseDaemon: 9. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Core/Field.h:790: unsigned long& DB::Field::get<unsigned long>() @ 0x15e0391d in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:53.603510 [ 24642 ] {} <Fatal> BaseDaemon: 10. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Core/Field.h:408: unsigned long const& DB::Field::get<unsigned long>() const @ 0x15e019fd in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:53.759382 [ 24642 ] {} <Fatal> BaseDaemon: 11. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/RewriteSumIfFunctionVisitor.cpp:44: DB::RewriteSumIfFunctionMatcher::visit(DB::ASTFunction const&, std::__1::shared_ptr<DB::IAST>&, DB::RewriteSumIfFunctionMatcher::Data&) @ 0x2ecff3d7 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:53.880742 [ 24642 ] {} <Fatal> BaseDaemon: 12. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/RewriteSumIfFunctionVisitor.cpp:14: DB::RewriteSumIfFunctionMatcher::visit(std::__1::shared_ptr<DB::IAST>&, DB::RewriteSumIfFunctionMatcher::Data&) @ 0x2ecff011 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.007584 [ 24642 ] {} <Fatal> BaseDaemon: 13. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InDepthNodeVisitor.h:34: DB::InDepthNodeVisitor<DB::RewriteSumIfFunctionMatcher, false, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) @ 0x2ece0a64 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.132408 [ 24642 ] {} <Fatal> BaseDaemon: 14. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InDepthNodeVisitor.h:0: DB::InDepthNodeVisitor<DB::RewriteSumIfFunctionMatcher, false, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) @ 0x2ece0f16 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.240515 [ 24642 ] {} <Fatal> BaseDaemon: 15. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InDepthNodeVisitor.h:30: DB::InDepthNodeVisitor<DB::RewriteSumIfFunctionMatcher, false, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) @ 0x2ece0a26 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.353498 [ 24642 ] {} <Fatal> BaseDaemon: 16. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InDepthNodeVisitor.h:0: DB::InDepthNodeVisitor<DB::RewriteSumIfFunctionMatcher, false, std::__1::shared_ptr<DB::IAST> >::visitChildren(std::__1::shared_ptr<DB::IAST>&) @ 0x2ece0f16 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.462867 [ 24642 ] {} <Fatal> BaseDaemon: 17. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InDepthNodeVisitor.h:30: DB::InDepthNodeVisitor<DB::RewriteSumIfFunctionMatcher, false, std::__1::shared_ptr<DB::IAST> >::visit(std::__1::shared_ptr<DB::IAST>&) @ 0x2ece0a26 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.571034 [ 24642 ] {} <Fatal> BaseDaemon: 18. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/TreeOptimizer.cpp:555: DB::(anonymous namespace)::optimizeSumIfFunctions(std::__1::shared_ptr<DB::IAST>&) @ 0x2ecce782 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.676499 [ 24642 ] {} <Fatal> BaseDaemon: 19. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/TreeOptimizer.cpp:623: DB::TreeOptimizer::apply(std::__1::shared_ptr<DB::IAST>&, std::__1::unordered_map<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::shared_ptr<DB::IAST>, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::pair<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const, std::__1::shared_ptr<DB::IAST> > > >&, std::__1::unordered_set<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::hash<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::equal_to<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::vector<DB::TableWithColumnNamesAndTypes, std::__1::allocator<DB::TableWithColumnNamesAndTypes> > const&, DB::Context const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&, bool&) @ 0x2eccc366 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.785208 [ 24642 ] {} <Fatal> BaseDaemon: 20. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/TreeRewriter.cpp:794: DB::TreeRewriter::analyzeSelect(std::__1::shared_ptr<DB::IAST>&, DB::TreeRewriterResult&&, DB::SelectQueryOptions const&, std::__1::vector<DB::TableWithColumnNamesAndTypes, std::__1::allocator<DB::TableWithColumnNamesAndTypes> > const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::TableJoin>) const @ 0x2eca0020 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:54.944705 [ 24642 ] {} <Fatal> BaseDaemon: 21. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InterpreterSelectQuery.cpp:369: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&)::$_2::operator()(bool) const @ 0x2e0fb95f in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:55.121011 [ 24642 ] {} <Fatal> BaseDaemon: 22. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InterpreterSelectQuery.cpp:460: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, std::__1::shared_ptr<DB::IBlockInputStream> const&, std::__1::optional<DB::Pipe>, std::__1::shared_ptr<DB::IStorage> const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&, std::__1::shared_ptr<DB::StorageInMemoryMetadata const> const&) @ 0x2e0f7373 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:55.293425 [ 24642 ] {} <Fatal> BaseDaemon: 23. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InterpreterSelectQuery.cpp:154: DB::InterpreterSelectQuery::InterpreterSelectQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x2e0f4a7d in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:55.413561 [ 24642 ] {} <Fatal> BaseDaemon: 24. /home/nik-kochetov/dev/ClickHouse/build-asan/../contrib/libcxx/include/memory:2068: std::__1::__unique_if<DB::InterpreterSelectQuery>::__unique_single std::__1::make_unique<DB::InterpreterSelectQuery, std::__1::shared_ptr<DB::IAST> const&, DB::Context&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&>(std::__1::shared_ptr<DB::IAST> const&, DB::Context&, DB::SelectQueryOptions&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x2e811926 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:55.587838 [ 24642 ] {} <Fatal> BaseDaemon: 25. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:327: DB::InterpreterSelectWithUnionQuery::buildCurrentChildInterpreter(std::__1::shared_ptr<DB::IAST> const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x2e80a113 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:55.750798 [ 24642 ] {} <Fatal> BaseDaemon: 26. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InterpreterSelectWithUnionQuery.cpp:249: DB::InterpreterSelectWithUnionQuery::InterpreterSelectWithUnionQuery(std::__1::shared_ptr<DB::IAST> const&, DB::Context const&, DB::SelectQueryOptions const&, std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > > > const&) @ 0x2e80910c in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:55.886832 [ 24642 ] {} <Fatal> BaseDaemon: 27. /home/nik-kochetov/dev/ClickHouse/build-asan/../contrib/libcxx/include/memory:2068: std::__1::__unique_if<DB::InterpreterSelectWithUnionQuery>::__unique_single std::__1::make_unique<DB::InterpreterSelectWithUnionQuery, std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::SelectQueryOptions const&>(std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::SelectQueryOptions const&) @ 0x2dfc3bcb in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:55.996084 [ 24642 ] {} <Fatal> BaseDaemon: 28. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/InterpreterFactory.cpp:110: DB::InterpreterFactory::get(std::__1::shared_ptr<DB::IAST>&, DB::Context&, DB::SelectQueryOptions const&) @ 0x2dfc08fa in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:56.114225 [ 24642 ] {} <Fatal> BaseDaemon: 29. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/executeQuery.cpp:503: DB::executeQueryImpl(char const*, char const*, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool, DB::ReadBuffer*) @ 0x2edc63c0 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:56.231825 [ 24642 ] {} <Fatal> BaseDaemon: 30. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Interpreters/executeQuery.cpp:868: DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) @ 0x2edc3029 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
2021.01.25 17:29:56.568343 [ 24642 ] {} <Fatal> BaseDaemon: 31. /home/nik-kochetov/dev/ClickHouse/build-asan/../src/Server/TCPHandler.cpp:260: DB::TCPHandler::runImpl() @ 0x306fb7d6 in /home/nik-kochetov/dev/ClickHouse/build-asan/programs/clickhouse
```

From #19253