ID: 24543
Title: Segfault in libpq with `scram-sha-256` auth enabled in postgres
Description:
Start PostgreSQL with `scram-sha-256` enabled:

```
docker run -d --name some-postgres \
	--network=host \
	-e POSTGRES_HOST_AUTH_METHOD=scram-sha-256 \
	-e POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256 \
	-e POSTGRES_PASSWORD=mysecretpassword \
	postgres
```


Create table in postgres:
```
echo 'CREATE TABLE postgresql_table ( id integer PRIMARY KEY, val integer NOT NULL )' | psql -h localhost -U postgres
```

Create dictionary in ClickHouse:

```
CREATE DICTIONARY postgres_dict (id UInt32, val UInt32)
PRIMARY KEY id
SOURCE(POSTGRESQL(
    port 5432
    host 'localhost'
    user  'postgres'
    password 'mysecretpassword'
    db 'postgres'
    table 'postgresql_table'))
    LIFETIME(MIN 1 MAX 2)
    LAYOUT(HASHED());
```

```
SELECT dictGetUInt32('postgres_dict', 'val', toUInt64(0));
```

<details>
<summary>Example Stack Trace</summary>

```
2021.05.26 15:56:53.074018 [ 31265 ] {} <Fatal> BaseDaemon: ########################################
2021.05.26 15:56:53.074282 [ 31265 ] {} <Fatal> BaseDaemon: (version 21.7.1.1, build id: 333FF0B93E2690BE) (from thread 29343) (no query) Received signal Segmentation fault (11)
2021.05.26 15:56:53.074438 [ 31265 ] {} <Fatal> BaseDaemon: Address: 0x2000000020 Access: write. Address not mapped to object.
2021.05.26 15:56:53.074608 [ 31265 ] {} <Fatal> BaseDaemon: Stack trace: 0x2521469d 0x25112b00 0x251126bd 0x250f4cef 0x250f471a 0x250f3f80 0x250f34c2 0x250f2b61 0x250f940c 0x250f5529 0x250f571e 0x250cb261 0x1c51e8f0 0x1c51e814 0x1c519f2c 0x1c5180f0 0x1a65fa92 0x1a65f9d6 0x1a16746d 0x1a167193 0x1a431645 0x1a1615c1 0x1a160f70 0x1a160e93 0x1a160de6 0x1a160d44 0x1a160cac 0x1c556fb2 0x1c5514c7 0x1c550bda 0x1cd98c09 0x1cd9be20 0x1cd9f0d0 0x1cd9f05c 0x1cd9efdc 0x1cd9ef5a 0x1cd9eee2 0x1cdac068 0x1cdabf7a 0x1cda89a6 0x1cda690b 0x1cdb2007 0x1cdb1e76 0x1cdb1bd2 0x1cdb1a3a 0x1cdb193d 0x1cdb18fd 0x1cdb18d5 0x1cdb18a0 0x129fcba9 0x129fbcd5 0x12a2206e
2021.05.26 15:56:53.168276 [ 31265 ] {} <Fatal> BaseDaemon: 4. /Users/vdimir/ClickHouseM/contrib/boringssl/crypto/fipsmodule/sha/../digest/md32_common.h:261: SHA256_Final @ 0x2521469d in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.222180 [ 31265 ] {} <Fatal> BaseDaemon: 5. /Users/vdimir/ClickHouseM/contrib/libpq/common/sha2_openssl.c:45: pg_sha256_final @ 0x25112b00 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.276198 [ 31265 ] {} <Fatal> BaseDaemon: 6. /Users/vdimir/ClickHouseM/contrib/libpq/common/scram-common.c:157: scram_H @ 0x251126bd in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.335628 [ 31265 ] {} <Fatal> BaseDaemon: 7. /Users/vdimir/ClickHouseM/contrib/libpq/fe-auth-scram.c:769: calculate_client_proof @ 0x250f4cef in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.393106 [ 31265 ] {} <Fatal> BaseDaemon: 8. /Users/vdimir/ClickHouseM/contrib/libpq/fe-auth-scram.c:551: build_client_final_message @ 0x250f471a in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.451296 [ 31265 ] {} <Fatal> BaseDaemon: 9. /Users/vdimir/ClickHouseM/contrib/libpq/fe-auth-scram.c:241: pg_fe_scram_exchange @ 0x250f3f80 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.506909 [ 31265 ] {} <Fatal> BaseDaemon: 10. /Users/vdimir/ClickHouseM/contrib/libpq/fe-auth.c:653: pg_SASL_continue @ 0x250f34c2 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.561322 [ 31265 ] {} <Fatal> BaseDaemon: 11. /Users/vdimir/ClickHouseM/contrib/libpq/fe-auth.c:1041: pg_fe_sendauth @ 0x250f2b61 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.624028 [ 31265 ] {} <Fatal> BaseDaemon: 12. /Users/vdimir/ClickHouseM/contrib/libpq/fe-connect.c:3446: PQconnectPoll @ 0x250f940c in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.684974 [ 31265 ] {} <Fatal> BaseDaemon: 13. /Users/vdimir/ClickHouseM/contrib/libpq/fe-connect.c:2188: connectDBComplete @ 0x250f5529 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.745886 [ 31265 ] {} <Fatal> BaseDaemon: 14. /Users/vdimir/ClickHouseM/contrib/libpq/fe-connect.c:710: PQconnectdb @ 0x250f571e in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:53.881688 [ 31265 ] {} <Fatal> BaseDaemon: 15. /Users/vdimir/ClickHouseM/contrib/libpqxx/src/connection.cxx:132: pqxx::connection::init(char const*) @ 0x250cb261 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:54.024739 [ 31265 ] {} <Fatal> BaseDaemon: 16. /Users/vdimir/ClickHouseM/contrib/libpqxx/include/pqxx/connection.hxx:171: pqxx::connection::connection(char const*) @ 0x1c51e8f0 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:54.171093 [ 31265 ] {} <Fatal> BaseDaemon: 17. /Users/vdimir/ClickHouseM/contrib/libpqxx/include/pqxx/connection.hxx:177: pqxx::connection::connection(pqxx::zview) @ 0x1c51e814 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:54.307880 [ 31265 ] {} <Fatal> BaseDaemon: 18. /Users/vdimir/ClickHouseM/contrib/libcxx/include/memory:2068: std::__1::__unique_if<pqxx::connection>::__unique_single std::__1::make_unique<pqxx::connection, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >&>(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >&) @ 0x1c519f2c in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:54.436718 [ 31265 ] {} <Fatal> BaseDaemon: 19. /Users/vdimir/ClickHouseM/src/Storages/PostgreSQL/PoolWithFailover.cpp:120: postgres::PoolWithFailover::get() @ 0x1c5180f0 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:54.752621 [ 31265 ] {} <Fatal> BaseDaemon: 20. /Users/vdimir/ClickHouseM/src/Dictionaries/PostgreSQLDictionarySource.cpp:117: DB::PostgreSQLDictionarySource::loadBase(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x1a65fa92 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:55.075701 [ 31265 ] {} <Fatal> BaseDaemon: 21. /Users/vdimir/ClickHouseM/src/Dictionaries/PostgreSQLDictionarySource.cpp:90: DB::PostgreSQLDictionarySource::loadAll() @ 0x1a65f9d6 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:56.427237 [ 31265 ] {} <Fatal> BaseDaemon: 22. /Users/vdimir/ClickHouseM/src/Dictionaries/HashedDictionary.cpp:561: DB::HashedDictionary<(DB::DictionaryKeyType)0, false>::loadData() @ 0x1a16746d in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:57.811588 [ 31265 ] {} <Fatal> BaseDaemon: 23. /Users/vdimir/ClickHouseM/src/Dictionaries/HashedDictionary.cpp:52: DB::HashedDictionary<(DB::DictionaryKeyType)0, false>::HashedDictionary(DB::StorageID const&, DB::DictionaryStructure const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >, DB::HashedDictionaryStorageConfiguration const&, std::__1::shared_ptr<DB::Block>) @ 0x1a167193 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:56:59.819827 [ 31265 ] {} <Fatal> BaseDaemon: 24. /Users/vdimir/ClickHouseM/contrib/libcxx/include/memory:2068: std::__1::__unique_if<DB::HashedDictionary<(DB::DictionaryKeyType)0, false> >::__unique_single std::__1::make_unique<DB::HashedDictionary<(DB::DictionaryKeyType)0, false>, DB::StorageID const&, DB::DictionaryStructure const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >, DB::HashedDictionaryStorageConfiguration&>(DB::StorageID const&, DB::DictionaryStructure const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >&&, DB::HashedDictionaryStorageConfiguration&) @ 0x1a431645 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:01.827273 [ 31265 ] {} <Fatal> BaseDaemon: 25. /Users/vdimir/ClickHouseM/src/Dictionaries/HashedDictionary.cpp:740: DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_4::operator()(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >, DB::DictionaryKeyType, bool) const @ 0x1a1615c1 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:03.735196 [ 31265 ] {} <Fatal> BaseDaemon: 26. /Users/vdimir/ClickHouseM/src/Dictionaries/HashedDictionary.cpp:754: auto DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0::operator()<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&>(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >) const @ 0x1a160f70 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:05.590717 [ 31265 ] {} <Fatal> BaseDaemon: 27. /Users/vdimir/ClickHouseM/contrib/libcxx/include/type_traits:3676: decltype(std::__1::forward<DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0&>(fp)(std::__1::forward<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&>(fp0), std::__1::forward<DB::DictionaryStructure const&>(fp0), std::__1::forward<Poco::Util::AbstractConfiguration const&>(fp0), std::__1::forward<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&>(fp0), std::__1::forward<std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> > >(fp0))) std::__1::__invoke<DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> > >(DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >&&) @ 0x1a160e93 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:07.469618 [ 31265 ] {} <Fatal> BaseDaemon: 28. /Users/vdimir/ClickHouseM/contrib/libcxx/include/__functional_base:317: std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > std::__1::__invoke_void_return_wrapper<std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > >::__call<DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> > >(DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >&&) @ 0x1a160de6 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:09.315149 [ 31265 ] {} <Fatal> BaseDaemon: 29. /Users/vdimir/ClickHouseM/contrib/libcxx/include/functional:1608: std::__1::__function::__default_alloc_func<DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0, std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > (std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >)>::operator()(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >&&) @ 0x1a160d44 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:11.219663 [ 31265 ] {} <Fatal> BaseDaemon: 30. /Users/vdimir/ClickHouseM/contrib/libcxx/include/functional:2089: std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > std::__1::__function::__policy_invoker<std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > (std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >)>::__call_impl<std::__1::__function::__default_alloc_func<DB::registerDictionaryHashed(DB::DictionaryFactory&)::$_0, std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > (std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >)> >(std::__1::__function::__policy_storage const*, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >&&) @ 0x1a160cac in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:11.479653 [ 31265 ] {} <Fatal> BaseDaemon: 31. /Users/vdimir/ClickHouseM/contrib/libcxx/include/functional:2221: std::__1::__function::__policy_func<std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > (std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >)>::operator()(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >&&) const @ 0x1c556fb2 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:11.785022 [ 31265 ] {} <Fatal> BaseDaemon: 32. /Users/vdimir/ClickHouseM/contrib/libcxx/include/functional:2560: std::__1::function<std::__1::unique_ptr<DB::IDictionary, std::__1::default_delete<DB::IDictionary> > (std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >)>::operator()(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::DictionaryStructure const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::unique_ptr<DB::IDictionarySource, std::__1::default_delete<DB::IDictionarySource> >) const @ 0x1c5514c7 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:12.035165 [ 31265 ] {} <Fatal> BaseDaemon: 33. /Users/vdimir/ClickHouseM/src/Dictionaries/DictionaryFactory.cpp:61: DB::DictionaryFactory::create(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::shared_ptr<DB::Context>, bool) const @ 0x1c550bda in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:12.275100 [ 31265 ] {} <Fatal> BaseDaemon: 34. /Users/vdimir/ClickHouseM/src/Interpreters/ExternalDictionariesLoader.cpp:42: DB::ExternalDictionariesLoader::create(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, Poco::Util::AbstractConfiguration const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) const @ 0x1cd98c09 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:12.554958 [ 31265 ] {} <Fatal> BaseDaemon: 35. /Users/vdimir/ClickHouseM/src/Interpreters/ExternalLoader.cpp:1498: DB::ExternalLoader::createObject(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::ExternalLoader::ObjectConfig const&, std::__1::shared_ptr<DB::IExternalLoadable const> const&) const @ 0x1cd9be20 in /home/vdimir/buildM/debug/programs/clickhouse
2021.05.26 15:57:12.876139 [ 31265 ] {} <Fatal> BaseDaemon: 36. /Users/vdimir/ClickHouseM/src/Interpreters/ExternalLoader.cpp:1264: auto DB::ExternalLoader::ExternalLoader(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, Poco::Logger*)::$_1::operator()<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::ExternalLoader::ObjectConfig const&, std::__1::shared_ptr<DB::IExternalLoadable const> const&>(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::ExternalLoader::ObjectConfig const&, std::__1::shared_ptr<DB::IExternalLoadable const> const&) const @ 0x1cd9f0d0 in /home/vdimir/buildM/debug/programs/clickhouse
```

</details>