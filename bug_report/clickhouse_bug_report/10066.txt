ID: 10066
Title: Extremely rare drop table race
Description:
Finally, I have figured out how we get these errors: `File not found: /var/lib/clickhouse/data/default/alter_table2/delete_tmp_-3_0_0_42_8/f.null.mrk2` [example link](https://clickhouse-test-reports.s3.yandex.net/9948/1d1721b37c505e82ac5fe00e3557c64fe910ae67/functional_stateless_tests_(release)/test_run.txt.out.log). Error appears with three steps:
1. Unsuccessful part mutation which fails on `checkPartChecksumsAndCommit` stage. After that we will [add part into](https://github.com/clickhouse/ClickHouse/blob/master/src/Storages/MergeTree/MergeTreeData.cpp#L1846) `data_parts_indexes` in `Precommited` state and never remove. 

```
2020.04.03 22:16:01.546502 [ 289 ] {} <Error> test_duxgri.alter_table2: DB::StorageReplicatedMergeTree::queueTask()::<lambda(DB::StorageReplicatedMergeTree::LogEntryPtr&)>: Code: 999, e.displayText() = Coordination::Exception: Transaction failed (No node): Op #2, path: /clickhouse/tables/test_duxgri.alter_table/replicas/r1/parts/-3_0_0_42_8, Stack trace (when copying this message, always include the lines below):                                                                                                                                                                                                                                                                                                             
0. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Exception.cpp:27: Poco::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x10634430 in /usr/lib/debug/us
r/bin/clickhouse                                                                                                                                                                                                                               
1. /build/obj-x86_64-linux-gnu/../dbms/Common/Exception.cpp:29: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x8f1a57d in /usr/lib/debug/usr/bin/clickhouse   
2. /build/obj-x86_64-linux-gnu/../dbms/Common/ZooKeeper/IKeeper.cpp:138: Coordination::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int, int) @ 0xe0038e8 in /usr/lib/deb
ug/usr/bin/clickhouse                                                                                                                                                                                                                          
3. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/string:2134: Coordination::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0xe003f12 in /usr/lib/debug/usr/b
in/clickhouse                                                                                                                                                                                                                                  
4. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/string:2134: zkutil::KeeperMultiException::KeeperMultiException(int, std::__1::vector<std::__1::shared_ptr<Coordination::Request>, std::__1::allocator<std::__1::shared_ptr<Coordination::Request> > > const&, std::__1::vector<std::__1::shared_ptr<Coordination::Response>, std::__1::allocator<std::__1::shared_ptr<Coordination::Response> > > const&) @ 0xe012940 in /usr/lib/debug/usr/bin/clickhouse                          
5. /build/obj-x86_64-linux-gnu/../dbms/Common/ZooKeeper/ZooKeeper.cpp:914: zkutil::ZooKeeper::multi(std::__1::vector<std::__1::shared_ptr<Coordination::Request>, std::__1::allocator<std::__1::shared_ptr<Coordination::Request> > > const&) (.cold) @ 0xe0182e7 in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                                                        
6. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:555: DB::StorageReplicatedMergeTree::checkPartChecksumsAndCommit(DB::MergeTreeData::Transaction&, std::__1::shared_ptr<DB::IMergeTreeDataPart const> const&) @ 0xd7ff2e0 in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                                                                                 7. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/vector:555: DB::StorageReplicatedMergeTree::tryExecutePartMutation(DB::ReplicatedMergeTreeLogEntry const&) @ 0xd801aa3 in /usr/lib/debug/usr/bin/clickhouse                           
8. /build/obj-x86_64-linux-gnu/../dbms/Storages/StorageReplicatedMergeTree.cpp:936: DB::StorageReplicatedMergeTree::executeLogEntry(DB::ReplicatedMergeTreeLogEntry&) @ 0xd82dd7b in /usr/lib/debug/usr/bin/clickhouse                         
9. /build/obj-x86_64-linux-gnu/../dbms/Storages/StorageReplicatedMergeTree.cpp:2119: DB::StorageReplicatedMergeTree::queueTask()::'lambda0'(std::__1::shared_ptr<DB::ReplicatedMergeTreeLogEntry>&)::operator()(std::__1::shared_ptr<DB::ReplicatedMergeTreeLogEntry>&) const (.isra.0) @ 0xd82e09f in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                     
10. /build/obj-x86_64-linux-gnu/../dbms/Storages/MergeTree/ReplicatedMergeTreeQueue.cpp:1218: DB::ReplicatedMergeTreeQueue::processEntry(std::__1::function<std::__1::shared_ptr<zkutil::ZooKeeper> ()>, std::__1::shared_ptr<DB::ReplicatedMergeTreeLogEntry>&, std::__1::function<bool (std::__1::shared_ptr<DB::ReplicatedMergeTreeLogEntry>&)>) @ 0xdb699c2 in /usr/lib/debug/usr/bin/clickhouse                                                                                          
11. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1825: DB::StorageReplicatedMergeTree::queueTask() @ 0xd7e698e in /usr/lib/debug/usr/bin/clickhouse                                                                        12. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1867: DB::BackgroundProcessingPool::threadFunction() @ 0xd935f45 in /usr/lib/debug/usr/bin/clickhouse                                                                     13. /build/obj-x86_64-linux-gnu/../dbms/Common/ThreadPool.h:159: ThreadFromGlobalPool::ThreadFromGlobalPool<DB::BackgroundProcessingPool::BackgroundProcessingPool(int, DB::BackgroundProcessingPool::PoolSettings const&, char const*, char const*)::'lambda'()>(DB::BackgroundProcessingPool::BackgroundProcessingPool(int, DB::BackgroundProcessingPool::PoolSettings const&, char const*, char const*)::'lambda'()&&)::'lambda'()::operator()() const @ 0xd936872 in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                                                                                                   14. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/atomic:856: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x8f3ff3b in /usr/lib/debug/usr/bin/clickhouse                            
15. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2615: void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()> >(void*) @ 0x8f3e423 in /usr/lib/debug/usr/bin/clickhouse                                                           
16. start_thread @ 0x9669 in /usr/lib/x86_64-linux-gnu/libpthread-2.30.so                                                                                                                                                                      17. clone @ 0x122323 in /usr/lib/x86_64-linux-gnu/libc-2.30.so                                                                                                                                                                                  (version 20.4.1.2882)   
```

2. One more unsuccessful part mutation which fails while part is in the temporary state ([here](https://github.com/clickhouse/ClickHouse/blob/master/src/Storages/StorageReplicatedMergeTree.cpp#L1190-L1191)). After that part will try delete itself in own [destructor](https://github.com/clickhouse/ClickHouse/blob/master/src/Storages/MergeTree/MergeTreeDataPartWide.cpp#L140) .
```
2020.04.03 22:16:01.579476 [ 278 ] {} <Error> void DB::IMergeTreeDataPart::removeIfNeeded(): Poco::Exception. Code: 1000, e.code() = 2, e.displayText() = File not found: /var/lib/clickhouse/data/test_duxgri/alter_table2/delete_tmp_-3_0_0_4
2_8/e.size0.bin, Stack trace (when copying this message, always include the lines below):

0. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Exception.cpp:27: Poco::FileNotFoundException::FileNotFoundException(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x1063d
cd0 in /usr/lib/debug/usr/bin/clickhouse
1. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/File_UNIX.cpp:499: Poco::FileImpl::handleLastErrorImpl(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x106497ac in /usr/lib/deb
ug/usr/bin/clickhouse
2. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/File_UNIX.cpp:183: Poco::File::remove(bool) (.cold) @ 0x10649fcf in /usr/lib/debug/usr/bin/clickhouse
3. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/iterator:1530: Poco::File::remove(bool) @ 0x10649250 in /usr/lib/debug/usr/bin/clickhouse
4. /build/obj-x86_64-linux-gnu/../dbms/Disks/DiskLocal.cpp:239: DB::DiskLocal::removeRecursive(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0xcfea718 in /usr/lib/debug/usr/bin/clickhouse
5. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/string:2134: DB::IMergeTreeDataPart::remove() const @ 0xd947cf7 in /usr/lib/debug/usr/bin/clickhouse
6. /build/obj-x86_64-linux-gnu/../dbms/Storages/MergeTree/IMergeTreeDataPart.cpp:268: DB::IMergeTreeDataPart::removeIfNeeded() @ 0xd947fe6 in /usr/lib/debug/usr/bin/clickhouse
7. /build/obj-x86_64-linux-gnu/../dbms/Storages/MergeTree/MergeTreeDataPartWide.cpp:138: DB::MergeTreeDataPartWide::~MergeTreeDataPartWide() @ 0xda1de74 in /usr/lib/debug/usr/bin/clickhouse
8. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:3483: std::__1::shared_ptr<DB::IMergeTreeDataPart>::~shared_ptr() @ 0xd7d5b72 in /usr/lib/debug/usr/bin/clickhouse
9. /build/obj-x86_64-linux-gnu/../dbms/Storages/TableStructureLockHolder.h:33: DB::StorageReplicatedMergeTree::tryExecutePartMutation(DB::ReplicatedMergeTreeLogEntry const&) (.cold) @ 0xd83eeed in /usr/lib/debug/usr/bin/clickhouse
10. /build/obj-x86_64-linux-gnu/../dbms/Storages/StorageReplicatedMergeTree.cpp:936: DB::StorageReplicatedMergeTree::executeLogEntry(DB::ReplicatedMergeTreeLogEntry&) @ 0xd82dd7b in /usr/lib/debug/usr/bin/clickhouse
11. /build/obj-x86_64-linux-gnu/../dbms/Storages/StorageReplicatedMergeTree.cpp:2119: DB::StorageReplicatedMergeTree::queueTask()::'lambda0'(std::__1::shared_ptr<DB::ReplicatedMergeTreeLogEntry>&)::operator()(std::__1::shared_ptr<DB::Repli
catedMergeTreeLogEntry>&) const (.isra.0) @ 0xd82e09f in /usr/lib/debug/usr/bin/clickhouse
12. /build/obj-x86_64-linux-gnu/../dbms/Storages/MergeTree/ReplicatedMergeTreeQueue.cpp:1218: DB::ReplicatedMergeTreeQueue::processEntry(std::__1::function<std::__1::shared_ptr<zkutil::ZooKeeper> ()>, std::__1::shared_ptr<DB::ReplicatedMer
geTreeLogEntry>&, std::__1::function<bool (std::__1::shared_ptr<DB::ReplicatedMergeTreeLogEntry>&)>) @ 0xdb699c2 in /usr/lib/debug/usr/bin/clickhouse
13. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1825: DB::StorageReplicatedMergeTree::queueTask() @ 0xd7e698e in /usr/lib/debug/usr/bin/clickhouse
14. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/functional:1867: DB::BackgroundProcessingPool::threadFunction() @ 0xd935f45 in /usr/lib/debug/usr/bin/clickhouse
15. /build/obj-x86_64-linux-gnu/../dbms/Common/ThreadPool.h:159: ThreadFromGlobalPool::ThreadFromGlobalPool<DB::BackgroundProcessingPool::BackgroundProcessingPool(int, DB::BackgroundProcessingPool::PoolSettings const&, char const*, char co
nst*)::'lambda'()>(DB::BackgroundProcessingPool::BackgroundProcessingPool(int, DB::BackgroundProcessingPool::PoolSettings const&, char const*, char const*)::'lambda'()&&)::'lambda'()::operator()() const @ 0xd936872 in /usr/lib/debug/usr/bi
n/clickhouse
16. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/atomic:856: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x8f3ff3b in /usr/lib/debug/usr/bin/clickhouse
17. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2615: void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImp
l<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()> >(void*) @ 0x8f3e423 in /usr/lib/debug/usr/bin/clickhouse
18. start_thread @ 0x9669 in /usr/lib/x86_64-linux-gnu/libpthread-2.30.so
```

3. The simultaneous drop of the table, which will try to [remove all parts](https://github.com/clickhouse/ClickHouse/blob/master/src/Storages/MergeTree/MergeTreeData.cpp#L1334-L1344) from `data_parts_indexes`.

```
2020.04.03 22:16:01.562970 [ 3609 ] {d1a8d4f5-369c-471f-a483-681751c4a5c8} <Error> executeQuery: Poco::Exception. Code: 1000, e.code() = 2, e.displayText() = File not found: /var/lib/clickhouse/data/test_duxgri/alter_table2/delete_tmp_-3_0
_0_42_8/f.null.mrk2 (version 20.4.1.2882) (from [::1]:36390) (in query: DROP TABLE alter_table2), Stack trace (when copying this message, always include the lines below):                                                                     
                                                                                                                                                                                                                                               
0. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/Exception.cpp:27: Poco::FileNotFoundException::FileNotFoundException(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x1063d
cd0 in /usr/lib/debug/usr/bin/clickhouse                                                                                                                                                                                                       1. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/File_UNIX.cpp:499: Poco::FileImpl::handleLastErrorImpl(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x106497ac in /usr/lib/deb
ug/usr/bin/clickhouse                                                                                                                                                                                                                          
2. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/File_UNIX.cpp:183: ? @ 0x10649c1d in /usr/lib/debug/usr/bin/clickhouse                                                                                                           3. /build/obj-x86_64-linux-gnu/../contrib/poco/Foundation/src/File.cpp:306: Poco::File::remove(bool) @ 0x10649190 in /usr/lib/debug/usr/bin/clickhouse                                                                                         
4. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/iterator:1530: Poco::File::remove(bool) @ 0x10649250 in /usr/lib/debug/usr/bin/clickhouse                                                                                             5. /build/obj-x86_64-linux-gnu/../dbms/Disks/DiskLocal.cpp:239: DB::DiskLocal::removeRecursive(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0xcfea718 in /usr/lib/debug/usr/bin/clickhouse
6. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/string:2134: DB::IMergeTreeDataPart::remove() const (.cold) @ 0xd9534c1 in /usr/lib/debug/usr/bin/clickhouse
7. /build/obj-x86_64-linux-gnu/../dbms/Storages/MergeTree/MergeTreeData.cpp:1289: DB::MergeTreeData::clearPartsFromFilesystem(std::__1::vector<std::__1::shared_ptr<DB::IMergeTreeDataPart const>, std::__1::allocator<std::__1::shared_ptr<DB:
:IMergeTreeDataPart const> > > const&)::'lambda'()::operator()() const (.isra.0) @ 0xd973071 in /usr/lib/debug/usr/bin/clickhouse
8. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/atomic:856: ThreadPoolImpl<ThreadFromGlobalPool>::worker(std::__1::__list_iterator<ThreadFromGlobalPool, void*>) @ 0x8f4107b in /usr/lib/debug/usr/bin/clickhouse
9. /build/obj-x86_64-linux-gnu/../dbms/Common/ThreadPool.h:159: ThreadFromGlobalPool::ThreadFromGlobalPool<void ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::
'lambda1'()>(void&&, void ThreadPoolImpl<ThreadFromGlobalPool>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()&&...)::'lambda'()::operator()() const @ 0x8f41e4a in /usr/lib/debug/usr/bin/clickhouse10. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/atomic:856: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x8f3ff3b in /usr/lib/debug/usr/bin/clickhouse
11. /build/obj-x86_64-linux-gnu/../contrib/libcxx/include/memory:2615: void* std::__1::__thread_proxy<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, int, std::__1::optional<unsigned long>)::'lambda1'()> >(void*) @ 0x8f3e423 in /usr/lib/debug/usr/bin/clickhouse
12. start_thread @ 0x9669 in /usr/lib/x86_64-linux-gnu/libpthread-2.30.so
13. clone @ 0x122323 in /usr/lib/x86_64-linux-gnu/libc-2.30.so
```