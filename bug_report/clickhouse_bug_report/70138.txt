ID: 70138
Title: `clickhouse-local` crashes when running in server directory during loading of outdated parts
Description:
When I run `clickhouse-local` in the server directory it crashes durging loading of outdated parts:
```
Thread 597 "OutdatedParts" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffebb08f640 (LWP 508168)]
DB::AsynchronousReadBufferFromFileDescriptor::asyncReadInto (this=this@entry=0x7fffb59ee480, data=0x7fff62406e00 "Array(String)", size=706, priority=priority@entry=...) at /home/avogar/ClickHouse/src/IO/AsynchronousReadBufferFromFileDescriptor.cpp:62
62	    return reader.submit(request);
(gdb) bt
#0  DB::AsynchronousReadBufferFromFileDescriptor::asyncReadInto (this=this@entry=0x7fffb59ee480, data=0x7fff62406e00 "Array(String)", size=706, priority=priority@entry=...) at /home/avogar/ClickHouse/src/IO/AsynchronousReadBufferFromFileDescriptor.cpp:62
#1  0x0000000010227ccb in DB::AsynchronousReadBufferFromFileDescriptor::nextImpl (this=0x7fffb59ee480) at /home/avogar/ClickHouse/src/IO/AsynchronousReadBufferFromFileDescriptor.cpp:100
#2  0x0000000007605bdb in DB::ReadBuffer::next (this=0x7fffb59ee480) at /home/avogar/ClickHouse/src/IO/ReadBuffer.h:70
#3  0x000000000c1e51d2 in DB::ReadBuffer::eof (this=0x7fffb59ee480) at /home/avogar/ClickHouse/src/IO/ReadBuffer.h:106
#4  DB::checkString (s=0x103d3ce "columns format version: 1\n", buf=...) at /home/avogar/ClickHouse/src/IO/ReadHelpers.cpp:103
#5  DB::assertString (s=0x103d3ce "columns format version: 1\n", buf=...) at /home/avogar/ClickHouse/src/IO/ReadHelpers.cpp:130
#6  0x00000000107522ad in DB::NamesAndTypesList::readText (this=0x7ffebb081d00, buf=...) at /home/avogar/ClickHouse/src/Core/NamesAndTypes.cpp:66
#7  0x00000000127a411c in DB::IMergeTreeDataPart::loadColumns (this=this@entry=0x7fffb59f1718, require=false) at /home/avogar/ClickHouse/src/Storages/MergeTree/IMergeTreeDataPart.cpp:1618
#8  0x00000000127a2fdf in DB::IMergeTreeDataPart::loadColumnsChecksumsIndexes (this=0x7fffb59f1718, require_columns_checksums=<optimized out>, check_consistency=true) at /home/avogar/ClickHouse/src/Storages/MergeTree/IMergeTreeDataPart.cpp:717
#9  0x0000000012853622 in DB::MergeTreeData::loadDataPart (this=this@entry=0x7fffea707040, part_info=..., part_name=..., part_disk_ptr=..., to_state=to_state@entry=DB::MergeTreeDataPartState::Outdated, part_loading_mutex=...) at /home/avogar/ClickHouse/src/Storages/MergeTree/MergeTreeData.cpp:1472
#10 0x000000001285810b in DB::MergeTreeData::loadDataPartWithRetries (this=this@entry=0x7fffea707040, part_info=..., part_name=..., part_disk_ptr=..., to_state=to_state@entry=DB::MergeTreeDataPartState::Outdated, part_loading_mutex=..., initial_backoff_ms=100, max_backoff_ms=5000, max_tries=3)
    at /home/avogar/ClickHouse/src/Storages/MergeTree/MergeTreeData.cpp:1611
#11 0x00000000128c921d in DB::MergeTreeData::loadOutdatedDataParts(bool)::$_0::operator()() const (this=0x7fffc3b6be40) at /home/avogar/ClickHouse/src/Storages/MergeTree/MergeTreeData.cpp:2131
#12 std::__1::__invoke[abi:v15007]<DB::MergeTreeData::loadOutdatedDataParts(bool)::$_0&>(DB::MergeTreeData::loadOutdatedDataParts(bool)::$_0&) (__f=...) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394
#13 std::__1::__invoke_void_return_wrapper<void, true>::__call<DB::MergeTreeData::loadOutdatedDataParts(bool)::$_0&>(DB::MergeTreeData::loadOutdatedDataParts(bool)::$_0&) (__args=...) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:479
#14 std::__1::__function::__default_alloc_func<DB::MergeTreeData::loadOutdatedDataParts(bool)::$_0, void ()>::operator()[abi:v15007]() (this=0x7fffc3b6be40) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:235
#15 std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<DB::MergeTreeData::loadOutdatedDataParts(bool)::$_0, void ()> >(std::__1::__function::__policy_storage const*) (__buf=<optimized out>)
    at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:716
#16 0x000000000fe1d57a in std::__1::__function::__policy_func<void ()>::operator()[abi:v15007]() const (this=0x7fff6239f600) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:848
#17 std::__1::function<void ()>::operator()() const (this=0x7fff6239f600) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:1197
#18 DB::ThreadPoolCallbackRunnerLocal<void, ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >, std::__1::function<void ()> >::operator()(std::__1::function<void ()>&&, Priority)::{lambda()#1}::operator()() (this=0x7fff6239f5c8) at /home/avogar/ClickHouse/src/Common/threadPoolCallbackRunner.h:160
#19 0x000000000c6daf37 in std::__1::__packaged_task_function<void ()>::operator()() const (this=<optimized out>) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/future:1876
#20 std::__1::packaged_task<void ()>::operator()() (this=<optimized out>) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/future:2068
#21 0x000000000c23b9cd in std::__1::__function::__policy_func<void ()>::operator()[abi:v15007]() const (this=0x7ffebb082750) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:848
#22 std::__1::function<void ()>::operator()() const (this=0x7ffebb082750) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:1197
#23 ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::worker (this=this@entry=0x7ffff663d340, thread_it=thread_it@entry=...) at /home/avogar/ClickHouse/src/Common/ThreadPool.cpp:530
#24 0x000000000c23f8b1 in ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}::operator()() const (this=<optimized out>) at /home/avogar/ClickHouse/src/Common/ThreadPool.cpp:252
#25 std::__1::__invoke[abi:v15007]<ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&>(ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&) (__f=...) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394
#26 std::__1::__apply_tuple_impl[abi:v15007]<ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&, std::__1::tuple<>&>(ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&, std::__1::tuple<>&, std::__1::__tuple_indices<>) (__f=..., __t=...) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/tuple:1789
#27 std::__1::apply[abi:v15007]<ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&, std::__1::tuple<>&>(ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&, std::__1::tuple<>&) (__f=..., __t=...) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/tuple:1798
#28 ThreadFromGlobalPoolImpl<false, true>::ThreadFromGlobalPoolImpl<ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}>(ThreadPoolImpl<ThreadFromGlobalPoolImpl<false, true> >::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&&)::{lambda()#1}::operator()() (this=0x7fffb58aa140) at /home/avogar/ClickHouse/src/Common/ThreadPool.h:251
#29 0x000000000c2388e0 in std::__1::__function::__policy_func<void ()>::operator()[abi:v15007]() const (this=0x7ffebb082c80) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:848
#30 std::__1::function<void ()>::operator()() const (this=0x7ffebb082c80) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:1197
#31 ThreadPoolImpl<std::__1::thread>::worker (this=0x7ffff6658c80, thread_it=...) at /home/avogar/ClickHouse/src/Common/ThreadPool.cpp:540
#32 0x000000000c23d665 in ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}::operator()() const (this=0x7ffebb081a78) at /home/avogar/ClickHouse/src/Common/ThreadPool.cpp:252
#33 std::__1::__invoke[abi:v15007]<ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}>(ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}&&) (__f=...) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394
#34 std::__1::__thread_execute[abi:v15007]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}>(std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}>&, std::__1::__tuple_indices<>) (__t=...)
    at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/thread:284
#35 std::__1::__thread_proxy[abi:v15007]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct> >, ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::{lambda()#2}> >(void*)
    (__vp=<optimized out>) at /home/avogar/ClickHouse/contrib/llvm-project/libcxx/include/thread:295
#36 0x00007ffff7c94ac3 in start_thread (arg=<optimized out>) at ./nptl/pthread_create.c:442
#37 0x00007ffff7d26850 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81
```