ID: 54352
Title: Assertion `new_head == holder.key.data` failed (`Aggregator`)
Description:
https://s3.amazonaws.com/clickhouse-test-reports/0/d9746b5ea10eec3b0e82d46b1b15627ccfb3f243/fuzzer_astfuzzerdebug/report.html

https://s3.amazonaws.com/clickhouse-test-reports/54043/03914f2d31da7a3c3384426c425666f6526afa93/fuzzer_astfuzzerdebug/report.html

```
5947:2023.09.05 19:28:01.035857 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Debug> executeQuery: (from [::ffff:127.0.0.1]:49390) SELECT count(), min(length(c.d)) AS minExpr, min(dcount) AS minAlias, max(length(c.d)) AS maxExpr, max(dcount) AS maxAlias, b FROM max_length_alias_14053__fuzz_45 GROUP BY GROUPING SETS ((b)) (stage: Complete)
5948:2023.09.05 19:28:01.043542 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> ContextAccess (default): Access granted: SELECT(b, `c.d`, dcount) ON default.max_length_alias_14053__fuzz_45
5949:2023.09.05 19:28:01.043994 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> InterpreterSelectQuery: FetchColumns -> Complete
5950:2023.09.05 19:28:01.051481 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Debug> default.max_length_alias_14053__fuzz_45 (07cbf800-de67-491f-956d-7bc687a12fc2) (SelectExecutor): Key condition: unknown
5951:2023.09.05 19:28:01.051703 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Debug> default.max_length_alias_14053__fuzz_45 (07cbf800-de67-491f-956d-7bc687a12fc2) (SelectExecutor): MinMax index condition: unknown
5952:2023.09.05 19:28:01.052175 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Debug> default.max_length_alias_14053__fuzz_45 (07cbf800-de67-491f-956d-7bc687a12fc2) (SelectExecutor): Selected 3/3 parts by partition key, 3 parts by primary key, 3/3 marks by primary key, 3 marks to read from 3 ranges
5953:2023.09.05 19:28:01.052332 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> default.max_length_alias_14053__fuzz_45 (07cbf800-de67-491f-956d-7bc687a12fc2) (SelectExecutor): Spreading mark ranges among streams (default reading)
5954:2023.09.05 19:28:01.052905 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Debug> MergeTreeReadPool: min_marks_for_concurrent_read=24
5955:2023.09.05 19:28:01.053065 [ 178 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Debug> default.max_length_alias_14053__fuzz_45 (07cbf800-de67-491f-956d-7bc687a12fc2) (SelectExecutor): Reading approx. 11 rows with 3 streams
5958:2023.09.05 19:28:01.066218 [ 507 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> AggregatingTransform: Aggregating
5959:2023.09.05 19:28:01.066232 [ 503 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> AggregatingTransform: Aggregating
5960:2023.09.05 19:28:01.066245 [ 466 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> AggregatingTransform: Aggregating
5961:2023.09.05 19:28:01.066302 [ 503 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> Aggregator: Aggregation method: serialized
5962:2023.09.05 19:28:01.066343 [ 507 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> Aggregator: Aggregation method: serialized
5963:2023.09.05 19:28:01.066378 [ 466 ] {5fdfcd95-1691-453b-a318-7dd48d577905} <Trace> Aggregator: Aggregation method: serialized
```

```
2023.09.05 19:27:59.558109 [ 178 ] {10751f12-295b-4584-9dee-978724a3c37f} <Debug> executeQuery: (from [::ffff:127.0.0.1]:49390) CREATE TABLE max_length_alias_14053__fuzz_45 (`a` Date, `b` Nullable(Decimal(76, 45)), `c.d` Array(Nullable(DateTime64(3))), `dcount` Int8 ALIAS length(c.d)) ENGINE = MergeTree PARTITION BY toMonday(a) ORDER BY (a, b) SETTINGS index_granularity = 8192 (stage: Complete)
2023.09.05 19:27:59.558347 [ 178 ] {10751f12-295b-4584-9dee-978724a3c37f} <Trace> ContextAccess (default): Access granted: CREATE TABLE ON default.max_length_alias_14053__fuzz_45
```

```
llvm-addr2line -pafiCse ./clickhouse 0x00007f5779b04a7c 0x00007f5779ab0476 0x00007f5779a967f3 0x00007f5779a9671b 0x00007f5779aa7e96 0x000000001c2b3d16 0x000000001c11a469 0x000000001c05e1c8 0x000000001c06318d 0x000000001eb4e9b3 0x000000001eb4c2d9 0x000000001e6b4b03 0x000000001e6b4840 0x000000001e699741 0x000000001e699a57 0x000000001e69a798 0x000000001e69a6f5 0x000000001e69a6d5 0x000000001e69a6b5 0x000000001e69a680 0x000000001398e416 0x000000001398d8f5 0x0000000013a99b23 0x0000000013aa4384 0x0000000013aa4355 0x0000000013aa4339 0x0000000013aa429d 0x0000000013aa41a5 0x0000000013aa4115 0x0000000013aa40f5 0x0000000013aa40d5 0x0000000013aa40a0 0x000000001398e416 0x000000001398d8f5 0x0000000013a96403 0x0000000013a9e6a4 0x0000000013a9e655 0x0000000013a9e57d 0x0000000013a9e062 0x00007f5779b02b43 0x00007f5779b94a00
0x7f5779b04a7c: ?? at ??:0
0x7f5779ab0476: ?? at ??:0
0x7f5779a967f3: ?? at ??:0
0x7f5779a9671b: ?? at ??:0
0x7f5779aa7e96: ?? at ??:0
0x1c2b3d16: keyHolderDiscardKey(DB::SerializedKeyHolder&) at HashTableKeyHolder.h:132
 (inlined by) void HashTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>::emplaceNonZeroImpl<DB::SerializedKeyHolder&>(unsigned long, DB::SerializedKeyHolder&, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>*&, bool&, unsigned long) at HashTable.h:972
 (inlined by) void HashTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>::emplaceNonZero<DB::SerializedKeyHolder&>(DB::SerializedKeyHolder&, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>*&, bool&, unsigned long) at HashTable.h:1017
 (inlined by) void HashTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>::emplace<DB::SerializedKeyHolder&>(DB::SerializedKeyHolder&, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>*&, bool&, unsigned long) at HashTable.h:1096
 (inlined by) void HashTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>::emplace<DB::SerializedKeyHolder&>(DB::SerializedKeyHolder&, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>*&, bool&) at HashTable.h:1087
 (inlined by) DB::ColumnsHashing::columns_hashing_impl::EmplaceResultImpl<char*> DB::ColumnsHashing::columns_hashing_impl::HashMethodBase<DB::ColumnsHashing::HashMethodSerialized<PairNoInit<StringRef, char*>, char*>, PairNoInit<StringRef, char*>, char*, false, false, false>::emplaceImpl<HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>, DB::SerializedKeyHolder>(DB::SerializedKeyHolder&, HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>&) at ColumnsHashingImpl.h:251
 (inlined by) DB::ColumnsHashing::columns_hashing_impl::EmplaceResultImpl<char*> DB::ColumnsHashing::columns_hashing_impl::HashMethodBase<DB::ColumnsHashing::HashMethodSerialized<PairNoInit<StringRef, char*>, char*>, PairNoInit<StringRef, char*>, char*, false, false, false>::emplaceKey<HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>>(HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>&, unsigned long, DB::Arena&) at ColumnsHashingImpl.h:170
 (inlined by) void DB::Aggregator::executeImplBatch<false, false, false, DB::AggregationMethodSerialized<HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>>>(DB::AggregationMethodSerialized<HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>>&, DB::AggregationMethodSerialized<HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>>::State&, DB::Arena*, unsigned long, unsigned long, DB::Aggregator::AggregateFunctionInstruction*, char*) const at Aggregator.cpp:1203
0x1c11a469: void DB::Aggregator::executeImpl<DB::AggregationMethodSerialized<HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>>>(DB::AggregationMethodSerialized<HashMapTable<StringRef, HashMapCellWithSavedHash<StringRef, char*, DefaultHash<StringRef>, HashTableNoState>, DefaultHash<StringRef>, HashTableGrowerWithPrecalculation<8ul>, Allocator<true, true>>>&, DB::Arena*, unsigned long, unsigned long, std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*>>&, DB::Aggregator::AggregateFunctionInstruction*, bool, char*) const at Aggregator.cpp:1089
0x1c05e1c8: DB::Aggregator::executeImpl(DB::AggregatedDataVariants&, unsigned long, unsigned long, std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*>>&, DB::Aggregator::AggregateFunctionInstruction*, bool, char*) const at Aggregator.cpp:1045
0x1c06318d: DB::Aggregator::executeOnBlock(std::__1::vector<COW<DB::IColumn>::immutable_ptr<DB::IColumn>, std::__1::allocator<COW<DB::IColumn>::immutable_ptr<DB::IColumn>>>, unsigned long, unsigned long, DB::AggregatedDataVariants&, std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*>>&, std::__1::vector<std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*>>, std::__1::allocator<std::__1::vector<DB::IColumn const*, std::__1::allocator<DB::IColumn const*>>>>&, bool&) const at Aggregator.cpp:1592
0x1eb4e9b3: DB::AggregatingTransform::consume(DB::Chunk) at AggregatingTransform.cpp:669
0x1eb4c2d9: DB::AggregatingTransform::work() at AggregatingTransform.cpp:628
0x1e6b4b03: DB::executeJob(DB::ExecutingGraph::Node*, DB::ReadProgressCallback*) at ExecutionThreadContext.cpp:47
0x1e6b4840: DB::ExecutionThreadContext::executeTask() at ExecutionThreadContext.cpp:95
0x1e699741: DB::PipelineExecutor::executeStepImpl(unsigned long, std::__1::atomic<bool>*) at PipelineExecutor.cpp:272
0x1e699a57: DB::PipelineExecutor::executeSingleThread(unsigned long) at PipelineExecutor.cpp:238
0x1e69a798: DB::PipelineExecutor::spawnThreads()::$_0::operator()() const at PipelineExecutor.cpp:362
0x1e69a6f5: decltype(std::declval<DB::PipelineExecutor::spawnThreads()::$_0&>()()) std::__1::__invoke[abi:v15000]<DB::PipelineExecutor::spawnThreads()::$_0&>(DB::PipelineExecutor::spawnThreads()::$_0&) at invoke.h:394
0x1e69a6d5: void std::__1::__invoke_void_return_wrapper<void, true>::__call<DB::PipelineExecutor::spawnThreads()::$_0&>(DB::PipelineExecutor::spawnThreads()::$_0&) at invoke.h:480
0x1e69a6b5: std::__1::__function::__default_alloc_func<DB::PipelineExecutor::spawnThreads()::$_0, void ()>::operator()[abi:v15000]() at function.h:235
0x1e69a680: void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<DB::PipelineExecutor::spawnThreads()::$_0, void ()>>(std::__1::__function::__policy_storage const*) at function.h:716
0x1398e416: std::__1::__function::__policy_func<void ()>::operator()[abi:v15000]() const at function.h:848
0x1398d8f5: std::__1::function<void ()>::operator()() const at function.h:1187
0x13a99b23: ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::worker(std::__1::__list_iterator<ThreadFromGlobalPoolImpl<false>, void*>) at ThreadPool.cpp:426
0x13aa4384: void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()::operator()() const at ThreadPool.cpp:179
0x13aa4355: decltype(std::declval<void>()()) std::__1::__invoke[abi:v15000]<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()&>(void&&) at invoke.h:394
0x13aa4339: decltype(auto) std::__1::__apply_tuple_impl[abi:v15000]<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()&, std::__1::tuple<>&>(void&&, std::__1::tuple<>&, std::__1::__tuple_indices<>) at tuple:1789
0x13aa429d: decltype(auto) std::__1::apply[abi:v15000]<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()&, std::__1::tuple<>&>(void&&, std::__1::tuple<>&) at tuple:1798
0x13aa41a5: ThreadFromGlobalPoolImpl<false>::ThreadFromGlobalPoolImpl<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&)::'lambda'()::operator()() at ThreadPool.h:242
0x13aa4115: decltype(std::declval<void>()()) std::__1::__invoke[abi:v15000]<ThreadFromGlobalPoolImpl<false>::ThreadFromGlobalPoolImpl<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&)::'lambda'()&>(void&&) at invoke.h:394
0x13aa40f5: void std::__1::__invoke_void_return_wrapper<void, true>::__call<ThreadFromGlobalPoolImpl<false>::ThreadFromGlobalPoolImpl<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&)::'lambda'()&>(ThreadFromGlobalPoolImpl<false>::ThreadFromGlobalPoolImpl<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&)::'lambda'()&) at invoke.h:480
0x13aa40d5: std::__1::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<false>::ThreadFromGlobalPoolImpl<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&)::'lambda'(), void ()>::operator()[abi:v15000]() at function.h:235
0x13aa40a0: void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<false>::ThreadFromGlobalPoolImpl<void ThreadPoolImpl<ThreadFromGlobalPoolImpl<false>>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&)::'lambda'(), void ()>>(std::__1::__function::__policy_storage const*) at function.h:716
0x1398e416: std::__1::__function::__policy_func<void ()>::operator()[abi:v15000]() const at function.h:848
0x1398d8f5: std::__1::function<void ()>::operator()() const at function.h:1187
0x13a96403: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) at ThreadPool.cpp:426
0x13a9e6a4: void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()::operator()() const at ThreadPool.cpp:179
0x13a9e655: decltype(std::declval<void>()()) std::__1::__invoke[abi:v15000]<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&) at invoke.h:394
0x13a9e57d: void std::__1::__thread_execute[abi:v15000]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>(std::__1::tuple<void, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>&, std::__1::__tuple_indices<>) at thread:285
0x13a9e062: void* std::__1::__thread_proxy[abi:v15000]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, Priority, std::__1::optional<unsigned long>, bool)::'lambda0'()>>(void*) at thread:295
0x7f5779b02b43: ?? at ??:0
0x7f5779b94a00: ?? at ??:0
```

cc: @KochetovNicolai 