ID: 7607
Title: A query with topK() threw an exception.
Description:
**Describe the bug or unexpected behaviour**
I tested topK() function, but ClickHouse threw an exception and crashed.
The query I executed is as below.
```SQL
SELECT topK(10)(term) FROM default.log_shard 
WHERE ((toYYYYMMDD(time) >= 20190801) AND (toYYYYMMDD(time) <= 20190901)) 
  AND (code = 'svc1') 
  AND (user_id IN (
    (SELECT user_id FROM log_shard 
     WHERE ((toYYYYMMDD(time) >= 20190801) AND (toYYYYMMDD(time) <= 20190801)) 
     AND (term = 'product_A') 
     AND (code = 'svc1')) AS _subquery2462)) 
  AND isNotNull(term)
```
Table schema is as below.
```
user_id UInt64
time DateTime
term Nullable(String)
code LowCardinality(String)
ENGINE : ReplicatedMergeTree
PARTITION KEY : toYYYYMMDD(time)
PRIMARY KEY : code, user_id
```

Versions I am using.
```
ClickHouse client version 19.13.1.11.
Connecting to localhost:9000 as user default.
Connected to ClickHouse server version 19.13.1 revision 54425.
```


**Error message and/or stacktrace**
```
2019.11.04 11:15:36.134575 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> executeQuery: (from 127.0.0.1:39336, user: tiara, initial_query_id: d9785b1c-0fe4-4a0f-aae5-e1f460f0c211) SELECT topK(10)(term) FROM default.log_shard WHERE ((toYYYYMMDD(time) >= 20190801) AND (toYYYYMMDD(time) <= 20190901)) AND (code = 'svc1') AND (user_id IN ((SELECT user_id FROM log_shard WHERE ((toYYYYMMDD(time) >= 20190801) AND (toYYYYMMDD(time) <= 20190801)) AND (term = 'product_A') AND (code = 'svc1')) AS _subquery2462)) AND isNotNull(term)                                                                                                       
2019.11.04 11:15:36.136132 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> InterpreterSelectQuery: MergeTreeWhereOptimizer: condition "isNotNull(term)" moved to PREWHERE                                                                                                                                              
2019.11.04 11:15:36.137915 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> InterpreterSelectQuery: MergeTreeWhereOptimizer: condition "term = 'product_A'" moved to PREWHERE                                                                                                                                           
2019.11.04 11:15:36.143438 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> default.log_shard (SelectExecutor): Key condition: unknown, unknown, and, (column 0 in ['svc1', 'svc1']), and, unknown, and, unknown, and                                                                                                   
2019.11.04 11:15:36.143467 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> default.log_shard (SelectExecutor): MinMax index condition: (toYYYYMMDD(column 0) in [20190801, +inf)), (toYYYYMMDD(column 0) in (-inf, 20190901]), and, unknown, and, unknown, and, unknown, and                                           
2019.11.04 11:15:36.161703 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> default.log_shard (SelectExecutor): Selected 94 parts by date, 34 parts by key, 26042 marks to read from 34 ranges                                                                                                                          
2019.11.04 11:15:36.168139 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> default.log_shard (SelectExecutor): Reading approx. 159796644 rows with 16 streams                                                                                                                                                          
2019.11.04 11:15:36.169331 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> InterpreterSelectQuery: FetchColumns -> WithMergeableState                                                                                                                                                                                  
2019.11.04 11:15:36.171163 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> executeQuery: Query pipeline:                                                                                                                                                                                                               
CreatingSets                                                                                                                                                                                                                                                                                                                  
 Lazy                                                                                                                                                                                                                                                                                                                         
 ParallelAggregating                                                                                                                                                                                                                                                                                                          
  Expression Ã— 16                                                                                                                                                                                                                                                                                                             
   Filter                                                                                                                                                                                                                                                                                                                     
    MergeTreeThread                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                              
2019.11.04 11:15:36.171341 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> CreatingSetsBlockInputStream: Creating set.                                                                                                                                                                                                 
2019.11.04 11:15:36.177726 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> default.log_shard (SelectExecutor): Key condition: unknown, unknown, and, (column 0 in ['svc1', 'svc1']), and, unknown, and                                                                                                                 
2019.11.04 11:15:36.177754 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> default.log_shard (SelectExecutor): MinMax index condition: (toYYYYMMDD(column 0) in [20190801, +inf)), (toYYYYMMDD(column 0) in (-inf, 20190801]), and, unknown, and, unknown, and                                                         
2019.11.04 11:15:36.178644 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> default.log_shard (SelectExecutor): Selected 5 parts by date, 1 parts by key, 1068 marks to read from 1 ranges                                                                                                                              
2019.11.04 11:15:36.179248 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> default.log_shard (SelectExecutor): Reading approx. 6090203 rows with 16 streams                                                                                                                                                            
2019.11.04 11:15:36.180534 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> InterpreterSelectQuery: FetchColumns -> Complete                                                                                                                                                                                            
2019.11.04 11:15:36.195212 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> CreatingSetsBlockInputStream: Created. Set with 123 entries from 513 rows. In 0.024 sec.                                                                                                                                                    
2019.11.04 11:15:36.195260 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregating                                                                                                                                                                                            
2019.11.04 11:15:36.202547 [ 323 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.204523 [ 555 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.205395 [ 247 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.207044 [ 609 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.211376 [ 166 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.211986 [ 32 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                  
2019.11.04 11:15:36.212845 [ 531 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.216312 [ 348 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.216425 [ 528 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.218038 [ 24 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                  
2019.11.04 11:15:36.246130 [ 88 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                  
2019.11.04 11:15:36.255793 [ 559 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.261463 [ 25 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                  
2019.11.04 11:15:36.265408 [ 124 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.353716 [ 368 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.425468 [ 146 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Aggregation method: without_key                                                                                                                                                                                                 
2019.11.04 11:15:36.533284 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 20 to 1 rows (from 0.001 MiB) in 0.338 sec. (59.175 rows/sec., 0.002 MiB/sec.)                                                                                                             
2019.11.04 11:15:36.533327 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 4 to 1 rows (from 0.000 MiB) in 0.338 sec. (11.835 rows/sec., 0.000 MiB/sec.)                                                                                                              
2019.11.04 11:15:36.533338 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 20 to 1 rows (from 0.000 MiB) in 0.338 sec. (59.175 rows/sec., 0.001 MiB/sec.)                                                                                                             
2019.11.04 11:15:36.533348 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 21 to 1 rows (from 0.000 MiB) in 0.338 sec. (62.133 rows/sec., 0.001 MiB/sec.)                                                                                                             
2019.11.04 11:15:36.533359 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 19 to 1 rows (from 0.000 MiB) in 0.338 sec. (56.216 rows/sec., 0.001 MiB/sec.)                                                                                                             
2019.11.04 11:15:36.533369 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 37 to 1 rows (from 0.001 MiB) in 0.338 sec. (109.473 rows/sec., 0.002 MiB/sec.)                                                                                                            
2019.11.04 11:15:36.533380 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 77 to 1 rows (from 0.002 MiB) in 0.338 sec. (227.822 rows/sec., 0.005 MiB/sec.)                                                                                                            
2019.11.04 11:15:36.533389 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 3 to 1 rows (from 0.000 MiB) in 0.338 sec. (8.876 rows/sec., 0.000 MiB/sec.)                                                                                                               
2019.11.04 11:15:36.533400 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 98 to 1 rows (from 0.002 MiB) in 0.338 sec. (289.955 rows/sec., 0.006 MiB/sec.)                                                                                                            
2019.11.04 11:15:36.533410 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 130 to 1 rows (from 0.003 MiB) in 0.338 sec. (384.634 rows/sec., 0.008 MiB/sec.)                                                                                                           
2019.11.04 11:15:36.533420 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 74 to 1 rows (from 0.002 MiB) in 0.338 sec. (218.946 rows/sec., 0.005 MiB/sec.)                                                                                                            
2019.11.04 11:15:36.533430 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 151 to 1 rows (from 0.003 MiB) in 0.338 sec. (446.768 rows/sec., 0.009 MiB/sec.)                                                                                                           
2019.11.04 11:15:36.533440 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 304 to 1 rows (from 0.006 MiB) in 0.338 sec. (899.453 rows/sec., 0.018 MiB/sec.)                                                                                                           
2019.11.04 11:15:36.533450 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 72 to 1 rows (from 0.001 MiB) in 0.338 sec. (213.028 rows/sec., 0.004 MiB/sec.)                                                                                                            
2019.11.04 11:15:36.533460 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 154 to 1 rows (from 0.003 MiB) in 0.338 sec. (455.644 rows/sec., 0.009 MiB/sec.)                                                                                                           
2019.11.04 11:15:36.533469 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Aggregated. 1457 to 1 rows (from 0.026 MiB) in 0.338 sec. (4310.863 rows/sec., 0.077 MiB/sec.)                                                                                                         
2019.11.04 11:15:36.533480 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> ParallelAggregatingBlockInputStream: Total aggregated. 2641 rows (from 0.049 MiB) in 0.338 sec. (7813.995 rows/sec., 0.146 MiB/sec.)                                                                                                        
2019.11.04 11:15:36.533489 [ 574 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> Aggregator: Merging aggregated data                                                                                                                                                                                                         
2019.11.04 11:15:36.533943 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> UnionBlockInputStream: Waiting for threads to finish                                                                                                                                                                                        
2019.11.04 11:15:36.533974 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> UnionBlockInputStream: Waited for threads to finish                                                                                                                                                                                         
2019.11.04 11:15:36.534047 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Information> executeQuery: Read 165886847 rows, 1.72 GiB in 0.399 sec., 415329554 rows/sec., 4.30 GiB/sec.                                                                                                                                         
2019.11.04 11:15:36.534064 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Debug> MemoryTracker: Peak memory usage (for query): 70.94 MiB.                                                                                                                                                                                    
2019.11.04 11:15:36.534197 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> UnionBlockInputStream: Waiting for threads to finish                                                                                                                                                                                        
2019.11.04 11:15:36.534206 [ 758 ] {d805e9d4-757e-4d72-99ba-30e0db75a6dc} <Trace> UnionBlockInputStream: Waited for threads to finish                                                                                                                                                                                         
2019.11.04 11:15:36.542084 [ 836 ] {} <Error> BaseDaemon: ########################################                                                                                                                                                                                                                            
2019.11.04 11:15:36.542179 [ 836 ] {} <Error> BaseDaemon: (version 19.13.1.11) (from thread 758) Received signal Segmentation fault (11).                                                                                                                                                                                     
2019.11.04 11:15:36.542214 [ 836 ] {} <Error> BaseDaemon: Address: 0xfffffffffffffff8 Access: write. Address not mapped to object.                                                                                                                                                                                            
2019.11.04 11:15:36.622428 [ 836 ] {} <Error> BaseDaemon: 0. clickhouse(StackTrace::StackTrace(ucontext const&)+0x30) [0x6f18f20]                                                                                                                                                                                             
1. clickhouse() [0x327aa15]                                                                                                                                                                                                                                                                                                   
2. /lib64/libpthread.so.0(+0xf5d0) [0x7faa047ba5d0]                                                                                                                                                                                                                                                                           
3. clickhouse() [0x5d74373]                                                                                                                                                                                                                                                                                                   
4. clickhouse(std::_Sp_counted_ptr_inplace<DB::ExpressionActions, std::allocator<DB::ExpressionActions>, (__gnu_cxx::_Lock_policy)2>::_M_dispose()+0xcc) [0x5da3fac]                                                                                                                                                          
5. clickhouse(DB::FilterBlockInputStream::~FilterBlockInputStream()+0x849) [0x63aed49]                                                                                                                                                                                                                                        
6. clickhouse(DB::ExpressionBlockInputStream::~ExpressionBlockInputStream()+0x2ca) [0x606bf8a]                                                                                                                                                                                                                                
7. clickhouse(DB::ExpressionBlockInputStream::~ExpressionBlockInputStream()+0x2ca) [0x606bf8a]                                                                                                                                                                                                                                
8. clickhouse(std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release()+0x56) [0x315ae96]                                                                                                                                                                                                                               
9. clickhouse(DB::IBlockInputStream::~IBlockInputStream()+0xa2) [0x31a4c02]                                                                                                                                                                                                                                                   
10. clickhouse(DB::UnionBlockInputStream::~UnionBlockInputStream()+0x2a5) [0x5da7595]                                                                                                                                                                                                                                         
11. clickhouse(std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release()+0x56) [0x315ae96]                                                                                                                                                                                                                              
12. clickhouse(DB::IBlockInputStream::~IBlockInputStream()+0xa2) [0x31a4c02]                                                                                                                                                                                                                                                  
13. clickhouse(DB::CreatingSetsBlockInputStream::~CreatingSetsBlockInputStream()+0x5ba) [0x639184a]                                                                                                                                                                                                                           
14. clickhouse(std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release()+0x56) [0x315ae96]                                                                                                                                                                                                                              
15. clickhouse(DB::ProcessListEntry::~ProcessListEntry()+0xb5) [0x5e2aa55]                                                                                                                                                                                                                                                    
16. clickhouse(std::_Sp_counted_base<(__gnu_cxx::_Lock_policy)2>::_M_release()+0x56) [0x315ae96]                                                                                                                                                                                                                              
17. clickhouse(DB::BlockIO::operator=(DB::BlockIO const&)+0x75) [0x31a7805]                                                                                                                                                                                                                                                   
18. clickhouse(DB::QueryState::reset()+0x192) [0x31a7bf2]                                                                                                                                                                                                                                                                     
19. clickhouse(DB::TCPHandler::runImpl()+0x723) [0x31a0163]                                                                                                                                                                                                                                                                   
20. clickhouse(DB::TCPHandler::run()+0x1c) [0x31a176c]                                                                                                                                                                                                                                                                        
21. clickhouse(Poco::Net::TCPServerConnection::start()+0xf) [0x6a5e54f]                                                                                                                                                                                                                                                       
22. clickhouse(Poco::Net::TCPServerDispatcher::run()+0x166) [0x6a5e916]                                                                                                                                                                                                                                                       
23. clickhouse(Poco::PooledThread::run()+0x77) [0x70ede07]                                                                                                                                                                                                                                                                    
24. clickhouse(Poco::ThreadImpl::runnableEntry(void*)+0x38) [0x70e9fc8]                                                                                                                                                                                                                                                       
25. clickhouse() [0x76bbfff]                                                                                                                                                                                                                                                                                                  
26. /lib64/libpthread.so.0(+0x7dd5) [0x7faa047b2dd5]                                                                                                                                                                                                                                                                          
27. /lib64/libc.so.6(clone+0x6d) [0x7faa041d9ead]                                                                                                                                                                                                                                                                             
```

