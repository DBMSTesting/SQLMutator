ID: 5614
Title: Clickhouse-server crashed when executed a select query with "WITH TOTALS"
Description:
**Describe the bug**
When I executed a select query, Clickhouse-server crashed.

**Version**
18.14.19

**Query**
```
SELECT 
    sum(cnt) AS total, 
    k[1], 
    k[2]
FROM 
(
    SELECT 
        count() AS cnt, 
        k
    FROM tiaralog 
    ARRAY JOIN [['', ''], [common_section, ''], [common_section, common_page]] AS k
    WHERE (toYYYYMMDD(batched_common_request_time) = 20190611) AND (common_service_code = 'gift') AND (action_type = 'Pageview')
    GROUP BY k
    SETTINGS distributed_group_by_no_merge = 1, max_threads = 100, max_execution_time = 120
) 
GROUP BY k
    WITH TOTALS
ORDER BY total DESC
SETTINGS max_threads = 100, max_execution_time = 120                                                       
```

**Error log**
```
2019.06.14 14:27:07.982390 [ 152328 ] {} <Trace> HTTPHandler-factory: HTTP Request for HTTPHandler-factory. Method: POST, Address: 172.26.109.231:52754, User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.1 Safari/605.1.15, Length: 578                                                                     
2019.06.14 14:27:07.982469 [ 152328 ] {} <Trace> HTTPHandler: Request URI: /?add_http_cors_header=1&log_queries=1&output_format_json_quote_64bit_integers=1&output_format_json_quote_denormals=1&user=default&database=default&result_overflow_mode=throw&max_result_rows=5000&timeout_overflow_mode=throw&max_execution_time=5                                             
2019.06.14 14:27:07.983077 [ 152328 ] {229a5db8-fdd2-4b3e-822a-beab6329f3b0} <Debug> executeQuery: (from 172.26.109.231:52754)  /*TABIX_QUERY_ID_MkepXeY2*/ SELECT sum(cnt) as total, k[1], k[2] FROM (     SELECT count() as cnt, k     FROM tiaralog      ARRAY JOIN [        ['', ''],        [common_section, ''],       [common_section, common_page]     ] as k       
WHERE toYYYYMMDD(batched_common_request_time) = 20190611 and common_service_code = 'gift' and action_type = 'Pageview'     GROUP BY k      SETTINGS distributed_group_by_no_merge = 1, max_threads = 100, max_execution_time = 120 )  group by k with TOTALS order by total desc SETTINGS max_threads = 100, max_execution_time = 120    FORMAT JSON                        

2019.06.14 14:27:08.162334 [ 152328 ] {229a5db8-fdd2-4b3e-822a-beab6329f3b0} <Trace> InterpreterSelectQuery: FetchColumns -> Complete                                                                                                                                                                                                                                       
2019.06.14 14:27:08.170844 [ 152328 ] {229a5db8-fdd2-4b3e-822a-beab6329f3b0} <Trace> InterpreterSelectQuery: Complete -> Complete                                                                                                                                                                                                                                           
2019.06.14 14:27:08.170882 [ 152328 ] {229a5db8-fdd2-4b3e-822a-beab6329f3b0} <Trace> InterpreterSelectQuery: FetchColumns -> Complete                                                                                                                                                                                                                                       
2019.06.14 14:27:08.171084 [ 356082 ] {} <Trace> SystemLog (system.query_log): Flushing system log                                                                                                                                                                                                                                                                          
2019.06.14 14:27:08.175019 [ 356082 ] {} <Trace> system.query_log (Data): Renaming temporary part tmp_insert_201906_392_392_0 to 201906_392_392_0.                                                                                                                                                                                                                          
2019.06.14 14:27:08.178983 [ 152328 ] {229a5db8-fdd2-4b3e-822a-beab6329f3b0} <Debug> executeQuery: Query pipeline:                                                                                                                                                                                                                                                          
Expression                                                                                                                                                                                                                                                                                                                                                                  
 MergeSorting                                                                                                                                                                                                                                                                                                                                                               
  PartialSorting                                                                                                                                                                                                                                                                                                                                                            
   Expression                                                                                                                                                                                                                                                                                                                                                               
    TotalsHaving                                                                                                                                                                                                                                                                                                                                                            
     ParallelAggregating                                                                                                                                                                                                                                                                                                                                                    
      Expression                                                                                                                                                                                                                                                                                                                                                            
       Materializing                                                                                                                                                                                                                                                                                                                                                        
        Expression                                                                                                                                                                                                                                                                                                                                                          
         Expression                                                                                                                                                                                                                                                                                                                                                         
          ParallelAggregating                                                                                                                                                                                                                                                                                                                                               
           Expression × 100                                                                                                                                                                                                                                                                                                                                                 
            Filter                                                                                                                                                                                                                                                                                                                                                          
             Converting                                                                                                                                                                                                                                                                                                                                                     
              MergeTreeThread                                                                                                                                                                                                                                                                                                                                               
      Expression × 9                                                                                                                                                                                                                                                                                                                                                        
       Remote                                                                                                                                                                                                                                                                                                                                                               


2019.06.14 14:27:08.766671 [ 2 ] {} <Error> BaseDaemon: ########################################                                                                                                                                                                                                                                                                            
2019.06.14 14:27:08.766732 [ 2 ] {} <Error> BaseDaemon: (from thread 152328) Received signal Segmentation fault (11).                                                                                                                                                                                                                                                       
2019.06.14 14:27:08.766751 [ 2 ] {} <Error> BaseDaemon: Address: NULL pointer.                                                                                                                                                                                                                                                                                              
2019.06.14 14:27:08.766760 [ 2 ] {} <Error> BaseDaemon: Access: read.                                                                                                                                                                                                                                                                                                       
2019.06.14 14:27:08.766768 [ 2 ] {} <Error> BaseDaemon: Address not mapped to object.                                                                                                                                                                                                                                                                                       
2019.06.14 14:27:08.805019 [ 2 ] {} <Error> BaseDaemon: 0. clickhouse(DB::DataTypeNullable::serializeTextJSON(DB::IColumn const&, unsigned long, DB::WriteBuffer&, DB::FormatSettings const&) const+0x2b) [0x4c629fb]                                                                                                                                                       
2019.06.14 14:27:08.805054 [ 2 ] {} <Error> BaseDaemon: 1. clickhouse(DB::JSONRowOutputStream::writeTotals()+0x3ec) [0x5a126dc]                                                                                                                                                                                                                                             
2019.06.14 14:27:08.805068 [ 2 ] {} <Error> BaseDaemon: 2. clickhouse(DB::JSONRowOutputStream::writeSuffix()+0xac) [0x5a144ac]                                                                                                                                                                                                                                              
2019.06.14 14:27:08.805081 [ 2 ] {} <Error> BaseDaemon: 3. clickhouse(DB::copyData(DB::IBlockInputStream&, DB::IBlockOutputStream&, std::atomic<bool>*)+0x51a) [0x4be9afa]                                                                                                                                                                                                  
2019.06.14 14:27:08.805109 [ 2 ] {} <Error> BaseDaemon: 4. clickhouse(DB::executeQuery(DB::ReadBuffer&, DB::WriteBuffer&, bool, DB::Context&, std::function<void (std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&)>)+0x540) [0x5790330]                                                                                              
2019.06.14 14:27:08.805126 [ 2 ] {} <Error> BaseDaemon: 5. clickhouse(DB::HTTPHandler::processQuery(Poco::Net::HTTPServerRequest&, HTMLForm&, Poco::Net::HTTPServerResponse&, DB::HTTPHandler::Output&)+0x316c) [0x2a7f1ac]                                                                                                                                                 
2019.06.14 14:27:08.805137 [ 2 ] {} <Error> BaseDaemon: 6. clickhouse(DB::HTTPHandler::handleRequest(Poco::Net::HTTPServerRequest&, Poco::Net::HTTPServerResponse&)+0x3b4) [0x2a817e4]                                                                                                                                                                                      
2019.06.14 14:27:08.805148 [ 2 ] {} <Error> BaseDaemon: 7. clickhouse(Poco::Net::HTTPServerConnection::run()+0x332) [0x6073f82]                                                                                                                                                                                                                                             
2019.06.14 14:27:08.805158 [ 2 ] {} <Error> BaseDaemon: 8. clickhouse(Poco::Net::TCPServerConnection::start()+0xf) [0x606c82f]                                                                                                                                                                                                                                              
2019.06.14 14:27:08.805168 [ 2 ] {} <Error> BaseDaemon: 9. clickhouse(Poco::Net::TCPServerDispatcher::run()+0x16a) [0x606cc0a]                                                                                                                                                                                                                                              
2019.06.14 14:27:08.805178 [ 2 ] {} <Error> BaseDaemon: 10. clickhouse(Poco::PooledThread::run()+0x77) [0x6188ee7]                                                                                                                                                                                                                                                          
2019.06.14 14:27:08.805188 [ 2 ] {} <Error> BaseDaemon: 11. clickhouse(Poco::ThreadImpl::runnableEntry(void*)+0x38) [0x61848e8]                                                                                                                                                                                                                                             
2019.06.14 14:27:08.805197 [ 2 ] {} <Error> BaseDaemon: 12. clickhouse() [0x68d4dff]                                                                                                                                                                                                                                                                                        
2019.06.14 14:27:08.805206 [ 2 ] {} <Error> BaseDaemon: 13. /lib/x86_64-linux-gnu/libpthread.so.0(+0x76db) [0x7f183d31e6db]                                                                                                                                                                                                                                                                       
```