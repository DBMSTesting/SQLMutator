ID: 45194
Title: Logical error/segfault in KeeperMap on unexpected column type
Description:
```
dell9510 :) create table map (`key` String, `value` UInt32) ENGINE = KeeperMap('/test/keeper/map') PRIMARY KEY key
dell9510 :) insert into map select * from generateRandom('`key` String, `value` UInt32') limit 100
dell9510 :) select * from map where key in (select number * 5 from numbers(1000))
[dell9510] 2023.01.11 20:09:42.148059 [ 268531 ] {97575264-49fa-4e84-819e-25b18c66caae} <Fatal> : Logical error: 'Invalid Field get from type UInt64 to type String'.
[dell9510] 2023.01.11 20:09:42.150371 [ 268618 ] <Fatal> BaseDaemon: ########################################
[dell9510] 2023.01.11 20:09:42.150880 [ 268618 ] <Fatal> BaseDaemon: (version 22.13.1.1, build id: 547A05EA23D6B49325985504D4E89ABC6781B585) (from thread 268531) (query_id: 97575264-49fa-4e84-819e-25b18c66caae) (query: select * from map where key in (select number * 5 from numbers(1000))) Received signal Aborted (6)
[dell9510] 2023.01.11 20:09:42.151311 [ 268618 ] <Fatal> BaseDaemon: 
[dell9510] 2023.01.11 20:09:42.151517 [ 268618 ] <Fatal> BaseDaemon: Stack trace: 0x7ff8435fc64c 0x7ff8435ac958 0x7ff84359653d 0x22f0b017 0x22f0b0d5 0x22f0b232 0x194dbe37 0x1953a0c7 0x19dc149f 0x19dc135d 0x2ac44931 0x2ccb0dbf 0x2d21d039 0x2db2d0a0 0x2db2cd78 0x2db77290 0x2db76f69 0x2db4fc5e 0x2db50004 0x2db4ee27 0x2db4e505 0x2db7ef32 0x2db7edad 0x2db7ed35 0x2db7ece1 0x2db7ebf2 0x2db7eac8 0x2db7e9d5 0x2db7e99d 0x2db7e975 0x2db7e940 0x22f68366 0x22f636b5 0x2306ca73 0x23074591 0x23074515 0x23074445 0x23073d4f 0x7ff8435fa8fd 0x7ff84367ca60
[dell9510] 2023.01.11 20:09:42.151768 [ 268618 ] <Fatal> BaseDaemon: 4. ? @ 0x7ff8435fc64c in ?
[dell9510] 2023.01.11 20:09:42.151904 [ 268618 ] <Fatal> BaseDaemon: 5. gsignal @ 0x7ff8435ac958 in ?
[dell9510] 2023.01.11 20:09:42.152040 [ 268618 ] <Fatal> BaseDaemon: 6. abort @ 0x7ff84359653d in ?
[dell9510] 2023.01.11 20:09:42.221528 [ 268618 ] <Fatal> BaseDaemon: 7. /home/tavplubix/ch/ClickHouse/src/Common/Exception.cpp:41: DB::abortOnFailedAssertion(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) @ 0x22f0b017 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:42.289485 [ 268618 ] <Fatal> BaseDaemon: 8. /home/tavplubix/ch/ClickHouse/src/Common/Exception.cpp:64: DB::handle_error_code(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, int, bool, std::__1::vector<void*, std::__1::allocator<void*>> const&) @ 0x22f0b0d5 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:42.347027 [ 268618 ] <Fatal> BaseDaemon: 9. /home/tavplubix/ch/ClickHouse/src/Common/Exception.cpp:78: DB::Exception::Exception(DB::Exception::MessageMasked const&, int, bool) @ 0x22f0b232 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:42.412669 [ 268618 ] <Fatal> BaseDaemon: 10. /home/tavplubix/ch/ClickHouse/src/Common/Exception.h:41: DB::Exception::Exception(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, int, bool) @ 0x194dbe37 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.034373 [ 268618 ] <Fatal> BaseDaemon: 11. /home/tavplubix/ch/ClickHouse/src/Common/Exception.h:50: DB::Exception::Exception<DB::Field::Types::Which&, DB::Field::Types::Which const&>(int, fmt::v8::basic_format_string<char, fmt::v8::type_identity<DB::Field::Types::Which&>::type, fmt::v8::type_identity<DB::Field::Types::Which const&>::type>, DB::Field::Types::Which&, DB::Field::Types::Which const&) @ 0x1953a0c7 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.093839 [ 268618 ] <Fatal> BaseDaemon: 12. /home/tavplubix/ch/ClickHouse/src/Core/Field.h:832: DB::NearestFieldTypeImpl<std::__1::decay<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&>::type, void>::Type& DB::Field::get<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&>() @ 0x19dc149f in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.162357 [ 268618 ] <Fatal> BaseDaemon: 13. /home/tavplubix/ch/ClickHouse/src/Core/Field.h:427: auto const& DB::Field::get<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&>() const @ 0x19dc135d in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.197441 [ 268618 ] <Fatal> BaseDaemon: 14. /home/tavplubix/ch/ClickHouse/src/DataTypes/Serializations/SerializationString.cpp:33: DB::SerializationString::serializeBinary(DB::Field const&, DB::WriteBuffer&, DB::FormatSettings const&) const @ 0x2ac44931 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.265643 [ 268618 ] <Fatal> BaseDaemon: 15. /home/tavplubix/ch/ClickHouse/src/Storages/KVStorageUtils.cpp:143: DB::serializeKeysToRawString(std::__1::__wrap_iter<DB::Field const*>&, std::__1::__wrap_iter<DB::Field const*>, std::__1::shared_ptr<DB::IDataType const>, unsigned long) @ 0x2ccb0dbf in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.535808 [ 268618 ] <Fatal> BaseDaemon: 16. /home/tavplubix/ch/ClickHouse/src/Storages/StorageKeeperMap.cpp:221: DB::StorageKeeperMapSource<std::__1::vector<DB::Field, AllocatorWithMemoryTracking<DB::Field>>>::generate() @ 0x2d21d039 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.585188 [ 268618 ] <Fatal> BaseDaemon: 17. /home/tavplubix/ch/ClickHouse/src/Processors/ISource.cpp:124: DB::ISource::tryGenerate() @ 0x2db2d0a0 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.633360 [ 268618 ] <Fatal> BaseDaemon: 18. /home/tavplubix/ch/ClickHouse/src/Processors/ISource.cpp:94: DB::ISource::work() @ 0x2db2cd78 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.658329 [ 268618 ] <Fatal> BaseDaemon: 19. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/ExecutionThreadContext.cpp:47: DB::executeJob(DB::ExecutingGraph::Node*, DB::ReadProgressCallback*) @ 0x2db77290 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.681818 [ 268618 ] <Fatal> BaseDaemon: 20. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/ExecutionThreadContext.cpp:92: DB::ExecutionThreadContext::executeTask() @ 0x2db76f69 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.750505 [ 268618 ] <Fatal> BaseDaemon: 21. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PipelineExecutor.cpp:229: DB::PipelineExecutor::executeStepImpl(unsigned long, std::__1::atomic<bool>*) @ 0x2db4fc5e in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.817582 [ 268618 ] <Fatal> BaseDaemon: 22. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PipelineExecutor.cpp:195: DB::PipelineExecutor::executeSingleThread(unsigned long) @ 0x2db50004 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.880736 [ 268618 ] <Fatal> BaseDaemon: 23. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PipelineExecutor.cpp:372: DB::PipelineExecutor::executeImpl(unsigned long) @ 0x2db4ee27 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:43.948943 [ 268618 ] <Fatal> BaseDaemon: 24. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PipelineExecutor.cpp:90: DB::PipelineExecutor::execute(unsigned long) @ 0x2db4e505 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.041188 [ 268618 ] <Fatal> BaseDaemon: 25. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:83: DB::threadFunction(DB::PullingAsyncPipelineExecutor::Data&, std::__1::shared_ptr<DB::ThreadGroupStatus>, unsigned long) @ 0x2db7ef32 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.105738 [ 268618 ] <Fatal> BaseDaemon: 26. /home/tavplubix/ch/ClickHouse/src/Processors/Executors/PullingAsyncPipelineExecutor.cpp:111: DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0::operator()() const @ 0x2db7edad in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.168929 [ 268618 ] <Fatal> BaseDaemon: 27. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394: decltype(std::declval<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&>()()) std::__1::__invoke[abi:v15000]<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&) @ 0x2db7ed35 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.232815 [ 268618 ] <Fatal> BaseDaemon: 28. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/tuple:1789: decltype(auto) std::__1::__apply_tuple_impl[abi:v15000]<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&, std::__1::__tuple_indices<>) @ 0x2db7ece1 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.298127 [ 268618 ] <Fatal> BaseDaemon: 29. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/tuple:1798: decltype(auto) std::__1::apply[abi:v15000]<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&, std::__1::tuple<>&) @ 0x2db7ebf2 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.351909 [ 268618 ] <Fatal> BaseDaemon: 30. /home/tavplubix/ch/ClickHouse/src/Common/ThreadPool.h:196: ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()::operator()() @ 0x2db7eac8 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.415349 [ 268618 ] <Fatal> BaseDaemon: 31. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394: decltype(std::declval<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>()()) std::__1::__invoke[abi:v15000]<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&) @ 0x2db7e9d5 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.478167 [ 268618 ] <Fatal> BaseDaemon: 32. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:480: void std::__1::__invoke_void_return_wrapper<void, true>::__call<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&>(ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'()&) @ 0x2db7e99d in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.541032 [ 268618 ] <Fatal> BaseDaemon: 33. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:235: std::__1::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'(), void ()>::operator()[abi:v15000]() @ 0x2db7e975 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.606001 [ 268618 ] <Fatal> BaseDaemon: 34. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:716: void std::__1::__function::__policy_invoker<void ()>::__call_impl<std::__1::__function::__default_alloc_func<ThreadFromGlobalPoolImpl<true>::ThreadFromGlobalPoolImpl<DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0>(DB::PullingAsyncPipelineExecutor::pull(DB::Chunk&, unsigned long)::$_0&&)::'lambda'(), void ()>>(std::__1::__function::__policy_storage const*) @ 0x2db7e940 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.641559 [ 268618 ] <Fatal> BaseDaemon: 35. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:848: std::__1::__function::__policy_func<void ()>::operator()[abi:v15000]() const @ 0x22f68366 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.680774 [ 268618 ] <Fatal> BaseDaemon: 36. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/function.h:1187: std::__1::function<void ()>::operator()() const @ 0x22f636b5 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.746593 [ 268618 ] <Fatal> BaseDaemon: 37. /home/tavplubix/ch/ClickHouse/src/Common/ThreadPool.cpp:295: ThreadPoolImpl<std::__1::thread>::worker(std::__1::__list_iterator<std::__1::thread, void*>) @ 0x2306ca73 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.797682 [ 268618 ] <Fatal> BaseDaemon: 38. /home/tavplubix/ch/ClickHouse/src/Common/ThreadPool.cpp:144: void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, long, std::__1::optional<unsigned long>, bool)::'lambda0'()::operator()() const @ 0x23074591 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.849261 [ 268618 ] <Fatal> BaseDaemon: 39. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/__functional/invoke.h:394: decltype(std::declval<void>()()) std::__1::__invoke[abi:v15000]<void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, long, std::__1::optional<unsigned long>, bool)::'lambda0'()>(void&&) @ 0x23074515 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.902040 [ 268618 ] <Fatal> BaseDaemon: 40. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/thread:285: void std::__1::__thread_execute[abi:v15000]<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, long, std::__1::optional<unsigned long>, bool)::'lambda0'()>(std::__1::tuple<void, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, long, std::__1::optional<unsigned long>, bool)::'lambda0'()>&, std::__1::__tuple_indices<>) @ 0x23074445 in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.956041 [ 268618 ] <Fatal> BaseDaemon: 41. /home/tavplubix/ch/ClickHouse/contrib/llvm-project/libcxx/include/thread:295: void* std::__1::__thread_proxy[abi:v15000]<std::__1::tuple<std::__1::unique_ptr<std::__1::__thread_struct, std::__1::default_delete<std::__1::__thread_struct>>, void ThreadPoolImpl<std::__1::thread>::scheduleImpl<void>(std::__1::function<void ()>, long, std::__1::optional<unsigned long>, bool)::'lambda0'()>>(void*) @ 0x23073d4f in /home/tavplubix/ch/ClickHouse/cmake-build-debug/programs/clickhouse
[dell9510] 2023.01.11 20:09:44.956312 [ 268618 ] <Fatal> BaseDaemon: 42. ? @ 0x7ff8435fa8fd in ?
[dell9510] 2023.01.11 20:09:44.956481 [ 268618 ] <Fatal> BaseDaemon: 43. ? @ 0x7ff84367ca60 in ?
[dell9510] 2023.01.11 20:09:44.956627 [ 268618 ] <Fatal> BaseDaemon: Integrity check of the executable skipped because the reference checksum could not be read.
â†‘ Progress: 1.00 thousand rows, 8.00 KB (50.01 rows/s., 400.06 B/s.)  99%Exception on client:
Code: 32. DB::Exception: Attempt to read after eof: while receiving packet from localhost:9000. (ATTEMPT_TO_READ_AFTER_EOF)

```

It also can lead to a segfault like this (originally reported to sentry): https://pastila.nl/?00e3ff17/0c86a530fc7f647af612f6691434d13e

cc: @antonio2368 