ID: 42008
Title: DATA RACE at the UnistoreRPCClientSendHook
Description:
## Bug Report

Please answer these questions before submitting your issue. Thanks!

### 1. Minimal reproduce step (Required)

<!-- a step by step guide for reproducing the bug. -->

### 2. What did you expect to see? (Required)

### 3. What did you see instead (Required)
```
==================
WARNING: DATA RACE
Write at 0x00000af90d28 by goroutine 46895:
  github.com/pingcap/tidb/server.setupForTestTopSQLStatementStats()
      server/tidb_test.go:2076 +0x764
  github.com/pingcap/failpoint.parseTerm()
      external/com_github_pingcap_failpoint/terms.go:149 +0x389
  github.com/pingcap/failpoint.parse()
      external/com_github_pingcap_failpoint/terms.go:126 +0xad
  github.com/pingcap/failpoint.newTerms()
      external/com_github_pingcap_failpoint/terms.go:98 +0x50
  github.com/pingcap/failpoint.(*Failpoint).Enable()
      external/com_github_pingcap_failpoint/failpoint.go:54 +0x44
  github.com/pingcap/failpoint.(*Failpoints).Enable()
      external/com_github_pingcap_failpoint/failpoints.go:105 +0x276
  github.com/pingcap/failpoint.Enable()
      external/com_github_pingcap_failpoint/failpoints.go:222 +0x408
  github.com/pingcap/tidb/server.setupForTestTopSQLStatementStats()
      server/tidb_test.go:2057 +0x409
  github.com/pingcap/failpoint.parseTerm()
      external/com_github_pingcap_failpoint/terms.go:149 +0x389
  github.com/pingcap/failpoint.parse()
      external/com_github_pingcap_failpoint/terms.go:126 +0xad
  github.com/pingcap/failpoint.newTerms()
      external/com_github_pingcap_failpoint/terms.go:98 +0x50
  github.com/pingcap/failpoint.(*Failpoint).Enable()
      external/com_github_pingcap_failpoint/failpoint.go:54 +0x44
  github.com/pingcap/failpoint.(*Failpoints).Enable()
      external/com_github_pingcap_failpoint/failpoints.go:105 +0x276
  github.com/pingcap/failpoint.Enable()
      external/com_github_pingcap_failpoint/failpoints.go:222 +0x3be
  github.com/pingcap/tidb/server.setupForTestTopSQLStatementStats()
      server/tidb_test.go:2056 +0x3bf
  github.com/pingcap/tidb/domain.(*Domain).rebuildSysVarCache()
      domain/sysvar_cache.go:146 +0x7c4
  github.com/pingcap/tidb/domain.(*Domain).LoadSysVarCacheLoop()
      domain/domain.go:1470 +0xb9
  github.com/pingcap/tidb/session.BootstrapSession()
      session/session.go:3319 +0x7cc
  github.com/pingcap/tidb/domain.(*Domain).GetSessionCache()
      domain/sysvar_cache.go:62 +0x71
  github.com/pingcap/tidb/session.(*session).loadCommonGlobalVariablesIfNeeded()
      session/session.go:3661 +0x11e
  github.com/pingcap/tidb/session.(*session).ExecuteStmt()
      session/session.go:2098 +0x16b
  github.com/pingcap/tidb/session.(*session).ExecuteInternal()
      session/session.go:1628 +0x365
  github.com/pingcap/tidb/domain.(*Domain).LoadPrivilegeLoop()
      domain/domain.go:1414 +0x143
  github.com/pingcap/tidb/session.BootstrapSession()
      session/session.go:3312 +0x76c
  github.com/pingcap/tidb/server.createTidbTestSuiteWithCfg()
      server/tidb_test.go:102 +0x219
  github.com/pingcap/tidb/server.createTidbTestSuite()
      server/tidb_test.go:91 +0xc5
  github.com/pingcap/tidb/server.setupForTestTopSQLStatementStats()
      server/tidb_test.go:2047 +0x244
  github.com/pingcap/tidb/server.TestTopSQLStatementStats4()
      server/tidb_test.go:2294 +0x4a
  testing.tRunner()
      GOROOT/src/testing/testing.go:1576 +0x216
  testing.(*T).Run.func1()
      GOROOT/src/testing/testing.go:1629 +0x47

Previous read at 0x00000af90d28 by goroutine 93279:
  github.com/pingcap/tidb/store/mockstore/unistore.(*RPCClient).SendRequest()
      store/mockstore/unistore/rpc.go:71 +0x231
  github.com/pingcap/tidb/store/mockstore.(*clientRedirector).SendRequest()
      store/mockstore/redirector.go:72 +0x1c6
  github.com/tikv/client-go/v2/tikv.(*CodecClient).SendRequest()
      external/com_github_tikv_client_go_v2/tikv/test_util.go:60 +0xfb
  github.com/tikv/client-go/v2/internal/client.interceptedClient.SendRequest.func1()
      external/com_github_tikv_client_go_v2/internal/client/client_interceptor.go:58 +0x9d
  github.com/pingcap/tidb/util/topsql/stmtstats.(*KvExecCounter).RPCInterceptor.func1.1()
      util/topsql/stmtstats/kv_exec_count.go:57 +0xb1
  github.com/tikv/client-go/v2/internal/client.interceptedClient.SendRequest()
      external/com_github_tikv_client_go_v2/internal/client/client_interceptor.go:59 +0x230
  github.com/tikv/client-go/v2/internal/client.(*interceptedClient).SendRequest()
      <autogenerated>:1 +0xae
  github.com/tikv/client-go/v2/internal/client.reqCollapse.SendRequest()
      external/com_github_tikv_client_go_v2/internal/client/client_collapse.go:74 +0x130
  github.com/tikv/client-go/v2/internal/client.(*reqCollapse).SendRequest()
      <autogenerated>:1 +0xae
  github.com/tikv/client-go/v2/internal/locate.(*RegionRequestSender).sendReqToRegion()
      external/com_github_tikv_client_go_v2/internal/locate/region_request.go:1321 +0x11b8
  github.com/tikv/client-go/v2/internal/locate.(*RegionRequestSender).SendReqCtx()
      external/com_github_tikv_client_go_v2/internal/locate/region_request.go:1143 +0x1cc5
  github.com/tikv/client-go/v2/txnkv/txnsnapshot.(*ClientHelper).SendReqCtx()
      external/com_github_tikv_client_go_v2/txnkv/txnsnapshot/client_helper.go:146 +0x373
  github.com/pingcap/tidb/store/copr.(*copIteratorWorker).handleTaskOnce()
      store/copr/coprocessor.go:1158 +0x1194
  github.com/pingcap/tidb/store/copr.(*copIteratorWorker).handleTask()
      store/copr/coprocessor.go:1078 +0x224
  github.com/pingcap/tidb/store/copr.(*copIteratorWorker).run()
      store/copr/coprocessor.go:774 +0x1e4
  github.com/pingcap/tidb/store/copr.(*copIterator).open.func1()
      store/copr/coprocessor.go:818 +0x58

Goroutine 46895 (running) created at:
  testing.(*T).Run()
      GOROOT/src/testing/testing.go:1629 +0x805
  testing.runTests.func1()
      GOROOT/src/testing/testing.go:2036 +0x8d
  testing.tRunner()
      GOROOT/src/testing/testing.go:1576 +0x216
  testing.runTests()
      GOROOT/src/testing/testing.go:2034 +0x87c
  testing.(*M).Run()
      GOROOT/src/testing/testing.go:1906 +0xb44
  go.uber.org/goleak.VerifyTestMain()
      external/org_uber_go_goleak/testmain.go:53 +0x70
  github.com/pingcap/tidb/server.TestMain()
      server/main_test.go:74 +0xe59
  main.main()
      bazel-out/k8-fastbuild/bin/server/server_test_/testmain.go:424 +0x7ce

Goroutine 93279 (running) created at:
  github.com/pingcap/tidb/store/copr.(*copIterator).open()
      store/copr/coprocessor.go:818 +0x11d
  github.com/pingcap/tidb/store/copr.(*CopClient).Send()
      store/copr/coprocessor.go:99 +0x36e
  github.com/pingcap/tidb/distsql.Select()
      distsql/distsql.go:99 +0x88d
  github.com/pingcap/tidb/distsql.SelectWithRuntimeStats()
      distsql/distsql.go:140 +0xcc
  github.com/pingcap/tidb/executor.selectResultHook.SelectResult()
      executor/table_reader.go:58 +0x204
  github.com/pingcap/tidb/executor.(*TableReaderExecutor).buildResp()
      executor/table_reader.go:323 +0x7eb
  github.com/pingcap/tidb/executor.(*TableReaderExecutor).Open()
      executor/table_reader.go:220 +0x12b3
  github.com/pingcap/tidb/executor.(*baseExecutor).Open()
      executor/executor.go:202 +0xf5
  github.com/pingcap/tidb/executor.(*HashAggExec).Open()
      executor/aggregate.go:303 +0x233
  github.com/pingcap/tidb/executor.(*baseExecutor).Open()
      executor/executor.go:202 +0xf5
  github.com/pingcap/tidb/executor.(*SelectionExec).Open()
      executor/executor.go:1601 +0x7a
  github.com/pingcap/tidb/executor.(*baseExecutor).Open()
      executor/executor.go:202 +0xf5
  github.com/pingcap/tidb/executor.(*HashAggExec).Open()
      executor/aggregate.go:303 +0x233
  github.com/pingcap/tidb/executor.(*baseExecutor).Open()
      executor/executor.go:202 +0xf5
  github.com/pingcap/tidb/executor.(*HashJoinExec).Open()
      executor/join.go:196 +0x7a
  github.com/pingcap/tidb/executor.(*SortExec).Open()
      executor/sort.go:100 +0x343
  github.com/pingcap/tidb/executor.(*baseExecutor).Open()
      executor/executor.go:202 +0xf5
  github.com/pingcap/tidb/executor.(*ProjectionExec).Open()
      executor/projection.go:86 +0x7a
  github.com/pingcap/tidb/executor.(*ExecStmt).openExecutor()
      executor/adapter.go:1204 +0x109
  github.com/pingcap/tidb/executor.(*ExecStmt).Exec()
      executor/adapter.go:526 +0xbd4
  github.com/pingcap/tidb/session.runStmt()
      session/session.go:2338 +0x701
  github.com/pingcap/tidb/session.(*session).ExecuteStmt()
      session/session.go:2195 +0x12e6
  github.com/pingcap/tidb/session.(*session).ExecuteInternal()
      session/session.go:1628 +0x365
  github.com/pingcap/tidb/ddl.(*session).execute()
      ddl/ddl.go:1656 +0x26d
  github.com/pingcap/tidb/ddl.(*ddl).getJob()
      ddl/job_table.go:113 +0x1f9
  github.com/pingcap/tidb/ddl.(*ddl).getReorgJob()
      ddl/job_table.go:163 +0x7a
  github.com/pingcap/tidb/ddl.(*ddl).getReorgJob-fm()
      <autogenerated>:1 +0x44
  github.com/pingcap/tidb/ddl.(*ddl).loadDDLJobAndRun()
      ddl/job_table.go:225 +0x3e4
  github.com/pingcap/tidb/ddl.(*ddl).startDispatchLoop()
      ddl/job_table.go:210 +0x9ce
  github.com/pingcap/tidb/ddl.(*ddl).startDispatchLoop-fm()
      <autogenerated>:1 +0x39
  github.com/pingcap/tidb/util.(*WaitGroupWrapper).Run.func1()
      util/wait_group_wrapper.go:154 +0x87
==================
```
### 4. What is your TiDB version? (Required)

<!-- Paste the output of SELECT tidb_version() -->

