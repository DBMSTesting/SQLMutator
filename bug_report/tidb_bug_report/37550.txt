ID: 37550
Title: The change of the plan of TPCDS query_40 results in 4s performance regression
Description:
## Bug Report

Please answer these questions before submitting your issue. Thanks!

### 1. Minimal reproduce step (Required)

<!-- a step by step guide for reproducing the bug. -->
1. deploy a TiDB cluster : 1TiDB + 3TiKV + 1PD
2. set global config
```
set global tidb_stats_load_sync_wait=9999;set global tidb_distsql_scan_concurrency = 30;
set global tidb_executor_concurrency = 16;set global tidb_mem_quota_query=84825604096;
```
3. run TPCDS 50g query_40

### 2. What did you expect to see? (Required)
The query would finish around 9s.
```
Plan_Digest: c3bf4e895d9701b494f6a417ca37cec6 Elapsed_Time (s): 9.22 

+------------------------------------------+-------------+----------+-----------+-------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+
| ID                                       | ESTROWS     | ACTROWS  | TASK      | ACCESS OBJECT                                                     | EXECUTION INFO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | OPERATOR INFO                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | MEMORY    | DISK    |
+------------------------------------------+-------------+----------+-----------+-------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+
| Projection_24                            | 100.00      | 100      | root      |                                                                   | time:9.22s, loops:2, Concurrency:OFF                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | tpcds50.warehouse.w_state, tpcds50.item.i_item_id, Column#128, Column#129                                                                                                                                                                                                                                                                                                                                                                                                      | 13.1 KB   | N/A     |
| └─TopN_27                                | 100.00      | 100      | root      |                                                                   | time:9.22s, loops:2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | tpcds50.warehouse.w_state, tpcds50.item.i_item_id, offset:0, count:100                                                                                                                                                                                                                                                                                                                                                                                                         | 38.4 KB   | N/A     |
|   └─HashAgg_32                           | 1937.98     | 3822     | root      |                                                                   | time:9.21s, loops:17, partial_worker:{wall_time:9.212276227s, concurrency:16, task_num:84, tot_wait:2m27.26067239s, tot_exec:118.946947ms, tot_time:2m27.387734049s, max:9.212182575s, p95:9.212182575s}, final_worker:{wall_time:9.215774052s, concurrency:16, task_num:256, tot_wait:2m27.383663515s, tot_exec:48.619477ms, tot_time:2m27.432371637s, max:9.215684711s, p95:9.215684711s}                                                                                                                                                                                                                 | group by:Column#143, Column#144, funcs:sum(Column#139)->Column#128, funcs:sum(Column#140)->Column#129, funcs:firstrow(Column#141)->tpcds50.warehouse.w_state, funcs:firstrow(Column#142)->tpcds50.item.i_item_id                                                                                                                                                                                                                                                               | 18.9 MB   | N/A     |
|     └─Projection_170                     | 153447.94   | 85131    | root      |                                                                   | time:9.21s, loops:85, Concurrency:16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | case(lt(cast(tpcds50.date_dim.d_date, date BINARY), 1998-04-08), minus(tpcds50.catalog_sales.cs_sales_price, coalesce(tpcds50.catalog_returns.cr_refunded_cash, 0)), 0)->Column#139, case(ge(cast(tpcds50.date_dim.d_date, date BINARY), 1998-04-08), minus(tpcds50.catalog_sales.cs_sales_price, coalesce(tpcds50.catalog_returns.cr_refunded_cash, 0)), 0)->Column#140, tpcds50.warehouse.w_state, tpcds50.item.i_item_id, tpcds50.warehouse.w_state, tpcds50.item.i_item_id | 2.31 MB   | N/A     |
|       └─Projection_33                    | 153447.94   | 85131    | root      |                                                                   | time:9.21s, loops:85, Concurrency:16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | tpcds50.catalog_sales.cs_sales_price, tpcds50.catalog_returns.cr_refunded_cash, tpcds50.warehouse.w_state, tpcds50.item.i_item_id, tpcds50.date_dim.d_date                                                                                                                                                                                                                                                                                                                     | 1.82 MB   | N/A     |
|         └─IndexHashJoin_40               | 153447.94   | 85131    | root      |                                                                   | time:9.21s, loops:85, inner:{total:957.4ms, concurrency:16, task:11, construct:133.4ms, fetch:753.4ms, build:26.2ms, join:70.5ms}                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | left outer join, inner:IndexLookUp_37, outer key:tpcds50.catalog_sales.cs_order_number, tpcds50.catalog_sales.cs_item_sk, inner key:tpcds50.catalog_returns.cr_order_number, tpcds50.catalog_returns.cr_item_sk, equal cond:eq(tpcds50.catalog_sales.cs_item_sk, tpcds50.catalog_returns.cr_item_sk), eq(tpcds50.catalog_sales.cs_order_number, tpcds50.catalog_returns.cr_order_number)                                                                                       | 13.0 MB   | N/A     |
|           ├─HashJoin_100(Build)          | 153447.94   | 85131    | root      |                                                                   | time:9.03s, loops:98, build_hash_table:{total:109.3ms, fetch:107.3ms, build:2.03ms}, probe:{concurrency:16, total:2m24.5s, max:9.03s, probe:495.7ms, fetch:2m24s}                                                                                                                                                                                                                                                                                                                                                                                                                                           | inner join, equal:[eq(tpcds50.catalog_sales.cs_item_sk, tpcds50.item.i_item_sk)]                                                                                                                                                                                                                                                                                                                                                                                               | 496.6 KB  | 0 Bytes |
|           │ ├─TableReader_162(Build)     | 3962.90     | 3953     | root      |                                                                   | time:107.6ms, loops:5, cop_task: {num: 5, max: 70ms, min: 6.41ms, avg: 21.7ms, p95: 70ms, max_proc_keys: 30384, p95_proc_keys: 30384, tot_proc: 104ms, tot_wait: 1ms, rpc_num: 5, rpc_time: 108.7ms, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                                                                                                                                                                                                                                                   | data:Selection_161                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 210.7 KB  | N/A     |
|           │ │ └─Selection_161            | 3962.90     | 3953     | cop[tikv] |                                                                   | tikv_task:{proc max:66ms, min:5ms, avg: 20.2ms, p80:66ms, p95:66ms, iters:81, tasks:5}, scan_detail: {total_process_keys: 62000, total_process_keys_size: 21332103, total_keys: 62005, get_snapshot_time: 77µs, rocksdb: {key_skipped_count: 112085, block: {cache_hit_count: 378}}}                                                                                                                                                                                                                                                                                                                        | ge(tpcds50.item.i_current_price, 0.99), le(tpcds50.item.i_current_price, 1.49)                                                                                                                                                                                                                                                                                                                                                                                                 | N/A       | N/A     |
|           │ │   └─TableFullScan_160      | 62000.00    | 62000    | cop[tikv] | table:item                                                        | tikv_task:{proc max:57ms, min:5ms, avg: 18ms, p80:57ms, p95:57ms, iters:81, tasks:5}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|           │ └─HashJoin_139(Probe)        | 2392079.42  | 1379199  | root      |                                                                   | time:9.01s, loops:1355, build_hash_table:{total:79.7ms, fetch:79.6ms, build:51.5µs}, probe:{concurrency:16, total:2m24.5s, max:9.03s, probe:12.6s, fetch:2m11.9s}                                                                                                                                                                                                                                                                                                                                                                                                                                           | inner join, equal:[eq(tpcds50.catalog_sales.cs_sold_date_sk, tpcds50.date_dim.d_date_sk)]                                                                                                                                                                                                                                                                                                                                                                                      | 17.7 KB   | 0 Bytes |
|           │   ├─TableReader_159(Build)   | 61.00       | 61       | root      |                                                                   | time:79.5ms, loops:2, cop_task: {num: 1, max: 81.7ms, proc_keys: 73049, tot_proc: 80ms, tot_wait: 1ms, rpc_num: 1, rpc_time: 81.6ms, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                                                                                                                                                                                                                                                                                                                   | data:Selection_158                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 1.26 KB   | N/A     |
|           │   │ └─Selection_158          | 61.00       | 61       | cop[tikv] |                                                                   | tikv_task:{time:80ms, loops:76}, scan_detail: {total_process_keys: 73049, total_process_keys_size: 14080093, total_keys: 73050, get_snapshot_time: 598.6µs, rocksdb: {key_skipped_count: 73049, block: {cache_hit_count: 232}}}                                                                                                                                                                                                                                                                                                                                                                             | ge(tpcds50.date_dim.d_date, 1998-03-09), le(tpcds50.date_dim.d_date, 1998-05-08)                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|           │   │   └─TableFullScan_157    | 73049.00    | 73049    | cop[tikv] | table:date_dim                                                    | tikv_task:{time:77ms, loops:76}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|           │   └─HashJoin_151(Probe)      | 71278905.29 | 71457604 | root      |                                                                   | time:8.78s, loops:69789, build_hash_table:{total:354.4µs, fetch:340.6µs, build:13.8µs}, probe:{concurrency:16, total:2m24.5s, max:9.03s, probe:2m20.6s, fetch:3.9s}                                                                                                                                                                                                                                                                                                                                                                                                                                         | inner join, equal:[eq(tpcds50.warehouse.w_warehouse_sk, tpcds50.catalog_sales.cs_warehouse_sk)]                                                                                                                                                                                                                                                                                                                                                                                | 25.7 KB   | 0 Bytes |
|           │     ├─TableReader_156(Build) | 7.00        | 7        | root      |                                                                   | time:189µs, loops:2, cop_task: {num: 1, max: 1.54ms, proc_keys: 7, rpc_num: 1, rpc_time: 1.49ms, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                                                                                                                                                                                                                                                                                                                                                       | data:TableFullScan_155                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 409 Bytes | N/A     |
|           │     │ └─TableFullScan_155    | 7.00        | 7        | cop[tikv] | table:warehouse                                                   | tikv_task:{time:0s, loops:1}, scan_detail: {total_process_keys: 7, total_process_keys_size: 1203, total_keys: 8, get_snapshot_time: 733.3µs, rocksdb: {key_skipped_count: 7, block: {cache_hit_count: 2}}}                                                                                                                                                                                                                                                                                                                                                                                                  | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|           │     └─TableReader_154(Probe) | 71278905.29 | 71457604 | root      |                                                                   | time:705.3ms, loops:70484, cop_task: {num: 2942, max: 345.6ms, min: 853.8µs, avg: 38.9ms, p95: 94.3ms, max_proc_keys: 51168, p95_proc_keys: 51168, tot_proc: 1m38.2s, tot_wait: 209ms, rpc_num: 2942, rpc_time: 1m54.3s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                                                                                                                                                                                                                               | data:Selection_153                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 80.5 MB   | N/A     |
|           │       └─Selection_153        | 71278905.29 | 71457604 | cop[tikv] |                                                                   | tikv_task:{proc max:106ms, min:0s, avg: 29.1ms, p80:52ms, p95:74ms, iters:81920, tasks:2942}, scan_detail: {total_process_keys: 71997669, total_process_keys_size: 19979444984, total_keys: 72000611, get_snapshot_time: 52.7ms, rocksdb: {key_skipped_count: 71997669, block: {cache_hit_count: 326538}}}                                                                                                                                                                                                                                                                                                  | not(isnull(tpcds50.catalog_sales.cs_sold_date_sk)), not(isnull(tpcds50.catalog_sales.cs_warehouse_sk))                                                                                                                                                                                                                                                                                                                                                                         | N/A       | N/A     |
|           │         └─TableFullScan_152  | 71997669.00 | 71997669 | cop[tikv] | table:catalog_sales                                               | tikv_task:{proc max:101ms, min:0s, avg: 26.9ms, p80:49ms, p95:68ms, iters:81920, tasks:2942}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|           └─IndexLookUp_37(Probe)        | 1.00        | 8505     | root      |                                                                   | time:584.8ms, loops:27, index_task: {total_time: 404.3ms, fetch_handle: 404.2ms, build: 37µs, wait: 53.3µs}, table_task: {total_time: 249.9ms, num: 14, concurrency: 16}                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 17.7 KB   | N/A     |
|             ├─IndexRangeScan_35(Build)   | 1.00        | 8505     | cop[tikv] | table:catalog_returns, index:PRIMARY(cr_item_sk, cr_order_number) | time:403.3ms, loops:38, cop_task: {num: 105, max: 69.7ms, min: 2.75ms, avg: 21.3ms, p95: 56.6ms, max_proc_keys: 224, p95_proc_keys: 224, tot_proc: 1.53s, tot_wait: 193ms, rpc_num: 105, rpc_time: 2.23s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}, tikv_task:{proc max:57ms, min:1ms, avg: 14.4ms, p80:27ms, p95:49ms, iters:198, tasks:105}, scan_detail: {total_process_keys: 8505, total_process_keys_size: 450765, total_keys: 93653, get_snapshot_time: 5.98ms, rocksdb: {key_skipped_count: 8505, block: {cache_hit_count: 170296}}}                                                     | range: decided by [eq(tpcds50.catalog_returns.cr_item_sk, tpcds50.catalog_sales.cs_item_sk) eq(tpcds50.catalog_returns.cr_order_number, tpcds50.catalog_sales.cs_order_number)], keep order:false                                                                                                                                                                                                                                                                              | N/A       | N/A     |
|             └─TableRowIDScan_36(Probe)   | 1.00        | 8505     | cop[tikv] | table:catalog_returns                                             | time:241.5ms, loops:33, cop_task: {num: 14, max: 30.9ms, min: 5.32ms, avg: 16.9ms, p95: 30.9ms, max_proc_keys: 1551, p95_proc_keys: 1551, tot_proc: 163ms, tot_wait: 32ms, rpc_num: 14, rpc_time: 236.4ms, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}, tikv_task:{proc max:28ms, min:2ms, avg: 11.5ms, p80:23ms, p95:28ms, iters:60, tasks:14}, scan_detail: {total_process_keys: 8505, total_process_keys_size: 1810345, total_keys: 8856, get_snapshot_time: 6.81ms, rocksdb: {key_skipped_count: 712, block: {cache_hit_count: 9509, read_count: 492, read_byte: 10.7 MB, read_time: 4.17ms}}} | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
+------------------------------------------+-------------+----------+-----------+-------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+


```

### 3. What did you see instead (Required)
The query finished in 13.3s.
```
Olap_Detail_Log_ID: 3030445   Plan_Digest: 87b6c78bdaae04671114cd6dac68ff7b Elapsed_Time (s): 13.3 

+------------------------------------------+-------------+----------+-----------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+
| ID                                       | ESTROWS     | ACTROWS  | TASK      | ACCESS OBJECT         | EXECUTION INFO                                                                                                                                                                                                                                                                                                                                                                                    | OPERATOR INFO                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | MEMORY    | DISK    |
+------------------------------------------+-------------+----------+-----------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+
| Projection_21                            | 100.00      | 100      | root      |                       | time:13.3s, loops:2, Concurrency:OFF                                                                                                                                                                                                                                                                                                                                                              | tpcds50.warehouse.w_state, tpcds50.item.i_item_id, Column#128, Column#129                                                                                                                                                                                                                                                                                                                                                                                                      | 13.1 KB   | N/A     |
| └─TopN_24                                | 100.00      | 100      | root      |                       | time:13.3s, loops:2                                                                                                                                                                                                                                                                                                                                                                               | tpcds50.warehouse.w_state, tpcds50.item.i_item_id, offset:0, count:100                                                                                                                                                                                                                                                                                                                                                                                                         | 38.4 KB   | N/A     |
|   └─HashAgg_29                           | 1937.98     | 3822     | root      |                       | time:13.3s, loops:17, partial_worker:{wall_time:13.34757379s, concurrency:16, task_num:95, tot_wait:3m33.351455198s, tot_exec:159.760535ms, tot_time:3m33.522299743s, max:13.347474149s, p95:13.347474149s}, final_worker:{wall_time:13.349386861s, concurrency:16, task_num:256, tot_wait:3m33.515594969s, tot_exec:55.455049ms, tot_time:3m33.571138247s, max:13.349342805s, p95:13.349342805s} | group by:Column#146, Column#147, funcs:sum(Column#142)->Column#128, funcs:sum(Column#143)->Column#129, funcs:firstrow(Column#144)->tpcds50.warehouse.w_state, funcs:firstrow(Column#145)->tpcds50.item.i_item_id                                                                                                                                                                                                                                                               | 18.9 MB   | N/A     |
|     └─Projection_150                     | 153447.74   | 85131    | root      |                       | time:13.3s, loops:96, Concurrency:16                                                                                                                                                                                                                                                                                                                                                              | case(lt(cast(tpcds50.date_dim.d_date, date BINARY), 1998-04-08), minus(tpcds50.catalog_sales.cs_sales_price, coalesce(tpcds50.catalog_returns.cr_refunded_cash, 0)), 0)->Column#142, case(ge(cast(tpcds50.date_dim.d_date, date BINARY), 1998-04-08), minus(tpcds50.catalog_sales.cs_sales_price, coalesce(tpcds50.catalog_returns.cr_refunded_cash, 0)), 0)->Column#143, tpcds50.warehouse.w_state, tpcds50.item.i_item_id, tpcds50.warehouse.w_state, tpcds50.item.i_item_id | 2.39 MB   | N/A     |
|       └─Projection_30                    | 153447.74   | 85131    | root      |                       | time:13.3s, loops:96, Concurrency:16                                                                                                                                                                                                                                                                                                                                                              | tpcds50.catalog_sales.cs_sales_price, tpcds50.catalog_returns.cr_refunded_cash, tpcds50.warehouse.w_state, tpcds50.item.i_item_id, tpcds50.date_dim.d_date                                                                                                                                                                                                                                                                                                                     | 2.73 MB   | N/A     |
|         └─HashJoin_43                    | 153447.74   | 85131    | root      |                       | time:13.3s, loops:96, build_hash_table:{total:93.9ms, fetch:91.9ms, build:1.92ms}, probe:{concurrency:16, total:3m33.5s, max:13.3s, probe:673.6ms, fetch:3m32.8s}                                                                                                                                                                                                                                 | inner join, equal:[eq(tpcds50.catalog_sales.cs_item_sk, tpcds50.item.i_item_sk)]                                                                                                                                                                                                                                                                                                                                                                                               | 496.6 KB  | 0 Bytes |
|           ├─TableReader_144(Build)       | 3962.90     | 3953     | root      |                       | time:92.1ms, loops:5, cop_task: {num: 5, max: 45.6ms, min: 6.37ms, avg: 18.6ms, p95: 45.6ms, max_proc_keys: 30384, p95_proc_keys: 30384, tot_proc: 90ms, rpc_num: 5, rpc_time: 93.1ms, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                                                       | data:Selection_143                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 210.7 KB  | N/A     |
|           │ └─Selection_143              | 3962.90     | 3953     | cop[tikv] |                       | tikv_task:{proc max:45ms, min:6ms, avg: 18ms, p80:45ms, p95:45ms, iters:81, tasks:5}, scan_detail: {total_process_keys: 62000, total_process_keys_size: 21332103, total_keys: 62005, get_snapshot_time: 70.6µs, rocksdb: {key_skipped_count: 112085, block: {cache_hit_count: 378}}}                                                                                                              | ge(tpcds50.item.i_current_price, 0.99), le(tpcds50.item.i_current_price, 1.49)                                                                                                                                                                                                                                                                                                                                                                                                 | N/A       | N/A     |
|           │   └─TableFullScan_142        | 62000.00    | 62000    | cop[tikv] | table:item            | tikv_task:{proc max:40ms, min:6ms, avg: 16ms, p80:40ms, p95:40ms, iters:81, tasks:5}                                                                                                                                                                                                                                                                                                              | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|           └─HashJoin_104(Probe)          | 2392079.42  | 1379199  | root      |                       | time:13.3s, loops:1355, build_hash_table:{total:92.5ms, fetch:92.4ms, build:109.3µs}, probe:{concurrency:16, total:3m33.4s, max:13.3s, probe:14.4s, fetch:3m19.1s}                                                                                                                                                                                                                                | inner join, equal:[eq(tpcds50.catalog_sales.cs_sold_date_sk, tpcds50.date_dim.d_date_sk)]                                                                                                                                                                                                                                                                                                                                                                                      | 17.7 KB   | 0 Bytes |
|             ├─TableReader_141(Build)     | 61.00       | 61       | root      |                       | time:92.3ms, loops:2, cop_task: {num: 1, max: 94ms, proc_keys: 73049, tot_proc: 93ms, rpc_num: 1, rpc_time: 93.9ms, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                                                                                                                          | data:Selection_140                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 1.26 KB   | N/A     |
|             │ └─Selection_140            | 61.00       | 61       | cop[tikv] |                       | tikv_task:{time:92ms, loops:76}, scan_detail: {total_process_keys: 73049, total_process_keys_size: 14080093, total_keys: 73050, get_snapshot_time: 33.1µs, rocksdb: {key_skipped_count: 73049, block: {cache_hit_count: 232}}}                                                                                                                                                                    | ge(tpcds50.date_dim.d_date, 1998-03-09), le(tpcds50.date_dim.d_date, 1998-05-08)                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|             │   └─TableFullScan_139      | 73049.00    | 73049    | cop[tikv] | table:date_dim        | tikv_task:{time:82ms, loops:76}                                                                                                                                                                                                                                                                                                                                                                   | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|             └─HashJoin_116(Probe)        | 71278998.91 | 71457604 | root      |                       | time:13.1s, loops:69786, build_hash_table:{total:203.7µs, fetch:175.9µs, build:27.7µs}, probe:{concurrency:16, total:3m33.4s, max:13.3s, probe:2m23.2s, fetch:1m10.2s}                                                                                                                                                                                                                            | inner join, equal:[eq(tpcds50.warehouse.w_warehouse_sk, tpcds50.catalog_sales.cs_warehouse_sk)]                                                                                                                                                                                                                                                                                                                                                                                | 25.7 KB   | 0 Bytes |
|               ├─TableReader_138(Build)   | 7.00        | 7        | root      |                       | time:73.6µs, loops:2, cop_task: {num: 1, max: 1.5ms, proc_keys: 7, rpc_num: 1, rpc_time: 1.48ms, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                                                                                                                                             | data:TableFullScan_137                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 409 Bytes | N/A     |
|               │ └─TableFullScan_137      | 7.00        | 7        | cop[tikv] | table:warehouse       | tikv_task:{time:0s, loops:1}, scan_detail: {total_process_keys: 7, total_process_keys_size: 1203, total_keys: 8, get_snapshot_time: 763.3µs, rocksdb: {key_skipped_count: 7, block: {cache_hit_count: 2}}}                                                                                                                                                                                        | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|               └─HashJoin_130(Probe)      | 71278998.91 | 71457604 | root      |                       | time:5.14s, loops:69790, build_hash_table:{total:3.95s, fetch:33.3ms, build:3.92s}, probe:{concurrency:16, total:3m33.4s, max:13.3s, probe:2m23s, fetch:1m10.4s}                                                                                                                                                                                                                                  | left outer join, equal:[eq(tpcds50.catalog_sales.cs_order_number, tpcds50.catalog_returns.cr_order_number) eq(tpcds50.catalog_sales.cs_item_sk, tpcds50.catalog_returns.cr_item_sk)]                                                                                                                                                                                                                                                                                           | 785.3 MB  | 0 Bytes |
|                 ├─TableReader_136(Build) | 7197954.00  | 7197954  | root      |                       | time:43.7ms, loops:7042, cop_task: {num: 267, max: 140.4ms, min: 1.35ms, avg: 54.1ms, p95: 112.4ms, max_proc_keys: 50144, p95_proc_keys: 50144, tot_proc: 13.5s, tot_wait: 33ms, rpc_num: 267, rpc_time: 14.4s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                              | data:TableFullScan_135                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 43.0 MB   | N/A     |
|                 │ └─TableFullScan_135    | 7197954.00  | 7197954  | cop[tikv] | table:catalog_returns | tikv_task:{proc max:124ms, min:0s, avg: 46.1ms, p80:88ms, p95:98ms, iters:8082, tasks:267}, scan_detail: {total_process_keys: 7197954, total_process_keys_size: 1537666764, total_keys: 7198221, get_snapshot_time: 19ms, rocksdb: {key_skipped_count: 7197954, block: {cache_hit_count: 523, read_count: 25012, read_byte: 534.3 MB, read_time: 208ms}}}                                         | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
|                 └─TableReader_134(Probe) | 71278998.91 | 71457604 | root      |                       | time:887.5ms, loops:70484, cop_task: {num: 2942, max: 316.4ms, min: 617µs, avg: 40.6ms, p95: 95.9ms, max_proc_keys: 51168, p95_proc_keys: 51168, tot_proc: 1m41.5s, tot_wait: 504ms, rpc_num: 2942, rpc_time: 1m59.4s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 30}                                                                                                                       | data:Selection_133                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 76.9 MB   | N/A     |
|                   └─Selection_133        | 71278998.91 | 71457604 | cop[tikv] |                       | tikv_task:{proc max:115ms, min:0s, avg: 30.1ms, p80:56ms, p95:74ms, iters:81920, tasks:2942}, scan_detail: {total_process_keys: 71997669, total_process_keys_size: 19979444984, total_keys: 72000611, get_snapshot_time: 53.5ms, rocksdb: {key_skipped_count: 71997669, block: {cache_hit_count: 326538}}}                                                                                        | not(isnull(tpcds50.catalog_sales.cs_sold_date_sk)), not(isnull(tpcds50.catalog_sales.cs_warehouse_sk))                                                                                                                                                                                                                                                                                                                                                                         | N/A       | N/A     |
|                     └─TableFullScan_132  | 71997669.00 | 71997669 | cop[tikv] | table:catalog_sales   | tikv_task:{proc max:110ms, min:0s, avg: 27.8ms, p80:52ms, p95:69ms, iters:81920, tasks:2942}                                                                                                                                                                                                                                                                                                      | keep order:false                                                                                                                                                                                                                                                                                                                                                                                                                                                               | N/A       | N/A     |
+------------------------------------------+-------------+----------+-----------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+

```

### 4. What is your TiDB version? (Required)
The suboptimal plan was first catched with commit afc3276d9fa8bb009fce31fb021eb1907cc2c8e1
With commit 39e00ebe0784567d6bb2511578c7c57633f50698, we still can get the optimal plan of the 9.22s baseline.

 
