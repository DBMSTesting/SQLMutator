ID: 37191
Title: analyze table report [tikv:9004]Resolve lock timeout
Description:
## Bug Report

Please answer these questions before submitting your issue. Thanks!

### 1. Minimal reproduce step (Required)
analyze table while running workload
https://tcms.pingcap.net/dashboard/executions/plan/1170297

### 2. What did you expect to see? (Required)
do not report 9004

### 3. What did you see instead (Required)
[2022/08/16 05:38:20.109 +00:00] [WARN] [backoff.go:158] ["txnLockFast backoffer.maxSleep 40000ms is exceeded, errors:\nprimary_lock:\"t\\200\\000\\000\\000\\000\\000\\000H_i\\200\\000\\000\\000\\000\\000\\000\\001\\003\\200\\000\\000\\000\\000\\000\\nN\\003\\200\\000\\000\\000\\000\\000\\000\\003\" lock_version:435323743292096656 key:\"t\\200\\000\\000\\000\\000\\000\\000N_r\\200\\000\\000\\000\\270\\303\\325\\026\" lock_ttl:20070 txn_size:14 lock_for_update_ts:435323743292096656 use_async_commit:true min_commit_ts:435323743318310972  at 2022-08-16T05:38:13.32072489Z\nprimary_lock:\"t\\200\\000\\000\\000\\000\\000\\000H_i\\200\\000\\000\\000\\000\\000\\000\\001\\003\\200\\000\\000\\000\\000\\000\\031\\315\\003\\200\\000\\000\\000\\000\\000\\000\\004\" lock_version:435323743698157631 key:\"t\\200\\000\\000\\000\\000\\000\\000N_r\\200\\000\\000\\000\\270\\303v\\215\" lock_ttl:20044 txn_size:6 lock_for_update_ts:435323743698157631 use_async_commit:true min_commit_ts:435323743711527008  at 2022-08-16T05:38:14.839904533Z\nprimary_lock:\"t\\200\\000\\000\\000\\000\\000\\000H_i\\200\\000\\000\\000\\000\\000\\000\\001\\003\\200\\000\\000\\000\\000\\000\\022\\327\\003\\200\\000\\000\\000\\000\\000\\000\\n\" lock_version:435323744327565367 key:\"t\\200\\000\\000\\000\\000\\000\\000N_r\\200\\000\\000\\000\\270\\303\\223.\" lock_ttl:20037 txn_size:10 lock_for_update_ts:435323744327565367 use_async_commit:true min_commit_ts:435323744340410541  at 2022-08-16T05:38:17.260634526Z\nlongest sleep type: txnLockFast, time: 41304ms"]
[2022/08/16 05:38:20.109 +00:00] [ERROR] [analyze.go:230] ["analyze failed"] [error="[tikv:9004]Resolve lock timeout"]
[2022/08/16 05:38:20.119 +00:00] [INFO] [analyze.go:426] ["analyze table `tpcc10000`.`order_line` has failed"] [partition=] ["job info"="auto analyze table all columns with 256 buckets, 500 topn, 1.8333347113899248e-05 samplerate"] ["start time"=2022/08/16 01:16:39.266 +00:00] ["end time"=2022/08/16 05:38:20.109 +00:00] [cost=4h21m40.843256527s]
[2022/08/16 05:38:20.119 +00:00] [ERROR] [terror.go:313] ["encountered error"] [error="[variable:1232]Incorrect argument type to variable 'tidb_build_stats_concurrency'"] [stack="[github.com/pingcap/tidb/parser/terror.Log\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/parser/terror/terror.go:313\ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec.func3\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:433\ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:498\ngithub.com/pingcap/tidb/session.runStmt\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2146\ngithub.com/pingcap/tidb/session.(*session).ExecuteStmt\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2012\ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL.func1\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1907\ngithub.com/pingcap/tidb/session.(*session).withRestrictedSQLExecutor\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1893\ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1897\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer.func1\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:147\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).withRestrictedSQLExecutor\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:127\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:139\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execAutoAnalyze\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1230\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).autoAnalyzeTable\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1139\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).HandleAutoAnalyze\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1099\ngithub.com/pingcap/tidb/domain.(*Domain).autoAnalyzeWorker\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1559\ngithub.com/pingcap/tidb/domain.(*Domain).UpdateTableStatsLoop.func2\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1379\ngithub.com/pingcap/tidb/util.(*WaitGroupWrapper).Run.func1\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/util/wait_group_wrapper.go:33](http://github.com/pingcap/tidb/parser/terror.Log/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/parser/terror/terror.go:313/ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec.func3/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:433/ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:498/ngithub.com/pingcap/tidb/session.runStmt/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2146/ngithub.com/pingcap/tidb/session.(*session).ExecuteStmt/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2012/ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL.func1/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1907/ngithub.com/pingcap/tidb/session.(*session).withRestrictedSQLExecutor/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1893/ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1897/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer.func1/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:147/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).withRestrictedSQLExecutor/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:127/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:139/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execAutoAnalyze/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1230/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).autoAnalyzeTable/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1139/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).HandleAutoAnalyze/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1099/ngithub.com/pingcap/tidb/domain.(*Domain).autoAnalyzeWorker/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1559/ngithub.com/pingcap/tidb/domain.(*Domain).UpdateTableStatsLoop.func2/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1379/ngithub.com/pingcap/tidb/util.(*WaitGroupWrapper).Run.func1/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/util/wait_group_wrapper.go:33)"]
[2022/08/16 05:38:20.119 +00:00] [ERROR] [terror.go:313] ["encountered error"] [error="[variable:1231]Variable 'tx_isolation' can't be set to the value of ''"] [stack="[github.com/pingcap/tidb/parser/terror.Log\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/parser/terror/terror.go:313\ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec.func3\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:436\ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:498\ngithub.com/pingcap/tidb/session.runStmt\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2146\ngithub.com/pingcap/tidb/session.(*session).ExecuteStmt\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2012\ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL.func1\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1907\ngithub.com/pingcap/tidb/session.(*session).withRestrictedSQLExecutor\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1893\ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1897\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer.func1\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:147\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).withRestrictedSQLExecutor\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:127\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:139\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execAutoAnalyze\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1230\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).autoAnalyzeTable\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1139\ngithub.com/pingcap/tidb/statistics/handle.(*Handle).HandleAutoAnalyze\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1099\ngithub.com/pingcap/tidb/domain.(*Domain).autoAnalyzeWorker\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1559\ngithub.com/pingcap/tidb/domain.(*Domain).UpdateTableStatsLoop.func2\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1379\ngithub.com/pingcap/tidb/util.(*WaitGroupWrapper).Run.func1\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/util/wait_group_wrapper.go:33](http://github.com/pingcap/tidb/parser/terror.Log/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/parser/terror/terror.go:313/ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec.func3/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:436/ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/executor/adapter.go:498/ngithub.com/pingcap/tidb/session.runStmt/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2146/ngithub.com/pingcap/tidb/session.(*session).ExecuteStmt/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2012/ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL.func1/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1907/ngithub.com/pingcap/tidb/session.(*session).withRestrictedSQLExecutor/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1893/ngithub.com/pingcap/tidb/session.(*session).ExecRestrictedSQL/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:1897/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer.func1/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:147/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).withRestrictedSQLExecutor/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:127/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execRestrictedSQLWithStatsVer/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/handle.go:139/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).execAutoAnalyze/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1230/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).autoAnalyzeTable/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1139/ngithub.com/pingcap/tidb/statistics/handle.(*Handle).HandleAutoAnalyze/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/statistics/handle/update.go:1099/ngithub.com/pingcap/tidb/domain.(*Domain).autoAnalyzeWorker/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1559/ngithub.com/pingcap/tidb/domain.(*Domain).UpdateTableStatsLoop.func2/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/domain/domain.go:1379/ngithub.com/pingcap/tidb/util.(*WaitGroupWrapper).Run.func1/n/t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/util/wait_group_wrapper.go:33)"]
[2022/08/16 05:38:20.119 +00:00] [INFO] [tidb.go:263] ["rollbackTxn called due to ddl/autocommit failure"]
[2022/08/16 05:38:20.119 +00:00] [WARN] [session.go:2015] ["run statement failed"] [schemaVersion=11252] [error="[tikv:9004]Resolve lock timeout"] [session="{\n  \"currDBName\": \"\",\n  \"id\": 6579262076332539907,\n  \"status\": 2,\n  \"strictMode\": true,\n  \"user\": null\n}"]
[2022/08/16 05:38:20.119 +00:00] [ERROR] [update.go:1238] ["[stats] auto analyze failed"] [sql="analyze table `tpcc10000`.`order_line`"] [cost_time=4h21m40.859634831s] [error="[tikv:9004]Resolve lock timeout"]
[2022/08/16 05:38:20.128 +00:00] [INFO] [update.go:1136] ["[stats] auto analyze triggered"] [sql="analyze table `tpcc10000`.`district`"] [reason="too many modifications(18649782/100000>0.5)"]

### 4. What is your TiDB version? (Required)
./tikv-server -V
 TiKV 
Release Version:   6.2.0-alpha
Edition:           Community
Git Commit Hash:   8be9d449b6cf86a5e4731d032ba1d8cd7f736da8
Git Commit Branch: heads/refs/tags/v6.2.0-alpha
UTC Build Time:    2022-08-15 11:03:14
Rust Version:      rustc 1.64.0-nightly (0f4bcadb4 2022-07-30)
Enable Features:   pprof-fp jemalloc mem-profiling portable sse test-engine-kv-rocksdb test-engine-raft-raft-engine cloud-aws cloud-gcp cloud-azure
Profile:           dist_release
./pd-server -V
 Release Version: v6.2.0-alpha
Edition: Community
Git Commit Hash: 750aada580eb718a12eefe04523e3b0b3f6d4169
Git Branch: heads/refs/tags/v6.2.0-alpha
UTC Build Time:  2022-08-15 11:01:45
./tidb-server -V
 Release Version: v6.2.0-alpha
Edition: Community
Git Commit Hash: 612efa7856fb964b882a9374f02a2721d932c04b
Git Branch: heads/refs/tags/v6.2.0-alpha
UTC Build Time: 2022-08-15 11:10:55
GoVersion: go1.18.5
Race Enabled: false
TiKV Min Version: 6.2.0-alpha
Check Table Before D

<!-- Paste the output of SELECT tidb_version() -->

