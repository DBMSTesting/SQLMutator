ID: 28097
Title: Using User-Defined Variables results in OOM in TiDB 
Description:
## Bug Report

Please answer these questions before submitting your issue. Thanks!

### 1. Minimal reproduce step (Required)

<!-- a step by step guide for reproducing the bug. -->
```
set @summary_log_id=420015;
set @query_name='10C';

select s.id,b.id benchmark_id, b.name benchmark_name, d.name query_name,d.plan_digest,d.plan
from olap_summary_logs s,olap_detail_logs d, benchmarks b
where s.id=d.olap_summary_log_id
and s.benchmark_id=b.id
and s.id= @summary_log_id 
and d.name = @query_name\G;

```

### 2. What did you expect to see? (Required)
This is the output of the following sql statement:
```
select s.id,b.id benchmark_id, b.name benchmark_name, d.name query_name,d.plan_digest,d.plan
from olap_summary_logs s,olap_detail_logs d, benchmarks b
where s.id=d.olap_summary_log_id
and s.benchmark_id=b.id
and s.id= 420015 
and d.name ='10C'\G 
```

```
*************************** 1. row ***************************
            id: 420015
  benchmark_id: 910010
benchmark_name: nightly-job-tikv
    query_name: 10C
   plan_digest: f0186f28d54f6340d2b78a0f44f6ef56
          plan: +-------------------------------------------+-------------+----------+-----------+------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+
| ID                                        | ESTROWS     | ACTROWS  | TASK      | ACCESS OBJECT                                        | EXECUTION INFO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | OPERATOR INFO                                                                                                                                                   | MEMORY    | DISK    |
+-------------------------------------------+-------------+----------+-----------+------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+
| HashAgg_29                                | 1.00        | 1        | root      |                                                      | time:2.52s, loops:2, partial_worker:{wall_time:2.515817137s, concurrency:16, task_num:1, tot_wait:40.251689398s, tot_exec:46.13µs, tot_time:40.251765074s, max:2.515769509s, p95:2.515769509s}, final_worker:{wall_time:2.515873932s, concurrency:16, task_num:1, tot_wait:40.253242163s, tot_exec:51.198µs, tot_time:40.253301444s, max:2.515849763s, p95:2.515849763s}                                                                                                                                                 | funcs:min(imdb.char_name.name)->Column#43, funcs:min(imdb.title.title)->Column#44                                                                               | 53.1 KB   | N/A     |
| └─Projection_31                           | 23749906.02 | 24       | root      |                                                      | time:2.52s, loops:2, Concurrency:16                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | imdb.char_name.name, imdb.title.title                                                                                                                           | 40 KB     | N/A     |
|   └─HashJoin_42                           | 23749906.02 | 24       | root      |                                                      | time:2.52s, loops:2, build_hash_table:{total:2.52s, fetch:559.7ms, build:1.96s}, probe:{concurrency:16, total:40.2s, max:2.52s, probe:85.5µs, fetch:40.2s}                                                                                                                                                                                                                                                                                                                                                               | inner join, equal:[eq(imdb.cast_info.person_role_id, imdb.char_name.id)]                                                                                        | 132.6 MB  | 0 Bytes |
|     ├─TableReader_216(Build)              | 4314864.00  | 4314864  | root      |                                                      | time:526.3ms, loops:4218, cop_task: {num: 6, max: 1.13s, min: 515.7ms, avg: 793.5ms, p95: 1.13s, max_proc_keys: 996601, p95_proc_keys: 996601, tot_proc: 4.43s, tot_wait: 5ms, rpc_num: 6, rpc_time: 4.76s, copr_cache_hit_ratio: 0.00}                                                                                                                                                                                                                                                                                  | data:TableFullScan_215                                                                                                                                          | 100.1 MB  | N/A     |
|     │ └─TableFullScan_215                 | 4314864.00  | 4314864  | cop[tikv] | table:chn                                            | tikv_task:{proc max:752ms, min:315ms, p80:598ms, p95:752ms, iters:4241, tasks:6}, scan_detail: {total_process_keys: 4314864, total_keys: 4314870, rocksdb: {delete_skipped_count: 0, key_skipped_count: 4314871, block: {cache_hit_count: 7434, read_count: 0, read_byte: 0 Bytes}}}                                                                                                                                                                                                                                     | keep order:false                                                                                                                                                | N/A       | N/A     |
|     └─HashJoin_63(Probe)                  | 23540041.60 | 24       | root      |                                                      | time:2.18s, loops:2, build_hash_table:{total:586.6µs, fetch:578µs, build:8.55µs}, probe:{concurrency:16, total:34.9s, max:2.18s, probe:31.6µs, fetch:34.9s}                                                                                                                                                                                                                                                                                                                                                              | inner join, equal:[eq(imdb.cast_info.role_id, imdb.role_type.id)]                                                                                               | 8.23 KB   | 0 Bytes |
|       ├─TableReader_212(Build)            | 12.00       | 12       | root      |                                                      | time:536.7µs, loops:2, cop_task: {num: 1, max: 1.25ms, proc_keys: 12, rpc_num: 1, rpc_time: 1.24ms, copr_cache_hit_ratio: 0.00}                                                                                                                                                                                                                                                                                                                                                                                          | data:TableFullScan_211                                                                                                                                          | 298 Bytes | N/A     |
|       │ └─TableFullScan_211               | 12.00       | 12       | cop[tikv] | table:rt                                             | tikv_task:{time:0s, loops:1}, scan_detail: {total_process_keys: 12, total_keys: 13, rocksdb: {delete_skipped_count: 0, key_skipped_count: 12, block: {cache_hit_count: 2, read_count: 0, read_byte: 0 Bytes}}}                                                                                                                                                                                                                                                                                                           | keep order:false                                                                                                                                                | N/A       | N/A     |
|       └─HashJoin_79(Probe)                | 23540041.60 | 24       | root      |                                                      | time:2.18s, loops:2, build_hash_table:{total:2.12s, fetch:1.55s, build:569.7ms}, probe:{concurrency:16, total:34.9s, max:2.18s, probe:121.9µs, fetch:34.9s}                                                                                                                                                                                                                                                                                                                                                              | inner join, equal:[eq(imdb.title.id, imdb.cast_info.movie_id) eq(imdb.movie_companies.movie_id, imdb.cast_info.movie_id)]                                       | 65.2 MB   | 0 Bytes |
|         ├─IndexHashJoin_89(Build)         | 1587208.60  | 1464741  | root      |                                                      | time:1.46s, loops:1439, inner:{total:19.8s, concurrency:16, task:95, construct:2.52s, fetch:12.3s, build:418.4ms, join:4.97s}                                                                                                                                                                                                                                                                                                                                                                                            | inner join, inner:TableReader_83, outer key:imdb.movie_companies.movie_id, inner key:imdb.title.id, equal cond:eq(imdb.movie_companies.movie_id, imdb.title.id) | 106.6 MB  | N/A     |
|         │ ├─HashJoin_133(Build)           | 1573998.91  | 2216160  | root      |                                                      | time:1.53s, loops:2174, build_hash_table:{total:469.6ms, fetch:430.1ms, build:39.5ms}, probe:{concurrency:16, total:28s, max:1.8s, probe:5.62s, fetch:22.4s}                                                                                                                                                                                                                                                                                                                                                             | inner join, equal:[eq(imdb.movie_companies.company_id, imdb.company_name.id)]                                                                                   | 3.25 MB   | 0 Bytes |
|         │ │ ├─IndexLookUp_197(Build)      | 115236.00   | 138939   | root      |                                                      | time:436.3ms, loops:137, index_task: {total_time: 12.4ms, fetch_handle: 12.3ms, build: 12.7µs, wait: 54.4µs}, table_task: {total_time: 2.77s, num: 11, concurrency: 16}                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                 | 6.03 MB   | N/A     |
|         │ │ │ ├─IndexRangeScan_194(Build) | 115236.00   | 138939   | cop[tikv] | table:cn, index:company_name_idx_ccode(country_code) | time:2.18ms, loops:138, cop_task: {num: 1, max: 1.18ms, proc_keys: 0, rpc_num: 1, rpc_time: 1.17ms, copr_cache_hit_ratio: 1.00}, tikv_task:{time:72ms, loops:140}                                                                                                                                                                                                                                                                                                                                                        | range:["[us]","[us]"], keep order:false                                                                                                                         | N/A       | N/A     |
|         │ │ │ └─Selection_196(Probe)      | 115236.00   | 138939   | cop[tikv] |                                                      | time:2.58s, loops:156, cop_task: {num: 11, max: 424.4ms, min: 77.1ms, avg: 233.5ms, p95: 424.4ms, max_proc_keys: 20480, p95_proc_keys: 20480, tot_proc: 1.96s, tot_wait: 557ms, rpc_num: 11, rpc_time: 2.57s, copr_cache_hit_ratio: 0.00}, tikv_task:{proc max:89ms, min:8ms, p80:80ms, p95:89ms, iters:190, tasks:11}, scan_detail: {total_process_keys: 138939, total_keys: 171227, rocksdb: {delete_skipped_count: 0, key_skipped_count: 108316, block: {cache_hit_count: 96116, read_count: 0, read_byte: 0 Bytes}}} | eq(imdb.company_name.country_code, "[us]")                                                                                                                      | N/A       | N/A     |
|         │ │ │   └─TableRowIDScan_195      | 115236.00   | 138939   | cop[tikv] | table:cn                                             | tikv_task:{proc max:87ms, min:8ms, p80:78ms, p95:87ms, iters:190, tasks:11}                                                                                                                                                                                                                                                                                                                                                                                                                                              | keep order:false                                                                                                                                                | N/A       | N/A     |
|         │ │ └─HashJoin_178(Probe)         | 4958296.00  | 4958296  | root      |                                                      | time:1.59s, loops:4846, build_hash_table:{total:485.8µs, fetch:480µs, build:5.83µs}, probe:{concurrency:16, total:27.9s, max:1.75s, probe:12.4s, fetch:15.6s}                                                                                                                                                                                                                                                                                                                                                            | inner join, equal:[eq(imdb.company_type.id, imdb.movie_companies.company_type_id)]                                                                              | 8.23 KB   | 0 Bytes |
|         │ │   ├─TableReader_186(Build)    | 4.00        | 4        | root      |                                                      | time:433.6µs, loops:2, cop_task: {num: 1, max: 913.1µs, proc_keys: 4, rpc_num: 1, rpc_time: 890.8µs, copr_cache_hit_ratio: 0.00}                                                                                                                                                                                                                                                                                                                                                                                         | data:TableFullScan_185                                                                                                                                          | 229 Bytes | N/A     |
|         │ │   │ └─TableFullScan_185       | 4.00        | 4        | cop[tikv] | table:ct                                             | tikv_task:{time:0s, loops:1}, scan_detail: {total_process_keys: 4, total_keys: 5, rocksdb: {delete_skipped_count: 0, key_skipped_count: 4, block: {cache_hit_count: 2, read_count: 0, read_byte: 0 Bytes}}}                                                                                                                                                                                                                                                                                                              | keep order:false                                                                                                                                                | N/A       | N/A     |
|         │ │   └─TableReader_190(Probe)    | 4958296.00  | 4958296  | root      |                                                      | time:941.9ms, loops:4845, cop_task: {num: 5, max: 1.37s, min: 644.2ms, avg: 1.06s, p95: 1.37s, max_proc_keys: 1185298, p95_proc_keys: 1185298, tot_proc: 5.02s, tot_wait: 7ms, rpc_num: 5, rpc_time: 5.3s, copr_cache_hit_ratio: 0.00}                                                                                                                                                                                                                                                                                   | data:TableFullScan_189                                                                                                                                          | 52.5 MB   | N/A     |
|         │ │     └─TableFullScan_189       | 4958296.00  | 4958296  | cop[tikv] | table:mc                                             | tikv_task:{proc max:1.05s, min:555ms, p80:1.05s, p95:1.05s, iters:4864, tasks:5}, scan_detail: {total_process_keys: 4958296, total_keys: 4958301, rocksdb: {delete_skipped_count: 0, key_skipped_count: 4958297, block: {cache_hit_count: 5662, read_count: 0, read_byte: 0 Bytes}}}                                                                                                                                                                                                                                     | keep order:false                                                                                                                                                | N/A       | N/A     |
|         │ └─TableReader_83(Probe)         | 0.74        | 1062446  | root      |                                                      | time:11.6s, loops:1287, cop_task: {num: 173, max: 335.5ms, min: 442.2µs, avg: 71.7ms, p95: 274.2ms, max_proc_keys: 21513, p95_proc_keys: 21050, tot_proc: 10.1s, tot_wait: 954ms, rpc_num: 173, rpc_time: 12.4s, copr_cache_hit_ratio: 0.00}                                                                                                                                                                                                                                                                             | data:Selection_82                                                                                                                                               | N/A       | N/A     |
|         │   └─Selection_82                | 0.74        | 1062446  | cop[tikv] |                                                      | tikv_task:{proc max:192ms, min:0s, p80:87ms, p95:153ms, iters:2183, tasks:173}, scan_detail: {total_process_keys: 1601653, total_keys: 1809157, rocksdb: {delete_skipped_count: 0, key_skipped_count: 1257321, block: {cache_hit_count: 781018, read_count: 0, read_byte: 0 Bytes}}}                                                                                                                                                                                                                                     | gt(imdb.title.production_year, 1990)                                                                                                                            | N/A       | N/A     |
|         │     └─TableRangeScan_81         | 1.00        | 1601653  | cop[tikv] | table:t                                              | tikv_task:{proc max:192ms, min:0s, p80:87ms, p95:152ms, iters:2183, tasks:173}                                                                                                                                                                                                                                                                                                                                                                                                                                           | range: decided by [imdb.movie_companies.movie_id], keep order:false                                                                                             | N/A       | N/A     |
|         └─TableReader_206(Probe)          | 23540041.60 | 46       | root      |                                                      | time:2.18s, loops:2, cop_task: {num: 70, max: 1.61s, min: 338.5µs, avg: 652.9ms, p95: 1.3s, max_proc_keys: 1099616, p95_proc_keys: 960000, tot_proc: 44.8s, tot_wait: 763ms, rpc_num: 70, rpc_time: 45.7s, copr_cache_hit_ratio: 0.37}                                                                                                                                                                                                                                                                                   | data:Selection_205                                                                                                                                              | 2.35 KB   | N/A     |
|           └─Selection_205                 | 23540041.60 | 46       | cop[tikv] |                                                      | tikv_task:{proc max:1.44s, min:287ms, p80:1.02s, p95:1.14s, iters:62303, tasks:70}, scan_detail: {total_process_keys: 40705665, total_keys: 40705709, rocksdb: {delete_skipped_count: 0, key_skipped_count: 40705771, block: {cache_hit_count: 48169, read_count: 0, read_byte: 0 Bytes}}}                                                                                                                                                                                                                               | like(imdb.cast_info.note, "%(producer)%", 92), not(isnull(imdb.cast_info.person_role_id))                                                                       | N/A       | N/A     |
|             └─TableFullScan_204           | 63475835.00 | 63475835 | cop[tikv] | table:ci                                             | tikv_task:{proc max:1.36s, min:267ms, p80:947ms, p95:1.07s, iters:62303, tasks:70}                                                                                                                                                                                                                                                                                                                                                                                                                                       | keep order:false                                                                                                                                                | N/A       | N/A     |
+-------------------------------------------+-------------+----------+-----------+------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+---------+

```

### 3. What did you see instead (Required)
```
perfdata>set @summary_log_id=420015;
Query OK, 0 rows affected (0.05 sec)

perfdata>set @query_name='10C';
Query OK, 0 rows affected (0.05 sec)

perfdata>select s.id,b.id benchmark_id, b.name benchmark_name, d.name query_name,d.plan_digest,d.plan
    -> from olap_summary_logs s,olap_detail_logs d, benchmarks b
    -> where s.id=d.olap_summary_log_id
    -> and s.benchmark_id=b.id
    -> and s.id= @summary_log_id
    -> and d.name = @query_name\G;

ERROR 1105 (HY000): Out Of Memory Quota![conn_id=608861]
ERROR:
No query specified
```

### 4. What is your TiDB version? (Required)

<!-- Paste the output of SELECT tidb_version() -->
```
Release Version: v5.2.0
Edition: Community
Git Commit Hash: 9d798d5acfdce77d88e5985e91a85c2c46a46c91
Git Branch: heads/refs/tags/v5.2.0
UTC Build Time: 2021-08-25 02:15:52
GoVersion: go1.16.4
Race Enabled: false
TiKV Min Version: v3.0.0-60965b006877ca7234adaced7890d7b029ed1306
Check Table Before Drop: false
```

