ID: 37768
Title: TPCH Q17 occurs 13.5s performance regression without plan change
Description:
## Bug Report

Please answer these questions before submitting your issue. Thanks!

### 1. Minimal reproduce step (Required)

1. deploy a tidb cluster: 1 tidb (16c) + 3 TiKV(16c) + 1 PD
2. restore tpch 50g data
3. run tpch for 30 mins

<!-- a step by step guide for reproducing the bug. -->

### 2. What did you expect to see? (Required)
The query would be finished in around 105s like it did with commit 987bdd3014d8c90302caac3e99092d8014c47109

```
Plan_Digest: 7847c375ff896b78c5d0c191811bc457 Elapsed_Time (s): 105.0 

+-------------------------------+--------------+-----------+-----------+----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------+
| ID                            | ESTROWS      | ACTROWS   | TASK      | ACCESS OBJECT  | EXECUTION INFO                                                                                                                                                                                                                                                                                                                                                                                                     | OPERATOR INFO                                                                                                                                  | MEMORY   | DISK    |
+-------------------------------+--------------+-----------+-----------+----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------+
| Projection_17                 | 1.00         | 1         | root      |                | time:1m45s, loops:2, Concurrency:OFF                                                                                                                                                                                                                                                                                                                                                                               | div(Column#46, 7.0)->Column#47                                                                                                                 | 1.40 KB  | N/A     |
| └─HashAgg_18                  | 1.00         | 1         | root      |                | time:1m45s, loops:2, partial_worker:{wall_time:1m45.014051221s, concurrency:5, task_num:29, tot_wait:8m45.065568108s, tot_exec:3.792953ms, tot_time:8m45.069445301s, max:1m45.013963154s, p95:1m45.013963154s}, final_worker:{wall_time:1m45.014093365s, concurrency:5, task_num:5, tot_wait:8m45.070125675s, tot_exec:48.104µs, tot_time:8m45.070186336s, max:1m45.014054972s, p95:1m45.014054972s}               | funcs:sum(test.lineitem.l_extendedprice)->Column#46                                                                                            | 568.2 KB | N/A     |
|   └─HashJoin_22               | 308799.82    | 26963     | root      |                | time:1m45s, loops:30, build_hash_table:{total:46.1s, fetch:46s, build:128.5ms}, probe:{concurrency:5, total:8m45.1s, max:1m45s, probe:3.08s, fetch:8m42s}                                                                                                                                                                                                                                                          | inner join, equal:[eq(test.part.p_partkey, test.lineitem.l_partkey)], other cond:lt(test.lineitem.l_quantity, mul(0.2, Column#44))             | 30.7 MB  | 0 Bytes |
|     ├─HashJoin_35(Build)      | 308799.82    | 299664    | root      |                | time:46.1s, loops:297, build_hash_table:{total:1.04s, fetch:1.02s, build:16.4ms}, probe:{concurrency:5, total:3m50.7s, max:46.1s, probe:3m1.3s, fetch:49.4s}                                                                                                                                                                                                                                                       | inner join, equal:[eq(test.part.p_partkey, test.lineitem.l_partkey)]                                                                           | 1.18 MB  | 0 Bytes |
|     │ ├─TableReader_40(Build) | 10257.69     | 9989      | root      |                | time:1.03s, loops:11, cop_task: {num: 64, max: 386.1ms, min: 975.3µs, avg: 186.9ms, p95: 335.9ms, max_proc_keys: 281568, p95_proc_keys: 266208, tot_proc: 11.8s, tot_wait: 42ms, rpc_num: 64, rpc_time: 12s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 15}                                                                                                                                                  | data:Selection_39                                                                                                                              | 35.5 KB  | N/A     |
|     │ │ └─Selection_39        | 10257.69     | 9989      | cop[tikv] |                | tikv_task:{proc max:384ms, min:0s, avg: 182.6ms, p80:264ms, p95:333ms, iters:10033, tasks:64}, scan_detail: {total_process_keys: 10000000, total_process_keys_size: 1634215609, total_keys: 10000064, rocksdb: {delete_skipped_count: 0, key_skipped_count: 10000000, block: {cache_hit_count: 27177, read_count: 0, read_byte: 0 Bytes}}}                                                                         | eq(test.part.p_brand, "Brand#44"), eq(test.part.p_container, "WRAP PKG")                                                                       | N/A      | N/A     |
|     │ │   └─TableFullScan_38  | 10000000.00  | 10000000  | cop[tikv] | table:part     | tikv_task:{proc max:330ms, min:0s, avg: 161.4ms, p80:233ms, p95:297ms, iters:10033, tasks:64}                                                                                                                                                                                                                                                                                                                      | keep order:false                                                                                                                               | N/A      | N/A     |
|     │ └─TableReader_37(Probe) | 300005811.00 | 300005811 | root      |                | time:8.7s, loops:295063, cop_task: {num: 36369, max: 424.7ms, min: 572.6µs, avg: 15.8ms, p95: 28.3ms, max_proc_keys: 9184, p95_proc_keys: 9184, tot_proc: 6m25s, tot_wait: 7.88s, rpc_num: 36369, rpc_time: 9m35.7s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 15}                                                                                                                                          | data:TableFullScan_36                                                                                                                          | 448.8 MB | N/A     |
|     │   └─TableFullScan_36    | 300005811.00 | 300005811 | cop[tikv] | table:lineitem | tikv_task:{proc max:28ms, min:0s, avg: 8.38ms, p80:11ms, p95:14ms, iters:437512, tasks:36369}, scan_detail: {total_process_keys: 300005811, total_process_keys_size: 59595430182, total_keys: 300042180, rocksdb: {delete_skipped_count: 0, key_skipped_count: 300005811, block: {cache_hit_count: 1046128, read_count: 0, read_byte: 0 Bytes}}}                                                                   | keep order:false                                                                                                                               | N/A      | N/A     |
|     └─HashAgg_45(Probe)       | 9965568.00   | 10000000  | root      |                | time:1m45s, loops:9770, partial_worker:{wall_time:1m25.779541955s, concurrency:5, task_num:36297, tot_wait:387.856003ms, tot_exec:6m44.241576284s, tot_time:7m8.553442915s, max:1m25.779467129s, p95:1m25.779467129s}, final_worker:{wall_time:1m45.013415348s, concurrency:5, task_num:25, tot_wait:7m8.273279804s, tot_exec:1m36.436308955s, tot_time:8m44.709613464s, max:1m45.013291372s, p95:1m45.013291372s} | group by:test.lineitem.l_partkey, funcs:avg(Column#50, Column#51)->Column#44, funcs:firstrow(test.lineitem.l_partkey)->test.lineitem.l_partkey | 11.9 GB  | N/A     |
|       └─TableReader_46        | 9965568.00   | 299871362 | root      |                | time:1.25s, loops:36298, cop_task: {num: 36298, max: 447.1ms, min: 1.1ms, avg: 15.6ms, p95: 24.9ms, max_proc_keys: 9216, p95_proc_keys: 9216, tot_proc: 7m17.4s, tot_wait: 7.38s, rpc_num: 36298, rpc_time: 9m25s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 15}                                                                                                                                            | data:HashAgg_41                                                                                                                                | 352.9 MB | N/A     |
|         └─HashAgg_41          | 9965568.00   | 299871362 | cop[tikv] |                | tikv_task:{proc max:35ms, min:0s, avg: 11.4ms, p80:15ms, p95:19ms, iters:293178, tasks:36298}, scan_detail: {total_process_keys: 300005811, total_process_keys_size: 59595430182, total_keys: 300042109, rocksdb: {delete_skipped_count: 0, key_skipped_count: 300005811, block: {cache_hit_count: 1045972, read_count: 0, read_byte: 0 Bytes}}}                                                                   | group by:test.lineitem.l_partkey, funcs:count(test.lineitem.l_quantity)->Column#50, funcs:sum(test.lineitem.l_quantity)->Column#51             | N/A      | N/A     |
|           └─TableFullScan_44  | 300005811.00 | 300005811 | cop[tikv] | table:lineitem | tikv_task:{proc max:25ms, min:0s, avg: 7.47ms, p80:10ms, p95:13ms, iters:293178, tasks:36298}                                                                                                                                                                                                                                                                                                                      | keep order:false                                                                                                                               | N/A      | N/A     |
+-------------------------------+--------------+-----------+-----------+----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------+


```

### 3. What did you see instead (Required)
The query finished in 115s -122s, and more time was taken in HashAgg_45(Probe).  

```
Olap_Detail_Log_ID: 3126780   Plan_Digest: 7847c375ff896b78c5d0c191811bc457 Elapsed_Time (s): 117.8 

+-------------------------------+--------------+-----------+-----------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------+
| ID                            | ESTROWS      | ACTROWS   | TASK      | ACCESS OBJECT  | EXECUTION INFO                                                                                                                                                                                                                                                                                                                                                                                                      | OPERATOR INFO                                                                                                                                  | MEMORY   | DISK    |
+-------------------------------+--------------+-----------+-----------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------+
| Projection_17                 | 1.00         | 1         | root      |                | time:1m57.8s, loops:2, Concurrency:OFF                                                                                                                                                                                                                                                                                                                                                                              | div(Column#46, 7.0)->Column#47                                                                                                                 | 1.40 KB  | N/A     |
| └─HashAgg_18                  | 1.00         | 1         | root      |                | time:1m57.8s, loops:2, partial_worker:{wall_time:1m57.817786181s, concurrency:5, task_num:30, tot_wait:9m49.085437213s, tot_exec:3.242293ms, tot_time:9m49.088720706s, max:1m57.817755964s, p95:1m57.817755964s}, final_worker:{wall_time:1m57.817799065s, concurrency:5, task_num:5, tot_wait:9m49.088851914s, tot_exec:36.427µs, tot_time:9m49.088892849s, max:1m57.817782395s, p95:1m57.817782395s}              | funcs:sum(test.lineitem.l_extendedprice)->Column#46                                                                                            | 568.2 KB | N/A     |
|   └─HashJoin_22               | 300147.94    | 26963     | root      |                | time:1m57.8s, loops:31, build_hash_table:{total:52.3s, fetch:52.1s, build:134.7ms}, probe:{concurrency:5, total:9m49.1s, max:1m57.8s, probe:2.79s, fetch:9m46.3s}                                                                                                                                                                                                                                                   | inner join, equal:[eq(test.part.p_partkey, test.lineitem.l_partkey)], other cond:lt(test.lineitem.l_quantity, mul(0.2, Column#44))             | 30.6 MB  | 0 Bytes |
|     ├─HashJoin_35(Build)      | 300147.94    | 299664    | root      |                | time:52.2s, loops:296, build_hash_table:{total:808.4ms, fetch:803.8ms, build:4.55ms}, probe:{concurrency:5, total:4m21.4s, max:52.3s, probe:2m19.5s, fetch:2m1.9s}                                                                                                                                                                                                                                                  | inner join, equal:[eq(test.part.p_partkey, test.lineitem.l_partkey)]                                                                           | 1.10 MB  | 0 Bytes |
|     │ ├─TableReader_40(Build) | 9970.29      | 9989      | root      |                | time:807.7ms, loops:11, cop_task: {num: 48, max: 370.6ms, min: 639.7µs, avg: 216.3ms, p95: 319.8ms, max_proc_keys: 285207, p95_proc_keys: 278079, tot_proc: 10.3s, rpc_num: 48, rpc_time: 10.4s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 15}                                                                                                                                                               | data:Selection_39                                                                                                                              | 39.6 KB  | N/A     |
|     │ │ └─Selection_39        | 9970.29      | 9989      | cop[tikv] |                | tikv_task:{proc max:369ms, min:0s, avg: 214.3ms, p80:278ms, p95:317ms, iters:9968, tasks:48}, scan_detail: {total_process_keys: 10000000, total_process_keys_size: 1634215609, total_keys: 10000048, get_snapshot_time: 918.7µs, rocksdb: {key_skipped_count: 10000000, block: {cache_hit_count: 27145}}}                                                                                                           | eq(test.part.p_brand, "Brand#44"), eq(test.part.p_container, "WRAP PKG")                                                                       | N/A      | N/A     |
|     │ │   └─TableFullScan_38  | 10000000.00  | 10000000  | cop[tikv] | table:part     | tikv_task:{proc max:328ms, min:0s, avg: 189.6ms, p80:244ms, p95:283ms, iters:9968, tasks:48}                                                                                                                                                                                                                                                                                                                        | keep order:false                                                                                                                               | N/A      | N/A     |
|     │ └─TableReader_37(Probe) | 300005811.00 | 300005811 | root      |                | time:22.3s, loops:293961, cop_task: {num: 10802, max: 1.01s, min: 439.2µs, avg: 61.3ms, p95: 153ms, max_proc_keys: 50144, p95_proc_keys: 50144, tot_proc: 6m56.1s, tot_wait: 15.3s, rpc_num: 10802, rpc_time: 11m1.4s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 15}                                                                                                                                         | data:TableFullScan_36                                                                                                                          | 49.6 MB  | N/A     |
|     │   └─TableFullScan_36    | 300005811.00 | 300005811 | cop[tikv] | table:lineitem | tikv_task:{proc max:356ms, min:0s, avg: 32.8ms, p80:57ms, p95:80ms, iters:335816, tasks:10802}, scan_detail: {total_process_keys: 299693438, total_process_keys_size: 59533380449, total_keys: 299704227, get_snapshot_time: 1.23s, rocksdb: {key_skipped_count: 299693438, block: {cache_hit_count: 955333, read_count: 38540, read_byte: 623.6 MB, read_time: 328.1ms}}}                                          | keep order:false                                                                                                                               | N/A      | N/A     |
|     └─HashAgg_45(Probe)       | 9965568.00   | 10000000  | root      |                | time:1m57.8s, loops:9770, partial_worker:{wall_time:1m36.847211168s, concurrency:5, task_num:10802, tot_wait:2.250093808s, tot_exec:7m48.209877007s, tot_time:8m3.748426217s, max:1m36.847156074s, p95:1m36.847156074s}, final_worker:{wall_time:1m57.817278547s, concurrency:5, task_num:25, tot_wait:8m2.81987348s, tot_exec:1m45.981078009s, tot_time:9m48.800972131s, max:1m57.817244401s, p95:1m57.817244401s} | group by:test.lineitem.l_partkey, funcs:avg(Column#50, Column#51)->Column#44, funcs:firstrow(test.lineitem.l_partkey)->test.lineitem.l_partkey | 11.9 GB  | N/A     |
|       └─TableReader_46        | 9965568.00   | 299320645 | root      |                | time:3.25s, loops:10803, cop_task: {num: 10802, max: 1.06s, min: 410.6µs, avg: 57ms, p95: 127.4ms, max_proc_keys: 50176, p95_proc_keys: 50176, tot_proc: 8m3.2s, tot_wait: 9.05s, rpc_num: 10802, rpc_time: 10m15.4s, copr_cache_hit_ratio: 0.00, distsql_concurrency: 15}                                                                                                                                          | data:HashAgg_41                                                                                                                                | 42.8 MB  | N/A     |
|         └─HashAgg_41          | 9965568.00   | 299320645 | cop[tikv] |                | tikv_task:{proc max:512ms, min:0s, avg: 43.2ms, p80:76ms, p95:97ms, iters:293177, tasks:10802}, scan_detail: {total_process_keys: 299776435, total_process_keys_size: 59549881925, total_keys: 299787229, get_snapshot_time: 727.7ms, rocksdb: {key_skipped_count: 299776435, block: {cache_hit_count: 993501, read_count: 648, read_byte: 10.5 MB, read_time: 5.96ms}}}                                            | group by:test.lineitem.l_partkey, funcs:count(test.lineitem.l_quantity)->Column#50, funcs:sum(test.lineitem.l_quantity)->Column#51             | N/A      | N/A     |
|           └─TableFullScan_44  | 300005811.00 | 300005811 | cop[tikv] | table:lineitem | tikv_task:{proc max:471ms, min:0s, avg: 27.8ms, p80:48ms, p95:64ms, iters:293177, tasks:10802}                                                                                                                                                                                                                                                                                                                      | keep order:false                                                                                                                               | N/A      | N/A     |
+-------------------------------+--------------+-----------+-----------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------+


```


### 4. What is your TiDB version? (Required)

<!-- Paste the output of SELECT tidb_version() -->
master

