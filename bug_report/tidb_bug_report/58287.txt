ID: 58287
Title: DATA RACE at the infoschema.*Sieve
Description:
## Bug Report

Please answer these questions before submitting your issue. Thanks!

### 1. Minimal reproduce step (Required)

<!-- a step by step guide for reproducing the bug. -->

### 2. What did you expect to see? (Required)

### 3. What did you see instead (Required)

```
==================
WARNING: DATA RACE
Write at 0x00c00c00df50 by goroutine 22527:
  github.com/pingcap/tidb/pkg/infoschema.(*Sieve[go.shape.struct { github.com/pingcap/tidb/pkg/infoschema.tableID int64; github.com/pingcap/tidb/pkg/infoschema.schemaVersion int64 },go.shape.3a1a9f922c98916eb710c4393a2ff31cbdfc97a4f6c06c922620e553dbdcab66]).Set()
      pkg/infoschema/sieve.go:135 +0x1da
  github.com/pingcap/tidb/pkg/infoschema.(*infoschemaV2).TableByName()
      pkg/infoschema/infoschema_v2.go:808 +0xa4b
  github.com/pingcap/tidb/pkg/infoschema.(*SessionExtendedInfoSchema).TableByName()
      pkg/infoschema/infoschema.go:818 +0x2b7
  github.com/pingcap/tidb/pkg/planner/core.(*preprocessor).tableByName()
      pkg/planner/core/preprocess.go:507 +0x371
  github.com/pingcap/tidb/pkg/planner/core.(*preprocessor).handleTableName()
      pkg/planner/core/preprocess.go:1616 +0x73d
  github.com/pingcap/tidb/pkg/planner/core.(*preprocessor).Leave()
      pkg/planner/core/preprocess.go:614 +0x15d2
  github.com/pingcap/tidb/pkg/parser/ast.(*TableName).Accept()
      pkg/parser/ast/dml.go:454 +0x2c1
  github.com/pingcap/tidb/pkg/parser/ast.(*TableSource).Accept()
      pkg/parser/ast/dml.go:606 +0xc4
  github.com/pingcap/tidb/pkg/parser/ast.(*Join).Accept()
      pkg/parser/ast/dml.go:244 +0xeb
  github.com/pingcap/tidb/pkg/parser/ast.(*TableRefsClause).Accept()
      pkg/parser/ast/dml.go:829 +0xc4
  github.com/pingcap/tidb/pkg/parser/ast.(*SelectStmt).Accept()
      pkg/parser/ast/dml.go:1501 +0x6a5
  github.com/pingcap/tidb/pkg/planner/core.Preprocess()
      pkg/planner/core/preprocess.go:144 +0x59c
  github.com/pingcap/tidb/pkg/executor.(*Compiler).Compile()
      pkg/executor/compiler.go:69 +0x564
  github.com/pingcap/tidb/pkg/session.(*session).ExecuteStmt()
      pkg/session/session.go:2099 +0x12e4
  github.com/pingcap/tidb/pkg/session.(*session).ExecuteInternal()
      pkg/session/session.go:1524 +0x3f1
  github.com/pingcap/tidb/pkg/timer/tablestore.executeSQL()
      pkg/timer/tablestore/store.go:432 +0x182
  github.com/pingcap/tidb/pkg/timer/tablestore.(*tableTimerStoreCore).List()
      pkg/timer/tablestore/store.go:135 +0x364
  github.com/pingcap/tidb/pkg/timer/runtime.(*TimerGroupRuntime).fullRefreshTimers()
      pkg/timer/runtime/runtime.go:246 +0x13b
  github.com/pingcap/tidb/pkg/timer/runtime.(*TimerGroupRuntime).loop()
      pkg/timer/runtime/runtime.go:198 +0x734
  github.com/pingcap/tidb/pkg/timer/runtime.(*TimerGroupRuntime).loop-fm()
      <autogenerated>:1 +0x3d
  github.com/pingcap/tidb/pkg/timer/runtime.withRecoverUntil.func1()
      pkg/timer/runtime/runtime.go:542 +0x56
  github.com/pingcap/tidb/pkg/util.WithRecovery()
      pkg/util/misc.go:98 +0x99
  github.com/pingcap/tidb/pkg/timer/runtime.withRecoverUntil()
      pkg/timer/runtime/runtime.go:541 +0xf3
  github.com/pingcap/tidb/pkg/timer/runtime.(*TimerGroupRuntime).Start.func1()
      pkg/timer/runtime/runtime.go:139 +0x8a
  github.com/pingcap/tidb/pkg/util.(*WaitGroupWrapper).Run.func1()
      pkg/util/wait_group_wrapper.go:157 +0x97

Previous read at 0x00c00c00df50 by goroutine 21227:
  github.com/pingcap/tidb/pkg/infoschema.(*Sieve[go.shape.struct { github.com/pingcap/tidb/pkg/infoschema.tableID int64; github.com/pingcap/tidb/pkg/infoschema.schemaVersion int64 },go.shape.3a1a9f922c98916eb710c4393a2ff31cbdfc97a4f6c06c922620e553dbdcab66]).Get()
      pkg/infoschema/sieve.go:168 +0x204
  github.com/pingcap/tidb/pkg/infoschema.(*infoschemaV2).TableByName()
      pkg/infoschema/infoschema_v2.go:791 +0x78e
  github.com/pingcap/tidb/pkg/infoschema.(*SessionExtendedInfoSchema).TableByName()
      pkg/infoschema/infoschema.go:818 +0x2b7
  github.com/pingcap/tidb/pkg/planner/core.(*PlanBuilder).buildDataSource()
      pkg/planner/core/logical_plan_builder.go:4379 +0x426
  github.com/pingcap/tidb/pkg/planner/core.(*PlanBuilder).buildResultSetNode()
      pkg/planner/core/logical_plan_builder.go:453 +0x6ee
  github.com/pingcap/tidb/pkg/planner/core.(*PlanBuilder).buildJoin()
      pkg/planner/core/logical_plan_builder.go:557 +0x13d6
  github.com/pingcap/tidb/pkg/planner/core.(*PlanBuilder).buildResultSetNode()
      pkg/planner/core/logical_plan_builder.go:439 +0x93e
  github.com/pingcap/tidb/pkg/planner/core.(*PlanBuilder).buildTableRefs()
      pkg/planner/core/logical_plan_builder.go:431 +0x144
  github.com/pingcap/tidb/pkg/planner/core.(*PlanBuilder).buildSelect()
      pkg/planner/core/logical_plan_builder.go:3755 +0xc31
  github.com/pingcap/tidb/pkg/planner/core.(*PlanBuilder).Build()
      pkg/planner/core/planbuilder.go:543 +0xc76
  github.com/pingcap/tidb/pkg/planner.buildLogicalPlan()
      pkg/planner/optimize.go:575 +0x364
  github.com/pingcap/tidb/pkg/planner.optimize()
      pkg/planner/optimize.go:492 +0x7d9
  github.com/pingcap/tidb/pkg/planner.Optimize()
      pkg/planner/optimize.go:360 +0x266f
  github.com/pingcap/tidb/pkg/executor.(*Compiler).Compile()
      pkg/executor/compiler.go:101 +0x950
  github.com/pingcap/tidb/pkg/session.(*session).ExecuteStmt()
      pkg/session/session.go:2099 +0x12e4
  github.com/pingcap/tidb/pkg/session.(*session).ExecuteInternal()
      pkg/session/session.go:1524 +0x3f1
  github.com/pingcap/tidb/pkg/timer/tablestore.executeSQL()
      pkg/timer/tablestore/store.go:432 +0x182
  github.com/pingcap/tidb/pkg/timer/tablestore.(*tableTimerStoreCore).List()
      pkg/timer/tablestore/store.go:135 +0x364
  github.com/pingcap/tidb/pkg/timer/api.(*defaultTimerClient).GetTimers()
      pkg/timer/api/client.go:188 +0x184
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*TTLTimersSyncer).SyncTimers()
      pkg/ttl/ttlworker/timer_sync.go:175 +0x30d
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*JobManager).onTimerTick()
      pkg/ttl/ttlworker/job_manager.go:310 +0x2d2
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*JobManager).jobLoop()
      pkg/ttl/ttlworker/job_manager.go:209 +0x1149
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*JobManager).jobLoop-fm()
      <autogenerated>:1 +0x33
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*baseWorker).loop()
      pkg/ttl/ttlworker/worker.go:136 +0xd5
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*baseWorker).loop-fm()
      <autogenerated>:1 +0x33
  github.com/pingcap/tidb/pkg/util.(*WaitGroupWrapper).Run.func1()
      pkg/util/wait_group_wrapper.go:157 +0x97

Goroutine 22527 (running) created at:
  github.com/pingcap/tidb/pkg/util.(*WaitGroupWrapper).Run()
      pkg/util/wait_group_wrapper.go:155 +0xf0
  github.com/pingcap/tidb/pkg/timer/runtime.(*TimerGroupRuntime).Start()
      pkg/timer/runtime/runtime.go:138 +0x144
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*ttlTimerRuntime).Resume()
      pkg/ttl/ttlworker/timer.go:279 +0x37b
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*JobManager).onTimerTick()
      pkg/ttl/ttlworker/job_manager.go:293 +0xaa
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*JobManager).jobLoop()
      pkg/ttl/ttlworker/job_manager.go:209 +0x1149
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*JobManager).jobLoop-fm()
      <autogenerated>:1 +0x33
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*baseWorker).loop()
      pkg/ttl/ttlworker/worker.go:136 +0xd5
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*baseWorker).loop-fm()
      <autogenerated>:1 +0x33
  github.com/pingcap/tidb/pkg/util.(*WaitGroupWrapper).Run.func1()
      pkg/util/wait_group_wrapper.go:157 +0x97

Goroutine 21227 (running) created at:
  github.com/pingcap/tidb/pkg/util.(*WaitGroupWrapper).Run()
      pkg/util/wait_group_wrapper.go:155 +0xf0
  github.com/pingcap/tidb/pkg/ttl/ttlworker.(*baseWorker).Start()
      pkg/ttl/ttlworker/worker.go:72 +0x137
  github.com/pingcap/tidb/pkg/domain.(*Domain).StartTTLJobManager()
      pkg/domain/domain.go:3252 +0x1f1
  github.com/pingcap/tidb/pkg/session.bootstrapSessionImpl()
      pkg/session/session.go:3650 +0x1c68
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:143 +0x982
  github.com/pingcap/tidb/pkg/sessionctx/variable.parseSchemaCacheSize()
      pkg/sessionctx/variable/varsutil.go:638 +0x1ad
  github.com/pingcap/tidb/pkg/sessionctx/variable.init.func620()
      pkg/sessionctx/variable/sysvar.go:3318 +0x78
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:143 +0x982
  github.com/pingcap/tidb/pkg/sessionctx/variable.init.func619()
      pkg/sessionctx/variable/sysvar.go:3310 +0x64
  github.com/pingcap/tidb/pkg/sessionctx/variable.(*SysVar).ValidateWithRelaxedValidation()
      pkg/sessionctx/variable/variable.go:377 +0x256
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:142 +0x910
  github.com/pingcap/tidb/pkg/sessionctx/variable.parseMemoryLimit()
      pkg/sessionctx/variable/varsutil.go:375 +0x1cf
  github.com/pingcap/tidb/pkg/sessionctx/variable.init.func218()
      pkg/sessionctx/variable/sysvar.go:1155 +0x67
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:143 +0x982
  github.com/pingcap/tidb/pkg/sessionctx/variable.init.func217()
      pkg/sessionctx/variable/sysvar.go:1148 +0x64
  github.com/pingcap/tidb/pkg/sessionctx/variable.(*SysVar).ValidateWithRelaxedValidation()
      pkg/sessionctx/variable/variable.go:377 +0x256
[2024/12/16 07:14:57.984 +00:00] [INFO] [scheduler_manager.go:197] ["schedule task loop start"] [server-id=:4000]
[2024/12/16 07:14:57.985 +00:00] [INFO] [scheduler_manager.go:303] ["subtask table gc loop start"] [server-id=:4000]
[2024/12/16 07:14:57.985 +00:00] [INFO] [scheduler_manager.go:440] ["collect loop start"] [server-id=:4000]
[2024/12/16 07:14:57.985 +00:00] [INFO] [scheduler_manager.go:364] ["cleanup loop start"] [server-id=:4000]
[2024/12/16 07:14:57.989 +00:00] [INFO] [domain.go:606] ["diff load InfoSchema get empty schema diff"] [version=59]
[2024/12/16 07:14:57.989 +00:00] [INFO] [domain.go:353] ["diff load InfoSchema success"] [isV2=true] [currentSchemaVersion=58] [neededSchemaVersion=59] ["elapsed time"=634.2µs] [gotSchemaVersion=58] [phyTblIDs="[]"] [actionTypes="[]"] [diffTypes="[]"]
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:142 +0x910
  github.com/pingcap/tidb/pkg/domain.(*Domain).LoadSysVarCacheLoop()
      pkg/domain/domain.go:1960 +0xa4
  github.com/pingcap/tidb/pkg/session.bootstrapSessionImpl()
      pkg/session/session.go:3537 +0x967
  github.com/pingcap/tidb/pkg/sessionctx/variable.init.func218()
      pkg/sessionctx/variable/sysvar.go:1155 +0x67
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:143 +0x982
  github.com/pingcap/tidb/pkg/sessionctx/variable.init.func217()
      pkg/sessionctx/variable/sysvar.go:1148 +0x64
  github.com/pingcap/tidb/pkg/sessionctx/variable.(*SysVar).ValidateWithRelaxedValidation()
      pkg/sessionctx/variable/variable.go:377 +0x256
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:142 +0x910
  fmt.Sscanf()
      GOROOT/src/fmt/scan.go:114 +0x19a
  github.com/pingcap/tidb/pkg/sessionctx/variable.parseByteSize()
      pkg/sessionctx/variable/varsutil.go:406 +0x1d
  github.com/pingcap/tidb/pkg/sessionctx/variable.init.func261()
      pkg/sessionctx/variable/sysvar.go:1419 +0x51
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCache()
      pkg/domain/sysvar_cache.go:143 +0x982
  github.com/pingcap/tidb/pkg/domain.(*Domain).rebuildSysVarCacheIfNeeded()
      pkg/domain/sysvar_cache.go:50 +0x1e6
  github.com/pingcap/tidb/pkg/domain.(*Domain).GetSessionCache()
      pkg/domain/sysvar_cache.go:61 +0x5b
  github.com/pingcap/tidb/pkg/session.(*session).loadCommonGlobalVariablesIfNeeded()
      pkg/session/session.go:3948 +0x309
  github.com/pingcap/tidb/pkg/session.(*session).ExecuteStmt()
      pkg/session/session.go:2013 +0x196
  github.com/pingcap/tidb/pkg/session.(*session).ExecuteInternal()
      pkg/session/session.go:1524 +0x3f1
  github.com/pingcap/tidb/pkg/domain.(*Domain).LoadPrivilegeLoop()
      pkg/domain/domain.go:1900 +0x117
  github.com/pingcap/tidb/pkg/session.bootstrapSessionImpl()
      pkg/session/session.go:3530 +0x904
  github.com/pingcap/tidb/pkg/session.BootstrapSession()
      pkg/session/session.go:3406 +0x59
  github.com/pingcap/tidb/pkg/testkit.bootstrap()
      pkg/testkit/mockstore.go:251 +0x7b
  github.com/pingcap/tidb/pkg/testkit.CreateMockStoreAndDomain()
      pkg/testkit/mockstore.go:222 +0xd6
  github.com/pingcap/tidb/pkg/testkit.CreateMockStore()
      pkg/testkit/mockstore.go:77 +0x255
  pkg/ddl/tests/indexmerge/indexmerge_test.TestAddIndexDuplicateAndWriteConflict()
      pkg/ddl/tests/indexmerge/merge_test.go:770 +0x64
  testing.tRunner()
      GOROOT/src/testing/testing.go:1690 +0x226
  testing.(*T).Run.gowrap1()
      GOROOT/src/testing/testing.go:1743 +0x44
==================
```

https://do.pingcap.net/jenkins/blue/rest/organizations/jenkins/pipelines/pingcap/pipelines/tidb/pipelines/ghpr_unit_test/runs/24436/nodes/63/steps/69/log/?start=0

### 4. What is your TiDB version? (Required)

<!-- Paste the output of SELECT tidb_version() -->

